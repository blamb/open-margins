<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRU OER Activity Builder</title>
<script>(function(){var t=localStorage.getItem('om-theme')||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');document.documentElement.setAttribute('data-theme',t);})();</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #003865;
    --navy-deep: #002244;
    --navy-mid: #00498a;
    --gold: #F5A623;
    --gold-dark: #d4891a;
    --gold-light: #fdc85a;
    --gold-pale: #fef6e4;
    --cream: #faf8f4;
    --white: #ffffff;
    --ink: #1a1a2e;
    --ink-mid: #2d3748;
    --ink-light: #4a5568;
    --ink-faint: #718096;
    --border: #e2d9c8;
    --border-light: #f0ebe2;
    --success: #276749;
    --success-bg: #f0faf5;
    --error: #9b2335;
    --error-bg: #fff5f6;
    --sidebar-width: 280px;
    --config-width: 340px;
    --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --shadow-sm: 0 1px 3px rgba(0,56,101,0.08), 0 1px 2px rgba(0,56,101,0.04);
    --shadow-md: 0 4px 12px rgba(0,56,101,0.10), 0 2px 4px rgba(0,56,101,0.06);
    --shadow-lg: 0 12px 32px rgba(0,56,101,0.14), 0 4px 8px rgba(0,56,101,0.08);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 15px; scroll-behavior: smooth; }
  /* Focus ring — keyboard users only */
  :focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; border-radius: 3px; }

  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: var(--cream);
    color: var(--ink);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ── TOPBAR ── */
  .topbar {
    background: var(--navy-deep);
    border-bottom: 2px solid var(--gold);
    padding: 0 24px;
    height: 58px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    flex-shrink: 0;
  }

  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .topbar-logo-link {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    text-decoration: none;
  }

  .topbar-logo-img {
    width: 40px;
    height: 40px;
    object-fit: contain;
    filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
    transition: transform var(--transition);
  }
  .topbar-logo-link:hover .topbar-logo-img { transform: scale(1.05); }

  .topbar-logo-fallback {
    width: 36px; height: 36px;
    background: var(--gold); border-radius: 6px;
    align-items: center; justify-content: center;
    font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 13px;
    color: var(--navy-deep); letter-spacing: -0.5px;
    flex-shrink: 0;
  }

  .topbar-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--white);
    letter-spacing: 0.01em;
  }

  .topbar-subtitle {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.45);
    font-weight: 400;
    letter-spacing: 0.04em;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .topbar-badge {
    background: rgba(245,166,35,0.15);
    border: 1px solid rgba(245,166,35,0.35);
    color: var(--gold-light);
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 3px 10px;
    border-radius: 20px;
  }

  .topbar-site-link {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.4);
    text-decoration: none;
    letter-spacing: 0.03em;
    transition: color var(--transition);
  }
  .topbar-site-link:hover { color: var(--gold-light); }

  /* ── STEPS BANNER ── */
  .steps-banner {
    background: var(--navy);
    padding: 10px 24px;
    display: flex;
    align-items: center;
    gap: 0;
    overflow-x: auto;
    flex-shrink: 0;
  }

  .step-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 16px;
    border-radius: 4px;
    cursor: default;
    transition: background var(--transition);
    white-space: nowrap;
  }

  .step-item.active {
    background: rgba(245,166,35,0.15);
  }

  .step-num {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    border: 1.5px solid rgba(255,255,255,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: rgba(255,255,255,0.6);
    flex-shrink: 0;
    transition: all var(--transition);
  }

  .step-item.active .step-num {
    background: var(--gold);
    border-color: var(--gold);
    color: var(--navy-deep);
  }

  .step-item.done .step-num {
    background: rgba(245,166,35,0.3);
    border-color: var(--gold);
    color: var(--gold-light);
  }

  .step-label {
    font-size: 0.78rem;
    font-weight: 500;
    color: rgba(255,255,255,0.5);
    transition: color var(--transition);
  }

  .step-item.active .step-label { color: var(--gold-light); }
  .step-item.done .step-label { color: rgba(255,255,255,0.7); }

  .step-arrow {
    color: rgba(255,255,255,0.2);
    font-size: 0.8rem;
    padding: 0 4px;
  }

  /* ── MAIN LAYOUT ── */
  .app-body {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0; /* lets flex children shrink and scroll correctly */
  }

  /* ── SIDEBAR ── */
  .sidebar {
    width: var(--sidebar-width);
    background: var(--white);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 16px 18px 12px;
    border-bottom: 1px solid var(--border-light);
    flex-shrink: 0;
  }

  .sidebar-label {
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: 8px;
  }

  .search-wrap {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 8px 10px 8px 32px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.83rem;
    color: var(--ink);
    background: var(--cream);
    outline: none;
    transition: border-color var(--transition), box-shadow var(--transition);
  }

  .search-input:focus {
    border-color: var(--navy-mid);
    box-shadow: 0 0 0 3px rgba(0,73,138,0.1);
  }

  .search-input::placeholder { color: var(--ink-faint); }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--ink-faint);
    font-size: 14px;
    pointer-events: none;
  }

  .sidebar-list {
    padding: 8px 0;
  }

  .sidebar-list::-webkit-scrollbar { width: 4px; }
  .sidebar-list::-webkit-scrollbar-track { background: transparent; }
  .sidebar-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .discipline-group { margin-bottom: 2px; }

  .discipline-label {
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-faint);
    padding: 10px 18px 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .discipline-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-light);
  }

  .resource-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 9px 18px;
    cursor: pointer;
    transition: background var(--transition);
    border-left: 3px solid transparent;
    text-align: left;
    width: 100%;
    background: none;
    border-top: none;
    border-right: none;
    border-bottom: none;
    font-family: 'DM Sans', sans-serif;
  }

  .resource-item:hover { background: var(--gold-pale); }

  .resource-item.selected {
    background: var(--gold-pale);
    border-left-color: var(--gold);
  }

  .resource-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--border);
    flex-shrink: 0;
    margin-top: 5px;
    transition: background var(--transition);
  }

  .resource-item.selected .resource-dot,
  .resource-item:hover .resource-dot { background: var(--gold); }

  .resource-name {
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--ink-mid);
    line-height: 1.35;
    transition: color var(--transition);
  }

  .resource-item.selected .resource-name,
  .resource-item:hover .resource-name { color: var(--navy); }

  .resource-demo-badge {
    font-size: 0.58rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gold-dark);
    background: rgba(245,166,35,0.18);
    padding: 1px 5px;
    border-radius: 3px;
    margin-top: 3px;
    display: inline-block;
  }

  /* ── CONFIG PANEL ── */
  .config-panel {
    width: var(--config-width);
    background: var(--white);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .config-header {
    padding: 20px 22px 16px;
    border-bottom: 1px solid var(--border-light);
    flex-shrink: 0;
  }

  .config-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--navy);
    line-height: 1.3;
  }

  .config-header p {
    font-size: 0.78rem;
    color: var(--ink-faint);
    margin-top: 4px;
    line-height: 1.4;
  }

  .config-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 22px;
    display: flex;
    flex-direction: column;
    gap: 22px;
  }

  .config-body::-webkit-scrollbar { width: 4px; }
  .config-body::-webkit-scrollbar-track { background: transparent; }
  .config-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .config-section label,
  .field-label {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--ink-light);
    display: block;
    margin-bottom: 10px;
  }

  /* Activity Type Selector */
  .type-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    max-height: 260px;
    overflow-y: auto;
    padding-right: 2px;
  }

  .type-grid::-webkit-scrollbar { width: 4px; }
  .type-grid::-webkit-scrollbar-track { background: transparent; }
  .type-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .type-card {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 12px 10px;
    cursor: pointer;
    transition: all var(--transition);
    position: relative;
    background: var(--white);
    text-align: left;
    font-family: 'DM Sans', sans-serif;
    width: 100%;
  }

  .type-card:hover {
    border-color: var(--navy-mid);
    box-shadow: var(--shadow-sm);
  }

  .type-card.selected {
    border-color: var(--gold);
    background: var(--gold-pale);
    box-shadow: 0 0 0 3px rgba(245,166,35,0.15);
  }

  .type-card.selected .type-icon { color: var(--gold-dark); }

  .type-icon {
    font-size: 1.2rem;
    margin-bottom: 4px;
    display: block;
    color: var(--navy-mid);
  }

  .type-name {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--ink);
    display: block;
    line-height: 1.25;
  }

  .type-ai-badge {
    font-size: 0.58rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--navy-mid);
    display: block;
    margin-top: 2px;
    opacity: 0.7;
  }

  /* Segmented Controls */
  .segmented {
    display: flex;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    overflow: hidden;
    background: var(--cream);
  }

  .seg-btn {
    flex: 1;
    padding: 9px 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--ink-light);
    background: none;
    border: none;
    cursor: pointer;
    transition: all var(--transition);
    text-align: center;
    border-right: 1px solid var(--border);
  }

  .seg-btn:last-child { border-right: none; }

  .seg-btn:hover:not(.active) { background: rgba(0,56,101,0.04); }

  .seg-btn.active {
    background: var(--navy);
    color: var(--white);
    font-weight: 600;
  }

  /* Objective field */
  .objective-field {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.83rem;
    color: var(--ink);
    background: var(--cream);
    resize: vertical;
    min-height: 72px;
    outline: none;
    transition: border-color var(--transition), box-shadow var(--transition);
    line-height: 1.5;
  }

  .objective-field:focus {
    border-color: var(--navy-mid);
    box-shadow: 0 0 0 3px rgba(0,73,138,0.1);
    background: var(--white);
  }

  .objective-field::placeholder { color: var(--ink-faint); }

  .field-hint {
    font-size: 0.72rem;
    color: var(--ink-faint);
    margin-top: 5px;
    line-height: 1.4;
  }

  /* Generate Button */
  .generate-wrap {
    padding: 16px 22px 20px;
    border-top: 1px solid var(--border-light);
    flex-shrink: 0;
  }

  .btn-generate {
    width: 100%;
    padding: 13px 20px;
    background: var(--navy);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    letter-spacing: 0.01em;
    box-shadow: var(--shadow-sm);
  }

  .btn-generate:hover:not(:disabled) {
    background: var(--navy-mid);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .btn-generate:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
  }

  .btn-generate:disabled {
    opacity: 0.45;
    cursor: not-allowed;
  }

  .btn-generate .btn-icon { font-size: 1rem; }

  .generate-hint {
    font-size: 0.72rem;
    color: var(--ink-faint);
    text-align: center;
    margin-top: 8px;
    font-style: italic;
  }

  /* ── OUTPUT PANEL ── */
  .output-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--cream);
  }

  .output-header {
    padding: 16px 24px;
    background: var(--white);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .output-title {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--navy);
  }

  .output-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-action {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    border: 1.5px solid;
    letter-spacing: 0.01em;
  }

  .btn-action.secondary {
    border-color: var(--border);
    color: var(--ink-mid);
    background: var(--white);
  }

  .btn-action.secondary:hover {
    border-color: var(--navy-mid);
    color: var(--navy);
    background: rgba(0,56,101,0.04);
  }

  .btn-action.primary {
    border-color: var(--gold);
    color: var(--navy-deep);
    background: var(--gold);
  }

  .btn-action.primary:hover {
    background: var(--gold-dark);
    border-color: var(--gold-dark);
    box-shadow: var(--shadow-sm);
  }

  /* Tabs */
  .output-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--white);
    padding: 0 24px;
    flex-shrink: 0;
  }

  .tab-btn {
    padding: 10px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--ink-faint);
    background: none;
    border: none;
    border-bottom: 2.5px solid transparent;
    cursor: pointer;
    transition: all var(--transition);
    margin-bottom: -1px;
    letter-spacing: 0.01em;
  }

  .tab-btn:hover { color: var(--navy); }

  .tab-btn.active {
    color: var(--navy);
    border-bottom-color: var(--gold);
  }

  .output-content {
    flex: 1;
    overflow-y: auto;
    padding: 28px;
  }

  .output-content::-webkit-scrollbar { width: 6px; }
  .output-content::-webkit-scrollbar-track { background: transparent; }
  .output-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── EMPTY STATE ── */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px;
    text-align: center;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.25;
    color: var(--navy);
  }

  .empty-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 10px;
    opacity: 0.5;
  }

  .empty-desc {
    font-size: 0.88rem;
    color: var(--ink-faint);
    max-width: 320px;
    line-height: 1.6;
  }

  .empty-steps {
    display: flex;
    gap: 20px;
    margin-top: 32px;
  }

  .empty-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    max-width: 120px;
    text-align: center;
  }

  .empty-step-num {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0,56,101,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--navy);
    opacity: 0.5;
  }

  .empty-step-text {
    font-size: 0.75rem;
    color: var(--ink-faint);
    line-height: 1.4;
  }

  .empty-connector {
    color: var(--border);
    font-size: 1rem;
    margin-top: 10px;
    align-self: flex-start;
    margin-top: 20px;
  }

  /* ── QUIZ PLAYER ── */
  .quiz-player {
    max-width: 680px;
    margin: 0 auto;
    animation: fadeUp 0.3s ease;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .quiz-card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    overflow: hidden;
  }

  .quiz-intro {
    padding: 32px;
    text-align: center;
    border-bottom: 1px solid var(--border-light);
  }

  .quiz-resource-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--gold-pale);
    border: 1px solid rgba(245,166,35,0.3);
    color: var(--gold-dark);
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 20px;
    margin-bottom: 16px;
  }

  .quiz-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--navy);
    line-height: 1.25;
    margin-bottom: 10px;
  }

  .quiz-meta {
    font-size: 0.82rem;
    color: var(--ink-faint);
  }

  .btn-start {
    margin-top: 22px;
    padding: 12px 32px;
    background: var(--navy);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    box-shadow: var(--shadow-sm);
  }

  .btn-start:hover {
    background: var(--navy-mid);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .quiz-progress-bar-wrap {
    padding: 16px 24px 0;
  }

  .quiz-progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--ink-faint);
    margin-bottom: 6px;
    letter-spacing: 0.04em;
  }

  .quiz-progress-track {
    height: 4px;
    background: var(--border-light);
    border-radius: 2px;
    overflow: hidden;
  }

  .quiz-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--navy-mid), var(--gold));
    border-radius: 2px;
    transition: width 0.4s ease;
  }

  .quiz-question-wrap {
    padding: 24px 24px 16px;
  }

  .question-text {
    font-size: 1.02rem;
    font-weight: 500;
    color: var(--ink);
    line-height: 1.55;
    margin-bottom: 20px;
  }

  .answer-list {
    display: flex;
    flex-direction: column;
    gap: 9px;
    list-style: none;
  }

  .answer-item {
    position: relative;
  }

  .answer-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .answer-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 13px 16px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all var(--transition);
    background: var(--white);
  }

  .answer-label:hover {
    border-color: var(--navy-mid);
    background: rgba(0,56,101,0.03);
  }

  .answer-input:checked + .answer-label {
    border-color: var(--navy);
    background: rgba(0,56,101,0.05);
  }

  .answer-input:focus-visible + .answer-label {
    box-shadow: 0 0 0 3px rgba(0,73,138,0.2);
  }

  .answer-radio {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 1px;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--white);
  }

  .answer-input:checked + .answer-label .answer-radio {
    border-color: var(--navy);
    background: var(--navy);
  }

  .answer-radio::after {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: transparent;
    transition: background var(--transition);
  }

  .answer-input:checked + .answer-label .answer-radio::after {
    background: var(--white);
  }

  .answer-text {
    font-size: 0.9rem;
    color: var(--ink);
    line-height: 1.45;
  }

  /* Feedback states */
  .answer-label.correct {
    border-color: var(--success);
    background: var(--success-bg);
  }

  .answer-label.incorrect {
    border-color: var(--error);
    background: var(--error-bg);
  }

  .answer-label.disabled {
    cursor: default;
    pointer-events: none;
  }

  .answer-label.correct .answer-radio {
    border-color: var(--success);
    background: var(--success);
  }

  .answer-label.incorrect .answer-radio {
    border-color: var(--error);
    background: var(--error);
  }

  .answer-flag {
    margin-left: auto;
    font-size: 1rem;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .feedback-box {
    margin: 0 24px 16px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    line-height: 1.5;
    display: none;
    animation: fadeUp 0.2s ease;
  }

  .feedback-box.correct {
    background: var(--success-bg);
    border: 1px solid rgba(39,103,73,0.2);
    color: var(--success);
  }

  .feedback-box.incorrect {
    background: var(--error-bg);
    border: 1px solid rgba(155,35,53,0.2);
    color: var(--error);
  }

  .feedback-box .feedback-lead {
    font-weight: 700;
    margin-right: 4px;
  }

  .quiz-actions {
    padding: 12px 24px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid var(--border-light);
    margin-top: 8px;
  }

  .btn-check, .btn-next {
    padding: 10px 22px;
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    border: none;
  }

  .btn-check {
    background: var(--gold);
    color: var(--navy-deep);
    box-shadow: var(--shadow-sm);
  }

  .btn-check:hover { background: var(--gold-dark); box-shadow: var(--shadow-md); }
  .btn-check:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-next {
    background: var(--navy);
    color: var(--white);
    box-shadow: var(--shadow-sm);
    display: none;
  }

  .btn-next:hover { background: var(--navy-mid); box-shadow: var(--shadow-md); }

  /* Score screen */
  .score-screen {
    padding: 40px 32px;
    text-align: center;
  }

  .score-ring-wrap {
    position: relative;
    display: inline-block;
    margin-bottom: 24px;
  }

  .score-ring {
    width: 120px;
    height: 120px;
    transform: rotate(-90deg);
  }

  .score-ring-bg { fill: none; stroke: var(--border-light); stroke-width: 10; }
  .score-ring-fill { fill: none; stroke: var(--navy); stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 1s ease; }

  .score-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .score-pct {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--navy);
    line-height: 1;
  }

  .score-pct-label {
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-faint);
  }

  .score-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 8px;
  }

  .score-subtitle {
    font-size: 0.9rem;
    color: var(--ink-faint);
    margin-bottom: 28px;
  }

  .score-breakdown {
    display: flex;
    justify-content: center;
    gap: 28px;
    margin-bottom: 28px;
  }

  .score-stat {
    text-align: center;
  }

  .score-stat-num {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--navy);
  }

  .score-stat-label {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--ink-faint);
  }

  .score-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .btn-retry {
    padding: 11px 24px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    border: 1.5px solid var(--navy);
    color: var(--navy);
    background: transparent;
  }

  .btn-retry:hover { background: rgba(0,56,101,0.06); }

  /* ── JSON VIEW ── */
  .json-view {
    background: var(--navy-deep);
    border-radius: 10px;
    overflow: hidden;
    max-width: 760px;
    margin: 0 auto;
    box-shadow: var(--shadow-lg);
    animation: fadeUp 0.3s ease;
  }

  .json-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 18px;
    background: rgba(255,255,255,0.06);
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  .json-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: rgba(255,255,255,0.5);
    letter-spacing: 0.04em;
  }

  .json-copy-btn {
    padding: 5px 12px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    border: 1px solid rgba(245,166,35,0.4);
    color: var(--gold-light);
    background: rgba(245,166,35,0.08);
  }

  .json-copy-btn:hover {
    background: rgba(245,166,35,0.18);
    border-color: var(--gold);
  }

  .json-body {
    padding: 20px;
    overflow-x: auto;
    max-height: 480px;
    overflow-y: auto;
  }

  .json-body::-webkit-scrollbar { width: 5px; height: 5px; }
  .json-body::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
  .json-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }

  .json-body pre {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    line-height: 1.6;
    color: rgba(255,255,255,0.75);
    white-space: pre;
  }

  .json-key { color: #7ec8e3; }
  .json-string { color: #a8d8b9; }
  .json-bool { color: #f5a623; }
  .json-num { color: #f5a623; }

  /* ── DEMO NOTICE ── */
  .demo-notice {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: rgba(245,166,35,0.08);
    border: 1px solid rgba(245,166,35,0.3);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 20px;
    font-size: 0.8rem;
    color: var(--ink-mid);
    line-height: 1.5;
    max-width: 680px;
    margin-left: auto;
    margin-right: auto;
    animation: fadeUp 0.25s ease;
  }

  .demo-notice-icon { font-size: 1.1rem; flex-shrink: 0; }

  /* ── ABOUT ── */
  .about-footer {
    padding: 10px 24px;
    border-top: 1px solid var(--border-light);
    background: var(--white);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.72rem;
    color: var(--ink-faint);
    flex-shrink: 0;
  }

  .about-link {
    color: var(--navy-mid);
    text-decoration: none;
    font-weight: 500;
  }

  .about-link:hover { text-decoration: underline; }

  /* ── SIDEBAR LOADING / LIVE STATE ── */
  .sidebar-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 32px 18px;
    text-align: center;
    color: var(--ink-faint);
    font-size: 0.8rem;
  }

  .sidebar-loading .spinner {
    width: 24px;
    height: 24px;
    border-width: 2px;
    margin: 0;
  }

  .sidebar-error {
    padding: 14px 18px;
    font-size: 0.78rem;
    color: var(--error);
    line-height: 1.5;
    background: var(--error-bg);
    border-top: 1px solid rgba(155,35,53,0.15);
  }

  .sidebar-mode-bar {
    display: flex;
    border-bottom: 1px solid var(--border-light);
    flex-shrink: 0;
  }

  .sidebar-mode-btn {
    flex: 1;
    padding: 8px 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    color: var(--ink-faint);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all var(--transition);
    text-align: center;
  }

  .sidebar-mode-btn:hover { color: var(--navy); }
  .sidebar-mode-btn.active {
    color: var(--navy);
    border-bottom-color: var(--gold);
    background: var(--gold-pale);
  }

  /* ── SELECTED BOOK CARD (focus mode) ── */
  .selected-book-card {
    margin: 10px 14px;
    padding: 12px 14px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0;
  }

  .selected-book-info {
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .selected-book-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .selected-book-title {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--white);
    line-height: 1.3;
  }

  .selected-book-sub {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.55);
    margin-top: 2px;
  }

  .btn-change-book {
    width: 100%;
    padding: 7px 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    color: rgba(255,255,255,0.85);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition);
    text-align: center;
  }
  .btn-change-book:hover {
    background: rgba(255,255,255,0.18);
    border-color: rgba(255,255,255,0.35);
    color: var(--white);
  }

  /* ── SHOW-ALL FILTER BAR ── */
  .sidebar-filter-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 14px;
    border-bottom: 1px solid var(--border-light);
    background: var(--bg);
    flex-shrink: 0;
    gap: 8px;
  }

  .show-all-label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.7rem;
    color: var(--ink-faint);
    cursor: pointer;
    white-space: nowrap;
  }
  .show-all-label input[type="checkbox"] {
    accent-color: var(--navy);
    width: 12px;
    height: 12px;
    cursor: pointer;
  }
  .show-all-label:hover { color: var(--navy); }

  .book-count-badge {
    font-size: 0.65rem;
    color: var(--ink-faint);
    white-space: nowrap;
  }

  /* ── OFFICIAL BADGE ── */
  .official-badge {
    display: inline-block;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    color: var(--gold);
    background: transparent;
    border: 1px solid var(--gold);
    border-radius: 3px;
    padding: 0 4px;
    vertical-align: middle;
    margin-left: 4px;
    line-height: 1.5;
    text-transform: uppercase;
  }

  /* ── CHAPTER SELECTOR ── */
  .chapter-select-wrap {
    padding: 14px 22px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-shrink: 0;
  }

  .chapter-select {
    width: 100%;
    padding: 8px 10px;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    color: var(--ink);
    background: var(--cream);
    outline: none;
    cursor: pointer;
    transition: border-color var(--transition), box-shadow var(--transition);
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }

  .chapter-select:focus {
    border-color: var(--navy-mid);
    box-shadow: 0 0 0 3px rgba(0,73,138,0.1);
  }

  .chapter-select:disabled { opacity: 0.5; cursor: not-allowed; }

  .chapter-meta {
    font-size: 0.72rem;
    color: var(--ink-faint);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chapter-meta-words {
    background: var(--border-light);
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 600;
  }

  .btn-load-chapter {
    width: 100%;
    padding: 9px 14px;
    background: var(--navy);
    color: var(--white);
    border: none;
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .btn-load-chapter:hover:not(:disabled) { background: var(--navy-mid); }
  .btn-load-chapter:disabled { opacity: 0.45; cursor: not-allowed; }

  .chapter-loaded-notice {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    background: rgba(39,103,73,0.07);
    border: 1px solid rgba(39,103,73,0.2);
    border-radius: 7px;
    padding: 10px 12px;
    font-size: 0.78rem;
    color: var(--success);
    line-height: 1.45;
  }

  /* ── API SETTINGS ── */
  .api-section {
    background: rgba(0,56,101,0.04);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .api-section-label {
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--navy-mid);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .api-status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--border);
    flex-shrink: 0;
    transition: background 0.3s;
  }

  .api-status-dot.connected { background: var(--success); }
  .api-status-dot.error { background: var(--error); }

  .api-input {
    width: 100%;
    padding: 8px 10px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--ink);
    background: var(--white);
    outline: none;
    transition: border-color var(--transition), box-shadow var(--transition);
  }

  .api-input:focus {
    border-color: var(--navy-mid);
    box-shadow: 0 0 0 3px rgba(0,73,138,0.1);
  }

  .api-input::placeholder { color: var(--ink-faint); font-family: 'DM Sans', sans-serif; }

  .api-row {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .api-row .api-input { flex: 1; }

  .btn-test {
    padding: 7px 12px;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    border: 1.5px solid var(--border);
    color: var(--ink-mid);
    background: var(--white);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .btn-test:hover { border-color: var(--navy-mid); color: var(--navy); }
  .btn-test:disabled { opacity: 0.5; cursor: not-allowed; }

  .api-status-msg {
    font-size: 0.72rem;
    color: var(--ink-faint);
    line-height: 1.4;
  }

  .api-status-msg.ok { color: var(--success); }
  .api-status-msg.err { color: var(--error); }

  /* ── OER CONTENT INPUT ── */
  .oer-content-field {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.83rem;
    color: var(--ink);
    background: var(--cream);
    resize: vertical;
    min-height: 120px;
    outline: none;
    transition: border-color var(--transition), box-shadow var(--transition);
    line-height: 1.55;
  }

  .oer-content-field:focus {
    border-color: var(--navy-mid);
    box-shadow: 0 0 0 3px rgba(0,73,138,0.1);
    background: var(--white);
  }

  .oer-content-field::placeholder { color: var(--ink-faint); }

  .content-source-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
  }

  .source-chip {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    border: 1.5px solid var(--border);
    color: var(--ink-faint);
    background: var(--white);
    transition: all var(--transition);
    letter-spacing: 0.02em;
    font-family: 'DM Sans', sans-serif;
  }

  .source-chip.active {
    border-color: var(--navy);
    color: var(--navy);
    background: rgba(0,56,101,0.06);
  }

  .source-chip:hover:not(.active) { border-color: var(--border); color: var(--ink-mid); }

  /* ── LOADING STATE ── */
  .generating-overlay {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 16px;
    padding: 40px;
    text-align: center;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-light);
    border-top-color: var(--navy);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .generating-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--navy);
    opacity: 0.7;
  }

  .generating-sub {
    font-size: 0.82rem;
    color: var(--ink-faint);
    max-width: 280px;
    line-height: 1.5;
  }

  /* ── TRUE/FALSE BUTTONS ── */
  .tf-buttons {
    display: flex;
    gap: 14px;
    margin-top: 24px;
    justify-content: center;
  }
  .tf-btn {
    flex: 1;
    max-width: 160px;
    padding: 14px 20px;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all var(--transition);
  }
  .true-btn { background: var(--success-bg); color: var(--success); border-color: rgba(39,103,73,0.3); }
  .true-btn:not(:disabled):hover { background: #c6f0de; border-color: var(--success); }
  .false-btn { background: var(--error-bg); color: var(--error); border-color: rgba(155,35,53,0.3); }
  .false-btn:not(:disabled):hover { background: #ffe0e4; border-color: var(--error); }
  .tf-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* ── FLASHCARDS ── */
  .fc-wrap { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 16px; }
  .fc-counter { font-size: 0.72rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--ink-faint); }
  .fc-card {
    width: 100%;
    max-width: 480px;
    height: 220px;
    perspective: 1000px;
    cursor: pointer;
    position: relative;
  }
  .fc-front, .fc-back {
    position: absolute; inset: 0;
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: 16px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 24px;
    backface-visibility: hidden;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-md);
  }
  .fc-back { background: var(--navy); border-color: var(--navy); transform: rotateY(180deg); }
  .fc-card.flipped .fc-front { transform: rotateY(-180deg); }
  .fc-card.flipped .fc-back { transform: rotateY(0deg); }
  .fc-side-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.4; margin-bottom: 10px; color: var(--navy); }
  .fc-back .fc-side-label { color: rgba(255,255,255,0.5); }
  .fc-text { font-size: 1rem; font-weight: 500; text-align: center; line-height: 1.5; color: var(--ink); }
  .fc-back .fc-text { color: var(--white); font-size: 0.92rem; }
  .fc-flip-hint { font-size: 0.68rem; color: var(--ink-faint); margin-top: 12px; }
  .fc-dot-wrap { display: flex; gap: 5px; align-items: center; }
  .fc-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: background var(--transition); }
  .fc-dot.active { background: var(--navy); }
  .fc-nav { display: flex; align-items: center; gap: 16px; width: 100%; max-width: 480px; justify-content: space-between; }
  .btn-fc-nav { background: var(--white); border: 1.5px solid var(--border); border-radius: 7px; padding: 8px 16px; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600; color: var(--navy); cursor: pointer; transition: all var(--transition); }
  .btn-fc-nav:not(:disabled):hover { border-color: var(--navy); background: var(--cream); }
  .btn-fc-nav:disabled { opacity: 0.3; cursor: not-allowed; }

  /* ── FILL IN THE BLANKS ── */
  .fib-wrap { padding: 20px 24px; }
  .fib-instructions { font-size: 0.82rem; color: var(--ink-faint); margin-bottom: 20px; font-style: italic; }
  .fib-items { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
  .fib-item { display: flex; flex-wrap: wrap; align-items: baseline; gap: 4px 6px; font-size: 0.93rem; line-height: 1.6; color: var(--ink-mid); border-left: 3px solid var(--border-light); padding-left: 12px; }
  .fib-num { font-size: 0.65rem; font-weight: 700; color: var(--ink-faint); letter-spacing: 0.05em; margin-right: 4px; flex-shrink: 0; min-width: 18px; }
  .fib-sentence { flex: 1; display: flex; flex-wrap: wrap; align-items: baseline; gap: 2px 4px; }
  .fib-input {
    display: inline-block;
    min-width: 80px;
    border: none;
    border-bottom: 2px solid var(--navy-mid);
    background: transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.93rem;
    color: var(--navy);
    font-weight: 600;
    padding: 0 4px 2px;
    text-align: center;
    outline: none;
    transition: border-color var(--transition);
  }
  .fib-input:focus { border-bottom-color: var(--gold); background: var(--gold-pale); border-radius: 3px 3px 0 0; }
  .fib-hint { font-size: 0.72rem; color: var(--ink-faint); font-style: italic; width: 100%; margin-top: 2px; padding-left: 22px; }
  .fib-result { font-size: 0.8rem; font-weight: 600; margin-left: 4px; }
  .fib-actions { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
  .fib-score { font-size: 1rem; padding: 12px 16px; background: var(--cream); border-radius: 8px; text-align: center; }

  /* ── MATCHING ── */
  .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
  .match-col { display: flex; flex-direction: column; gap: 8px; }
  .match-item {
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--white);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.83rem;
    color: var(--ink-mid);
    cursor: pointer;
    text-align: left;
    transition: all var(--transition);
    line-height: 1.4;
  }
  .match-item:hover:not(:disabled) { border-color: var(--navy-mid); background: var(--gold-pale); }
  .match-item.match-selected { border-color: var(--gold); background: var(--gold-pale); box-shadow: 0 0 0 3px rgba(245,166,35,0.2); }
  .match-item.match-correct { border-color: var(--success); background: var(--success-bg); color: var(--success); cursor: default; }
  .match-item.match-wrong { border-color: var(--error); background: var(--error-bg); animation: shake 0.4s ease; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
  .match-score { padding: 12px 0; font-size: 0.95rem; }

  /* ── ORDERING ── */
  .ord-list { display: flex; flex-direction: column; gap: 8px; }
  .ord-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--white);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    color: var(--ink-mid);
    cursor: grab;
    transition: all var(--transition);
    user-select: none;
  }
  .ord-item:hover { border-color: var(--navy-mid); background: var(--gold-pale); }
  .ord-item.match-correct { border-color: var(--success); background: var(--success-bg); color: var(--success); }
  .ord-item.match-wrong { border-color: var(--error); background: var(--error-bg); }
  .ord-handle { color: var(--ink-faint); font-size: 1rem; cursor: grab; flex-shrink: 0; }

  /* ── BRANCHING SCENARIO ── */
  .scenario-box {
    background: rgba(0,56,101,0.05);
    border-left: 3px solid var(--navy-mid);
    padding: 14px 16px;
    border-radius: 0 8px 8px 0;
    margin: 16px 0 20px;
    font-size: 0.9rem;
    line-height: 1.65;
    color: var(--ink-mid);
  }
  .scenario-box strong {
    display: block;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: 6px;
  }
  .decision-options { display: flex; flex-direction: column; gap: 10px; }
  .btn-decision {
    display: block;
    width: 100%;
    padding: 12px 16px;
    background: var(--white);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.87rem;
    color: var(--ink-mid);
    cursor: pointer;
    text-align: left;
    line-height: 1.45;
    transition: all var(--transition);
    position: relative;
  }
  .btn-decision::before {
    content: attr(data-letter);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: rgba(0,56,101,0.08);
    color: var(--navy);
    font-size: 0.72rem;
    font-weight: 700;
    margin-right: 10px;
    flex-shrink: 0;
    vertical-align: middle;
  }
  .btn-decision:hover:not(:disabled) {
    border-color: var(--navy-mid);
    background: var(--gold-pale);
    transform: translateX(2px);
  }
  .btn-decision:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
  .btn-decision.chosen { border-color: var(--gold); background: var(--gold-pale); }
  .branch-feedback {
    margin-top: 14px;
    padding: 13px 15px;
    background: rgba(39,103,73,0.07);
    border: 1px solid rgba(39,103,73,0.25);
    border-radius: 8px;
    font-size: 0.85rem;
    line-height: 1.55;
    color: var(--ink-mid);
  }
  .branch-feedback strong {
    display: block;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    color: var(--success);
    margin-bottom: 5px;
  }
  .branch-terminal {
    padding: 28px;
    text-align: center;
  }
  .branch-terminal-icon { font-size: 2rem; margin-bottom: 12px; opacity: 0.6; }
  .branch-path-summary {
    margin: 18px 0;
    padding: 14px 16px;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 8px;
    text-align: left;
    font-size: 0.82rem;
    line-height: 1.6;
    color: var(--ink-light);
  }
  .branch-path-summary h4 {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: 8px;
  }
  .branch-path-step {
    display: flex;
    gap: 8px;
    padding: 4px 0;
    border-bottom: 1px solid var(--border-light);
  }
  .branch-path-step:last-child { border-bottom: none; }
  .branch-path-num {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--navy-mid);
    flex-shrink: 0;
    min-width: 18px;
    padding-top: 1px;
  }

  /* ── TREE MAP ── */
  .branch-map-wrap {
    padding: 28px;
    overflow-x: auto;
  }
  .branch-map-title {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 6px;
  }
  .branch-map-hint {
    font-size: 0.75rem;
    color: var(--ink-faint);
    margin-bottom: 20px;
    font-style: italic;
  }
  .branch-map-svg-wrap {
    overflow-x: auto;
    overflow-y: auto;
    max-height: calc(100vh - 260px);
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--cream);
    padding: 16px;
  }
  .branch-map-svg-wrap svg { display: block; }
  /* SVG node styles via inline styles in JS for flexibility */
  .branch-detail-panel {
    margin-top: 18px;
    padding: 16px 18px;
    background: var(--white);
    border: 1.5px solid var(--border);
    border-radius: 10px;
  }
  .branch-detail-panel h4 {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    color: var(--ink-faint);
    margin-bottom: 8px;
  }
  .branch-detail-scenario {
    font-size: 0.87rem;
    line-height: 1.6;
    color: var(--ink-mid);
    margin-bottom: 10px;
  }
  .branch-detail-decisions { display: flex; flex-direction: column; gap: 6px; }
  .branch-detail-decision {
    font-size: 0.8rem;
    color: var(--ink-light);
    padding: 5px 10px;
    background: var(--cream);
    border-radius: 5px;
    border-left: 3px solid var(--gold);
  }

  /* ── COMPANION SEED BANNER ── */
  .companion-seed-banner {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 10px 14px; margin-bottom: 12px;
    background: linear-gradient(135deg, rgba(0,73,138,0.07) 0%, rgba(0,107,100,0.07) 100%);
    border: 1px solid rgba(0,107,100,0.22); border-radius: 8px;
    font-size: 0.78rem; color: var(--ink-mid);
  }
  .companion-seed-banner-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 1px; }
  .companion-seed-banner-body { flex: 1; min-width: 0; }
  .companion-seed-banner-title {
    font-weight: 700; font-size: 0.8rem;
    color: var(--navy-mid); margin-bottom: 2px;
    display: flex; align-items: center; gap: 6px;
  }
  .companion-seed-banner-tag {
    font-size: 0.6rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    background: rgba(0,107,100,0.12); color: #006b64; border-radius: 4px; padding: 1px 5px;
  }
  .companion-seed-banner-meta { color: var(--ink-faint); margin-top: 1px; }
  .companion-seed-banner-dismiss {
    font-size: 0.72rem; padding: 3px 8px;
    background: transparent; border: 1px solid var(--border);
    border-radius: 5px; color: var(--ink-faint);
    cursor: pointer; flex-shrink: 0;
    transition: all 0.15s;
  }
  .companion-seed-banner-dismiss:hover { background: var(--cream-mid); color: var(--ink); }

  /* ── UTILITY ── */
  .hidden { display: none !important; }

  .no-results {
    padding: 20px 18px;
    text-align: center;
    font-size: 0.82rem;
    color: var(--ink-faint);
    font-style: italic;
  }

/* ── SUITE NAV ── */
.suite-nav {
  background: var(--navy-deep);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding: 0 24px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  position: sticky;
  top: 58px; /* sits below the 58px topbar */
  z-index: 99;
  flex-shrink: 0;
}
.suite-nav-home {
  font-size: 0.63rem;
  font-weight: 600;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: #c8d8e8;
  text-decoration: none;
  transition: color 0.18s;
  flex-shrink: 0;
}
.suite-nav-home:hover { color: #fff; }
.suite-nav-tools { display: flex; align-items: center; gap: 4px; }
.suite-nav-pill {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.63rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  text-decoration: none;
  border: 1px solid transparent;
  transition: all 0.18s;
  white-space: nowrap;
}
/* inactive pills — solid legible text (≥4.5:1 on dark navy ~#001833) */
.suite-nav-pill.pill-companion { color: #f5c06a; border-color: rgba(245,192,106,0.4); }
.suite-nav-pill.pill-companion:hover { background: rgba(245,192,106,0.12); border-color: rgba(245,192,106,0.6); color: #fdd28a; }
.suite-nav-pill.pill-builder   { color: #c8d8e8; border-color: rgba(200,216,232,0.35); }
.suite-nav-pill.pill-builder:hover   { background: rgba(200,216,232,0.1); border-color: rgba(200,216,232,0.55); color: #fff; }
.suite-nav-pill.pill-nova      { color: #f5c06a; border-color: rgba(245,192,106,0.4); }
.suite-nav-pill.pill-nova:hover      { background: rgba(245,192,106,0.12); border-color: rgba(245,192,106,0.6); color: #fdd28a; }
.suite-nav-pill.pill-rhizo     { color: #8fd48c; border-color: rgba(143,212,140,0.4); }
.suite-nav-pill.pill-rhizo:hover     { background: rgba(143,212,140,0.1); border-color: rgba(143,212,140,0.6); color: #aee8ab; }
.suite-nav-pill.pill-sylva     { color: #a8e6c8; border-color: rgba(168,230,200,0.35); }
.suite-nav-pill.pill-sylva:hover     { background: rgba(168,230,200,0.1); border-color: rgba(168,230,200,0.55); color: #c0f0d8; }
.suite-nav-pill.pill-sylva.pill-active { background: rgba(168,230,200,0.12); border-color: rgba(168,230,200,0.45); color: #a8e6c8; font-weight: 700; }
.suite-nav-pill.pill-active { cursor: default; pointer-events: none; }
.suite-nav-pill.pill-builder.pill-active { background: rgba(200,216,232,0.15); border-color: rgba(200,216,232,0.5); color: #fff; font-weight: 700; }

/* ── Source tray (multi-source chips) ── */
.source-tray {
  display: flex; flex-wrap: wrap; gap: 6px;
  margin-top: 10px; margin-bottom: 2px;
}
.source-chip-item {
  display: flex; align-items: center; gap: 5px;
  background: rgba(0,56,101,0.06);
  border: 1px solid rgba(0,56,101,0.18);
  border-radius: 20px;
  padding: 4px 8px 4px 10px;
  font-size: 0.73rem; color: var(--navy);
  font-family: 'DM Sans', sans-serif;
  max-width: 100%; animation: chipIn 0.15s ease;
}
@keyframes chipIn { from { opacity:0; transform:scale(0.85); } to { opacity:1; transform:scale(1); } }
.source-chip-icon { font-size: 0.85em; }
.source-chip-body { display:flex; flex-direction:column; gap:1px; min-width:0; }
.source-chip-label { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }
.source-chip-meta { color: #718096; font-size:0.68rem; white-space:nowrap; }
.source-chip-remove {
  margin-left: 2px; padding: 0 2px;
  background: none; border: none; cursor: pointer;
  color: rgba(0,56,101,0.35); font-size: 1rem; line-height:1;
  transition: color 0.15s;
}
.source-chip-remove:hover { color: var(--error, #c0392b); }

/* ── URL fetch row ── */
.url-fetch-row {
  display: flex; gap: 6px; margin-top: 10px; align-items: center;
}
.url-fetch-input {
  flex: 1; padding: 7px 10px;
  background: #fff; border: 1.5px solid #d0d9e4;
  border-radius: 7px; color: #1a2533;
  font-family: 'DM Mono', monospace; font-size: 0.72rem;
  outline: none; transition: border-color 0.18s;
}
.url-fetch-input:focus { border-color: var(--navy-mid); }
.url-fetch-input::placeholder { color: #a0aec0; }
.btn-fetch-url {
  padding: 7px 11px; white-space: nowrap;
  background: var(--navy); border: none;
  border-radius: 7px; color: #fff;
  font-family: 'DM Sans', sans-serif; font-size: 0.75rem; font-weight: 600;
  cursor: pointer; transition: background 0.18s;
}
.btn-fetch-url:hover { background: var(--navy-mid); }
.btn-fetch-url:disabled { opacity: 0.45; cursor: not-allowed; }
.url-fetch-status {
  font-size: 0.7rem; color: #718096;
  margin-top: 4px; min-height: 1em;
}
.url-fetch-status.error { color: var(--error, #c0392b); }
.url-fetch-status.success { color: var(--success, #2d7d46); }

/* ── File upload button ── */
.file-upload-btn {
  width: 100%; margin-top: 8px; padding: 8px 14px;
  background: rgba(0,56,101,0.04);
  border: 1.5px dashed rgba(0,56,101,0.25);
  border-radius: 8px; color: var(--navy-mid);
  font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 600;
  cursor: pointer; transition: all 0.18s; text-align: center;
}
.file-upload-btn:hover { background: rgba(0,56,101,0.08); border-style: solid; }
.file-upload-status {
  font-size: 0.7rem; color: #718096;
  margin-top: 4px; min-height: 1em;
}
.file-upload-status.error { color: var(--error, #c0392b); }
.file-upload-status.success { color: var(--success, #2d7d46); }
#file-upload-input-ab { display: none; }

/* ── Source section separator label ── */
.oer-source-sep {
  font-size: 0.65rem; font-weight: 700; letter-spacing: 0.07em;
  text-transform: uppercase; color: #a0aec0;
  margin-top: 12px; margin-bottom: 2px; padding-bottom: 4px;
  border-bottom: 1px solid #e8eef4;
}

/* ── Sidebar scroll area — wraps book list + chapter selector ── */
.sidebar-scroll-area {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}
.sidebar-scroll-area::-webkit-scrollbar { width: 4px; }
.sidebar-scroll-area::-webkit-scrollbar-track { background: transparent; }
.sidebar-scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ── Sidebar source section — pinned footer of the sidebar ── */
.sidebar-source-section {
  padding: 8px 14px 10px;
  border-top: 2px solid var(--border-light);
  background: var(--cream);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}
.sidebar-source-section .source-tray { margin-top: 0; margin-bottom: 0; }
.sidebar-source-section .oer-source-sep { font-size: 0.6rem; margin-top: 8px; margin-bottom: 1px; padding-bottom: 3px; }
.sidebar-source-section .oer-source-sep:first-of-type { margin-top: 0; }
.sidebar-source-section .url-fetch-row { margin-top: 5px; }
.sidebar-source-section .url-fetch-input { padding: 5px 8px; font-size: 0.69rem; }
.sidebar-source-section .btn-fetch-url { padding: 5px 9px; font-size: 0.71rem; }
.sidebar-source-section .file-upload-btn { padding: 6px 10px; font-size: 0.72rem; margin-top: 4px; }
.sidebar-source-section .url-fetch-status,
.sidebar-source-section .file-upload-status { font-size: 0.65rem; min-height: 0.9em; }

/* ══════════════════════════════════════════════════════════
   RESPONSIVE — TABLET & MOBILE
   ══════════════════════════════════════════════════════════ */

@media (max-width: 1100px) {
  :root {
    --sidebar-width: 240px;
    --config-width: 280px;
  }
  .suite-nav-pill { padding: 3px 8px; font-size: 0.65rem; }
}

@media (max-width: 768px) {
  :root {
    --sidebar-width: 100%;
    --config-width: 100%;
  }

  .suite-nav-tools { display: none; }

  /* Stack all three panels vertically: output fills screen, sidebars are drawers */
  .app-body {
    flex-direction: column;
    position: relative;
  }

  /* Library sidebar — left drawer */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 85vw !important;
    max-width: 340px;
    z-index: 200;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    border-right: 1px solid var(--border);
    overflow-y: auto;
  }
  .sidebar.mobile-open { transform: translateX(0); }

  /* Config panel — right drawer */
  .config-panel {
    position: fixed;
    right: 0; top: 0; bottom: 0;
    width: 85vw !important;
    max-width: 360px;
    z-index: 200;
    border-right: none;
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    overflow-y: auto;
  }
  .config-panel.mobile-open { transform: translateX(0); }

  /* Output fills full width */
  .output-panel {
    flex: 1;
    width: 100%;
    height: 100%;
  }

  /* Steps banner — compact */
  .steps-banner { padding: 8px 12px; gap: 0; }
  .step-label { display: none; }
  .step-num { width: 22px; height: 22px; font-size: 0.72rem; }

  /* Mobile toolbar */
  .mobile-toolbar {
    display: flex !important;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 52px;
    background: var(--navy-deep);
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 300;
    align-items: stretch;
  }
  .mobile-toolbar-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    background: none;
    border: none;
    border-right: 1px solid rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.5);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.58rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    cursor: pointer;
    padding: 0;
  }
  .mobile-toolbar-btn:last-child { border-right: none; }
  .mobile-toolbar-btn .tb-icon { font-size: 1.1rem; }
  .mobile-toolbar-btn.active { color: var(--gold); }
  .mobile-toolbar-btn:hover { color: #fff; }

  /* Backdrop */
  .mobile-backdrop {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 199;
  }
  .mobile-backdrop.visible { display: block; }

  /* Push output content above toolbar */
  .output-panel { padding-bottom: 52px; }
  .output-content { padding-bottom: 52px; }

  /* Topbar compact */
  .topbar { padding: 0 12px; }
  .topbar-title { font-size: 0.85rem; }
}

/* ── Dark theme override ── */
[data-theme="dark"] {
  --navy:        #4a9ad4;
  --navy-deep:   #2a7ab8;
  --navy-mid:    #6ab0e0;
  --gold:        #f5a623;
  --gold-dark:   #d4891a;
  --gold-light:  #fdc85a;
  --gold-pale:   rgba(245,166,35,0.08);
  --cream:       #0e1520;
  --white:       #1a2535;
  --ink:         #d8e8f8;
  --ink-mid:     #b8ccdc;
  --ink-light:   #8aa8c0;
  --ink-faint:   #7898b0;
  --border:      rgba(255,255,255,0.09);
  --border-light:rgba(255,255,255,0.05);
  --success:     #4aaa72;
  --success-bg:  rgba(74,170,114,0.10);
  --error:       #e05a6a;
  --error-bg:    rgba(224,90,106,0.10);
}

/* ── Suite theme toggle button ── */
.btn-suite-theme {
  background: transparent;
  border: 1px solid rgba(128,128,128,0.25);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 0.82rem;
  cursor: pointer;
  color: inherit;
  opacity: 0.65;
  transition: opacity 0.2s, background 0.2s;
  line-height: 1;
  flex-shrink: 0;
}
.btn-suite-theme:hover { opacity: 1; background: rgba(128,128,128,0.12); }

</style>
<!-- PDF.js for client-side PDF text extraction -->
<script type="module">
  import * as pdfjs from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs';
  pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs';
  window.pdfjsLib = pdfjs;
</script>
<!-- mammoth.js for client-side .docx text extraction -->
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.8.0/mammoth.browser.min.js"></script>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar" role="banner">
  <div class="topbar-brand">
    <a href="https://openpress.trubox.ca" target="_blank" rel="noopener" class="topbar-logo-link" aria-label="TRU Open Press homepage">
      <img src="https://openpress.trubox.ca/wp-content/uploads/sites/2142/2023/10/cropped-openpress_logo_colour-1.png"
           alt="TRU Open Press" class="topbar-logo-img" width="36" height="36"
           onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
      <div class="topbar-logo-fallback" aria-hidden="true" style="display:none">OP</div>
    </a>
    <div>
      <div class="topbar-title">OER Activity Builder</div>
      <div class="topbar-subtitle">TRU Open Press · AI-Powered Learning Activities</div>
    </div>
  </div>
  <div class="topbar-right">
    <span class="topbar-badge">Proof of Concept</span>
    <a href="https://openpress.trubox.ca" target="_blank" rel="noopener" class="topbar-site-link">openpress.trubox.ca ↗</a>
  </div>
</header>

<!-- SUITE NAV -->
<nav class="suite-nav" aria-label="Open Margins suite">
  <a href="index.html" class="suite-nav-home">← Open Margins</a>
  <div class="suite-nav-tools">
    <a href="companion/companion.html" class="suite-nav-pill pill-companion">✦ Companion</a>
    <span class="suite-nav-pill pill-builder pill-active" aria-current="page">⬡ Activity Builder</span>
    <a href="nova/nova.html" class="suite-nav-pill pill-nova">✺ Nova</a>
    <a href="rhizo/rhizo.html" class="suite-nav-pill pill-rhizo">∿ Rhizo</a>
    <a href="sylva/sylva.html" class="suite-nav-pill pill-sylva">⟡ Sylva</a>
  </div>
  <button class="btn-suite-theme" id="btn-suite-theme" aria-label="Toggle theme" title="Toggle theme">🌙</button>
</nav>

<!-- STEPS BANNER -->
<nav class="steps-banner" aria-label="Workflow steps">
  <div class="step-item active" id="step1-indicator">
    <span class="step-num" aria-hidden="true">1</span>
    <span class="step-label">Select Resource</span>
  </div>
  <span class="step-arrow" aria-hidden="true">›</span>
  <div class="step-item" id="step2-indicator">
    <span class="step-num" aria-hidden="true">2</span>
    <span class="step-label">Configure Activity</span>
  </div>
  <span class="step-arrow" aria-hidden="true">›</span>
  <div class="step-item" id="step3-indicator">
    <span class="step-num" aria-hidden="true">3</span>
    <span class="step-label">Preview &amp; Export</span>
  </div>
</nav>

<!-- MAIN -->
<div class="app-body" role="main">

  <!-- SIDEBAR: Resource List -->
  <aside class="sidebar" aria-label="OER Resource Library">
    <div class="sidebar-header" id="sidebar-header-search">
      <div class="sidebar-label">OER Library</div>
      <div class="search-wrap">
        <span class="search-icon" aria-hidden="true">⌕</span>
        <input
          type="search"
          class="search-input"
          id="resource-search"
          placeholder="Filter resources…"
          aria-label="Search resources"
          autocomplete="off"
        >
      </div>
    </div>
    <!-- Mode toggle: live Pressbooks vs. static list -->
    <div class="sidebar-mode-bar" id="sidebar-mode-bar" role="group" aria-label="Library source">
      <button type="button" class="sidebar-mode-btn active" id="mode-live" aria-pressed="true">Live (Pressbooks)</button>
      <button type="button" class="sidebar-mode-btn" id="mode-static" aria-pressed="false">Static list</button>
    </div>
    <!-- Show-all toggle (live mode only) -->
    <div class="sidebar-filter-bar" id="sidebar-filter-bar">
      <label class="show-all-label">
        <input type="checkbox" id="show-all-books"> Show all books
      </label>
      <span class="book-count-badge" id="book-count-badge"></span>
    </div>
    <!-- Selected book summary (shown in focus mode) -->
    <div class="selected-book-card hidden" id="selected-book-card">
      <div class="selected-book-info">
        <span class="selected-book-icon" aria-hidden="true">📖</span>
        <div>
          <div class="selected-book-title" id="selected-book-title-card"></div>
          <div class="selected-book-sub" id="selected-book-sub-card"></div>
        </div>
      </div>
      <button type="button" class="btn-change-book" id="change-book-btn">Change book</button>
    </div>
    <!-- Scrollable area: book list + chapter selector only -->
    <div class="sidebar-scroll-area">
      <div class="sidebar-list" id="resource-list" role="listbox" aria-label="Available OER resources">
        <!-- Populated by JS -->
      </div>
      <!-- Chapter selector (shown when a live book is selected) -->
      <div class="chapter-select-wrap hidden" id="chapter-select-wrap">
        <label class="field-label" for="part-select" style="margin-bottom:4px;">Part / Unit</label>
        <select class="chapter-select" id="part-select" aria-label="Select part">
          <option value="">— Select a part —</option>
        </select>
        <label class="field-label" for="chapter-select" style="margin-top:6px;margin-bottom:4px;">Chapter</label>
        <select class="chapter-select" id="chapter-select" aria-label="Select chapter" disabled>
          <option value="">— Select a chapter —</option>
        </select>
        <div class="chapter-meta" id="chapter-meta" style="display:none">
          <span id="chapter-meta-words" class="chapter-meta-words"></span>
          <a id="chapter-meta-link" href="#" target="_blank" rel="noopener" style="color:var(--navy-mid);font-size:0.72rem;font-weight:500;">View in Pressbooks ↗</a>
        </div>
        <button type="button" class="btn-load-chapter hidden" id="load-chapter-btn">
          <span aria-hidden="true">+</span> Add chapter to sources
        </button>
        <div class="chapter-loaded-notice hidden" id="chapter-loaded-notice" aria-live="polite">
          <span aria-hidden="true">✓</span>
          <span id="chapter-loaded-text">Chapter loaded. Click Generate Activity below.</span>
        </div>
      </div>
    </div><!-- /.sidebar-scroll-area -->

    <!-- Source tray, URL fetch, and file upload — pinned to bottom of sidebar -->
    <div class="sidebar-source-section" id="sidebar-source-section">
      <!-- Loaded source chips -->
      <div id="source-tray-ab" class="source-tray"></div>

      <!-- URL fetch -->
      <div class="oer-source-sep">Fetch from URL</div>
      <div class="url-fetch-row">
        <input type="url" class="url-fetch-input" id="url-fetch-input-ab"
               placeholder="https://example.com/article"
               aria-label="URL to fetch text from">
        <button class="btn-fetch-url" id="btn-fetch-url-ab" type="button">Fetch</button>
      </div>
      <div class="url-fetch-status" id="url-fetch-status-ab"></div>

      <!-- File upload -->
      <div class="oer-source-sep">Upload PDF or Word doc</div>
      <button class="file-upload-btn" id="btn-file-upload-ab" type="button">
        ↑ Upload PDF or .docx file
      </button>
      <div class="file-upload-status" id="file-upload-status-ab"></div>
      <input type="file" id="file-upload-input-ab" accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
    </div>
  </aside>

  <!-- CONFIG PANEL -->
  <section class="config-panel" aria-label="Activity Configuration">
    <div class="config-header">
      <h2 id="config-resource-title">Configure Your Activity</h2>
      <p id="config-resource-sub">Select a resource from the library to begin.</p>
    </div>
    <div class="config-body">

      <!-- Activity Type -->
      <div class="config-section">
        <label class="field-label">Activity Type</label>
        <div class="type-grid" role="radiogroup" aria-label="Activity type">
          <button class="type-card selected" data-type="quiz" role="radio" aria-checked="true" tabindex="0">
            <span class="type-icon" aria-hidden="true">✦</span>
            <span class="type-name">Quiz / Question Set</span>
          </button>
          <button class="type-card" data-type="truefalse" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">⊙</span>
            <span class="type-name">True / False</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="flashcards" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">⧉</span>
            <span class="type-name">Flashcards</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="fillblanks" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">▭</span>
            <span class="type-name">Fill in the Blanks</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="matching" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">⇄</span>
            <span class="type-name">Matching</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="shortanswer" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">✎</span>
            <span class="type-name">Short Answer</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="ordering" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">≡</span>
            <span class="type-name">Ordering</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="scenario" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">◈</span>
            <span class="type-name">Scenario / Case</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
          <button class="type-card" data-type="branchscenario" role="radio" aria-checked="false" tabindex="-1">
            <span class="type-icon" aria-hidden="true">⑂</span>
            <span class="type-name">Branching Scenario</span>
            <span class="type-ai-badge">✦ AI required</span>
          </button>
        </div>
      </div>

      <!-- Questions -->
      <div class="config-section" id="questions-count-section">
        <label class="field-label" id="questions-label">Number of Questions</label>
        <div class="segmented" role="group" aria-labelledby="questions-label">
          <button class="seg-btn active" data-val="5">5</button>
          <button class="seg-btn" data-val="10">10</button>
          <button class="seg-btn" data-val="15">15</button>
        </div>
      </div>

      <!-- Difficulty -->
      <div class="config-section">
        <label class="field-label" id="difficulty-label">Difficulty Level</label>
        <div class="segmented" role="group" aria-labelledby="difficulty-label">
          <button class="seg-btn active" data-val="introductory">Introductory</button>
          <button class="seg-btn" data-val="intermediate">Intermediate</button>
          <button class="seg-btn" data-val="advanced">Advanced</button>
        </div>
      </div>

      <!-- Objective -->
      <div class="config-section">
        <label class="field-label" for="objective-field">Learning Objective <span style="font-weight:400;opacity:.6">(optional)</span></label>
        <textarea
          class="objective-field"
          id="objective-field"
          placeholder="e.g. Students will identify key ethical frameworks and apply them to real-world scenarios…"
          aria-describedby="objective-hint"
        ></textarea>
        <p class="field-hint" id="objective-hint">Specify the learning goal to focus the activity. Will be included in H5P metadata.</p>
      </div>

      <!-- Content Source -->
      <div class="config-section" id="content-source-section">
        <label class="field-label">Content Source</label>
        <div class="content-source-toggle" role="group" aria-label="Content source">
          <button type="button" class="source-chip active" data-source="demo" id="chip-demo">Demo</button>
          <button type="button" class="source-chip hidden" data-source="chapter" id="chip-chapter">✓ Chapter</button>
          <button type="button" class="source-chip" data-source="ai" id="chip-ai">AI / Paste</button>
        </div>

        <!-- Demo mode notice -->
        <p class="field-hint" id="demo-source-hint">Uses pre-written sample questions. Select a resource with "Demo ready" for the best experience.</p>

        <!-- Chapter loaded notice -->
        <div id="chapter-source-hint" class="hidden">
          <p class="field-hint" style="color:var(--success);">Chapter content loaded from Pressbooks. Click Generate to create questions from it.</p>
        </div>

        <!-- AI / paste mode fields -->
        <div id="ai-source-fields" class="hidden">
          <div class="api-section" style="margin-bottom:10px;">
            <div class="api-section-label">
              <span class="api-status-dot" id="api-dot"></span>
              Proxy Server
            </div>
            <div class="api-row">
              <input
                type="url"
                class="api-input"
                id="proxy-url-input"
                placeholder="http://localhost:3001/api/generate"
                aria-label="Proxy server URL"
                value="http://localhost:3001/api/generate"
              >
              <button type="button" class="btn-test" id="test-connection-btn" aria-label="Test proxy connection">Test</button>
            </div>
            <p class="api-status-msg" id="api-status-msg">Enter your proxy server URL and click Test to verify the connection.</p>
          </div>
          <label class="field-label" for="oer-content-field" style="margin-bottom:8px;">Paste additional text (optional)</label>
          <textarea
            class="oer-content-field"
            id="oer-content-field"
            placeholder="Optionally paste extra text here — combined with any sources loaded in the left panel."
            aria-describedby="oer-content-hint"
          ></textarea>
          <p class="field-hint" id="oer-content-hint" style="margin-top:5px;">Load chapters, URLs, or files from the left panel — or paste text directly here. No content is stored.</p>
        </div>
      </div>

    </div>

    <div class="generate-wrap">
      <button type="button" class="btn-generate" id="generate-btn" disabled aria-label="Generate activity">
        <span class="btn-icon" aria-hidden="true">⊕</span>
        <span id="generate-btn-label">Generate Activity</span>
      </button>
      <p class="generate-hint" id="generate-hint" style="display:none">Load a chapter or paste text to use AI-powered types.</p>
    </div>
  </section>

  <!-- OUTPUT PANEL -->
  <section class="output-panel" aria-label="Activity Output">
    <div class="output-header" id="output-header">
      <span class="output-title" id="output-panel-title">Preview &amp; Export</span>
      <div class="output-actions hidden" id="output-action-btns">
        <button class="btn-action secondary" id="dl-html-btn" aria-label="Download standalone HTML file">
          <span aria-hidden="true">⬇</span> Standalone HTML
        </button>
        <button class="btn-action secondary" id="dl-moodle-btn" aria-label="Export to Moodle GIFT format">
          <span aria-hidden="true">⬇</span> Moodle GIFT
        </button>
        <button class="btn-action primary" id="dl-json-btn" aria-label="Download H5P JSON file">
          <span aria-hidden="true">⬇</span> H5P JSON
        </button>
      </div>
    </div>

    <div class="output-tabs hidden" id="output-tabs" role="tablist">
      <button class="tab-btn active" role="tab" aria-selected="true" data-tab="preview" id="tab-preview">Live Preview</button>
      <button class="tab-btn hidden" role="tab" aria-selected="false" data-tab="treemap" id="tab-treemap">Tree Map</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="json" id="tab-json">H5P JSON</button>
    </div>

    <div class="output-content" id="output-content">
      <!-- Empty state -->
      <div class="empty-state" id="empty-state" aria-live="polite">
        <div class="empty-icon" aria-hidden="true">✦</div>
        <h2 class="empty-title">No Activity Yet</h2>
        <p class="empty-desc">Select an OER resource from the library, configure your activity options, then generate a live preview.</p>
        <div class="empty-steps" aria-hidden="true">
          <div class="empty-step">
            <div class="empty-step-num">1</div>
            <span class="empty-step-text">Pick a resource from the library</span>
          </div>
          <span class="empty-connector">→</span>
          <div class="empty-step">
            <div class="empty-step-num">2</div>
            <span class="empty-step-text">Set type, questions &amp; difficulty</span>
          </div>
          <span class="empty-connector">→</span>
          <div class="empty-step">
            <div class="empty-step-num">3</div>
            <span class="empty-step-text">Generate, play, and export</span>
          </div>
        </div>
      </div>

      <!-- Preview pane (quiz player) -->
      <div class="hidden" id="preview-pane" role="tabpanel" aria-labelledby="tab-preview"></div>

      <!-- Tree Map pane (branching scenario only) -->
      <div class="hidden" id="treemap-pane" role="tabpanel" aria-labelledby="tab-treemap"></div>

      <!-- JSON pane -->
      <div class="hidden" id="json-pane" role="tabpanel" aria-labelledby="tab-json"></div>
    </div>

    <!-- About footer -->
    <footer class="about-footer">
      <span>TRU Open Press · OER Activity Builder PoC · <a href="https://openpress.trubox.ca" class="about-link" target="_blank" rel="noopener">openpress.trubox.ca</a></span>
      <span>Inspired by the <a href="https://bccampus.ca/projects/open-genai-project/" class="about-link" target="_blank" rel="noopener">BCcampus Open GenAI Project</a></span>
    </footer>
  </section>

</div>

<script>
// ─────────────────────────────────────────────
//  DATA
// ─────────────────────────────────────────────

const RESOURCES = [
  {
    id: 'ethics',
    name: 'Introduction to Ethics',
    discipline: 'Philosophy',
    hasDemo: true,
  },
  {
    id: 'thinkers',
    name: 'Great Thinkers',
    discipline: 'Philosophy',
    hasDemo: false,
  },
  {
    id: 'chem-bio',
    name: 'Essential Chemistry for Biologists',
    discipline: 'Chemistry',
    hasDemo: true,
  },
  {
    id: 'passchem',
    name: 'PASSchem Practice Problems',
    discipline: 'Chemistry',
    hasDemo: false,
  },
  {
    id: 'chem-calc',
    name: 'Common Calculations in General Chemistry',
    discipline: 'Chemistry',
    hasDemo: false,
  },
  {
    id: 'cell-mol',
    name: 'Cell and Molecular Biology',
    discipline: 'Biology',
    hasDemo: false,
  },
  {
    id: 'genetics',
    name: 'Introduction to Genetics',
    discipline: 'Biology',
    hasDemo: false,
  },
  {
    id: 'linkage',
    name: 'LINKAGE — Nursing Knowledge and Genomics',
    discipline: 'Nursing',
    hasDemo: false,
  },
  {
    id: 'nursing-pharm',
    name: 'Fundamentals of Nursing Pharmacology',
    discipline: 'Nursing',
    hasDemo: false,
  },
  {
    id: 'prealgebra',
    name: 'Math 0400 ABE PreAlgebra',
    discipline: 'Mathematics',
    hasDemo: false,
  },
  {
    id: 'algebra',
    name: 'Algebra Essentials',
    discipline: 'Mathematics',
    hasDemo: false,
  },
  {
    id: 'marketing',
    name: 'Marketing Moments',
    discipline: 'Business',
    hasDemo: false,
  },
  {
    id: 'labour',
    name: 'Labour Relations in Canada',
    discipline: 'Business',
    hasDemo: false,
  },
  {
    id: 'career',
    name: 'From University to Career',
    discipline: 'Career Development',
    hasDemo: false,
  },
  {
    id: 'career-exp',
    name: 'Career Exploration',
    discipline: 'Career Development',
    hasDemo: false,
  },
];

// Correct question banks
const QUESTION_BANKS = {
  ethics: {
    title: 'Introduction to Ethics',
    discipline: 'Philosophy',
    questions: [
      {
        text: 'What is the primary concern of ethical theory?',
        answers: [
          { text: 'Legal compliance', correct: false, feedback: 'Law and ethics overlap but are not the same — ethics concerns what is morally right, not just what is legally required.' },
          { text: 'The study of right and wrong conduct', correct: true, feedback: 'Correct! Ethics is the branch of philosophy concerned with questions about moral right and wrong, good and bad.' },
          { text: 'Economic efficiency', correct: false, feedback: 'Economics concerns resource allocation and efficiency; ethics focuses on moral principles and values.' },
          { text: 'Political governance', correct: false, feedback: 'Political philosophy concerns governance; ethics is a broader inquiry into right conduct across all domains of life.' },
        ],
      },
      {
        text: 'Which ethical framework holds that the morality of an action is determined solely by its consequences?',
        answers: [
          { text: 'Deontology', correct: false, feedback: 'Deontology judges actions by duties and rules, not by their outcomes. Kant is the most famous deontologist.' },
          { text: 'Virtue Ethics', correct: false, feedback: 'Virtue Ethics focuses on the character of the moral agent, not the consequences of specific actions.' },
          { text: 'Consequentialism', correct: true, feedback: 'Correct! Consequentialism holds that what makes an action right or wrong is its outcome. Utilitarianism is the most well-known consequentialist theory.' },
          { text: 'Divine Command Theory', correct: false, feedback: 'Divine Command Theory grounds morality in the commands of God, not in the consequences of actions.' },
        ],
      },
      {
        text: 'Immanuel Kant\'s categorical imperative asks us to:',
        answers: [
          { text: 'Act to maximize pleasure for the greatest number', correct: false, feedback: 'That describes Utilitarianism (Bentham/Mill), not Kant. Kant rejected basing morality on pleasure and pain.' },
          { text: 'Act only according to principles we could will to be universal laws', correct: true, feedback: 'Correct! Kant\'s first formulation of the categorical imperative: "Act only according to that maxim whereby you can at the same time will that it should become a universal law."' },
          { text: 'Follow the commands of a legitimate authority', correct: false, feedback: 'Kant argued for autonomous moral reasoning — we should follow principles we rationally legislate for ourselves, not external commands.' },
          { text: 'Develop virtuous character traits above all else', correct: false, feedback: 'That describes Aristotle\'s virtue ethics. Kant focused on duty and rational principles, not character development.' },
        ],
      },
      {
        text: 'In Aristotle\'s ethics, eudaimonia refers to:',
        answers: [
          { text: 'Duty to others', correct: false, feedback: 'Duty is more central to Kantian ethics. For Aristotle, eudaimonia is about the fullest realization of our nature.' },
          { text: 'Pleasurable sensations', correct: false, feedback: 'Aristotle distinguished eudaimonia from mere hedonic pleasure — it is something deeper and more enduring.' },
          { text: 'Human flourishing or living well', correct: true, feedback: 'Correct! Eudaimonia is often translated as "flourishing" or "happiness" — but it means the fullest expression of human capacities, not just feeling good.' },
          { text: 'Divine happiness', correct: false, feedback: 'While Aristotle believed the divine exemplifies pure contemplation, eudaimonia in his ethics refers to human flourishing achieved through virtuous activity.' },
        ],
      },
      {
        text: 'The trolley problem is most commonly used to illustrate tensions between:',
        answers: [
          { text: 'Capitalism and socialism', correct: false, feedback: 'The trolley problem is a thought experiment in moral philosophy, not political economy.' },
          { text: 'Deontological and consequentialist ethics', correct: true, feedback: 'Correct! The trolley problem forces a conflict between the consequentialist intuition (divert to save 5 lives) and the deontological intuition (you must not use a person merely as a means).' },
          { text: 'Science and religion', correct: false, feedback: 'The trolley problem concerns competing moral frameworks, not the science-religion debate.' },
          { text: 'Rationalism and empiricism', correct: false, feedback: 'Rationalism vs. empiricism is an epistemological debate about the sources of knowledge, not a moral philosophy tension.' },
        ],
      },
    ],
  },

  'chem-bio': {
    title: 'Essential Chemistry for Biologists',
    discipline: 'Chemistry',
    questions: [
      {
        text: 'Which bond type involves the sharing of electron pairs between atoms?',
        answers: [
          { text: 'Ionic bond', correct: false, feedback: 'Ionic bonds involve the transfer (not sharing) of electrons, typically between a metal and a nonmetal.' },
          { text: 'Covalent bond', correct: true, feedback: 'Correct! Covalent bonds form when two atoms share one or more pairs of electrons. Most biological molecules (proteins, DNA, carbohydrates) are held together by covalent bonds.' },
          { text: 'Hydrogen bond', correct: false, feedback: 'Hydrogen bonds are weak electrostatic attractions between a hydrogen atom bonded to an electronegative atom and another electronegative atom. They are not covalent or ionic.' },
          { text: 'Van der Waals force', correct: false, feedback: 'Van der Waals forces are weak intermolecular forces arising from temporary dipoles, not electron sharing between bonded atoms.' },
        ],
      },
      {
        text: 'Water\'s unusually high specific heat capacity is primarily due to:',
        answers: [
          { text: 'Its low molecular weight', correct: false, feedback: 'Low molecular weight would generally correlate with lower specific heat, not higher. Water\'s high specific heat is due to its intermolecular interactions.' },
          { text: 'Its nonpolar nature', correct: false, feedback: 'Water is actually polar (due to the bent geometry and electronegativity of oxygen), and it is precisely this polarity that enables hydrogen bonding.' },
          { text: 'Extensive hydrogen bonding between molecules', correct: true, feedback: 'Correct! Water\'s high specific heat results from the large network of hydrogen bonds between molecules. A lot of energy is needed to break these bonds and raise the temperature.' },
          { text: 'The presence of ionic bonds', correct: false, feedback: 'Water (H₂O) is a covalent molecule — there are no ionic bonds in water.' },
        ],
      },
      {
        text: 'The pH scale is a measure of:',
        answers: [
          { text: 'Concentration of dissolved oxygen', correct: false, feedback: 'Dissolved oxygen is measured separately (e.g., in mg/L). It is not what pH measures.' },
          { text: 'Hydrogen ion (H⁺) concentration', correct: true, feedback: 'Correct! pH = −log[H⁺]. A lower pH means a higher concentration of hydrogen ions (more acidic); a higher pH means fewer H⁺ ions (more basic).' },
          { text: 'Temperature of a solution', correct: false, feedback: 'Temperature is measured by thermometers, not pH. Though temperature can affect pH, they are distinct measurements.' },
          { text: 'Molecular weight of solutes', correct: false, feedback: 'Molecular weight is a property of individual molecules, determined by atomic masses — not measured by pH.' },
        ],
      },
      {
        text: 'Which macromolecule serves as the primary short-term energy storage molecule in cells?',
        answers: [
          { text: 'Proteins', correct: false, feedback: 'Proteins are primarily structural and functional molecules (enzymes, receptors, etc.), not the primary energy storage form.' },
          { text: 'Nucleic acids', correct: false, feedback: 'Nucleic acids (DNA and RNA) store and transmit genetic information, not energy.' },
          { text: 'Carbohydrates', correct: true, feedback: 'Correct! Carbohydrates such as glucose and glycogen serve as the primary short-term energy storage molecules. (Fats/lipids are the primary long-term energy store.)' },
          { text: 'Phospholipids', correct: false, feedback: 'Phospholipids are the structural components of cell membranes, not energy storage molecules.' },
        ],
      },
      {
        text: 'Enzymes function as biological catalysts by:',
        answers: [
          { text: 'Providing energy for reactions to proceed', correct: false, feedback: 'Enzymes do not provide energy — they reduce the energy needed (activation energy) for the reaction to occur.' },
          { text: 'Lowering the activation energy of reactions', correct: true, feedback: 'Correct! Enzymes bind substrate at the active site and stabilize the transition state, thereby lowering the activation energy needed to start the reaction.' },
          { text: 'Permanently changing the equilibrium constant', correct: false, feedback: 'Enzymes speed up the rate at which equilibrium is reached, but they cannot change the equilibrium constant (Keq) of a reaction.' },
          { text: 'Adding pH buffers to the cellular environment', correct: false, feedback: 'While the cellular environment must be buffered for enzymes to function, enzymes themselves do not act as pH buffers.' },
        ],
      },
    ],
  },
};

// For resources with no demo, fall back to ethics questions with a notice
function getQuestionsForResource(resourceId) {
  const id = typeof resourceId === 'object' ? resourceId.id : resourceId;
  if (QUESTION_BANKS[id]) return { data: QUESTION_BANKS[id], isDemo: false };
  return { data: QUESTION_BANKS['ethics'], isDemo: true };
}

// ─────────────────────────────────────────────
//  STATE
// ─────────────────────────────────────────────

const PROXY_BASE = 'http://localhost:3001';

let state = {
  selectedResource: null,   // id string (static mode) or book object (live mode)
  selectedBookUrl: null,    // live mode: book subdomain URL
  selectedChapter: null,    // live mode: { id, title, wordCount, link }
  loadedChapterText: null,  // plain text fetched from /api/chapter
  sidebarMode: 'live',      // 'live' | 'static'
  liveBooks: [],            // fetched from /api/books
  liveBooksLoaded: false,
  tocParts: [],             // fetched from /api/toc
  numQuestions: 5,
  difficulty: 'introductory',
  activityType: 'quiz',     // 'quiz' | 'truefalse' | 'flashcards' | 'fillblanks'
  activeTab: 'preview',
  generatedData: null,
  quizState: null,
  contentSource: 'demo',    // 'demo' | 'chapter' | 'ai'
  proxyConnected: false,
  sources: [],              // [{ id, label, icon, text, wordCount }] for multi-source
};

// ─────────────────────────────────────────────
//  SIDEBAR: LIVE MODE (Pressbooks API)
// ─────────────────────────────────────────────

async function loadLiveBooks() {
  const list = document.getElementById('resource-list');
  const countBadge = document.getElementById('book-count-badge');
  list.innerHTML = `<div class="sidebar-loading"><div class="spinner"></div><span>Loading from Pressbooks…</span></div>`;
  if (countBadge) countBadge.textContent = '';

  const showAll = document.getElementById('show-all-books')?.checked;
  const url = `${PROXY_BASE}/api/books${showAll ? '?all=1' : ''}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    state.liveBooks = await res.json();
    state.liveBooksLoaded = true;
    renderLiveSidebar();
  } catch (err) {
    list.innerHTML = `<div class="sidebar-error">Could not load books from Pressbooks.<br><small>${escHtml(err.message)}</small><br><br>Is the proxy server running?</div>`;
  }
}

function renderLiveSidebar(filterText = '') {
  const list = document.getElementById('resource-list');
  const countBadge = document.getElementById('book-count-badge');
  const q = filterText.trim().toLowerCase();
  const filtered = state.liveBooks.filter(b =>
    b.title.toLowerCase().includes(q) ||
    (b.subject || '').toLowerCase().includes(q) ||
    (b.author || '').toLowerCase().includes(q)
  );

  // Update count badge
  if (countBadge) {
    countBadge.textContent = q
      ? `${filtered.length} of ${state.liveBooks.length}`
      : `${state.liveBooks.length} books`;
  }

  if (filtered.length === 0) {
    list.innerHTML = '<p class="no-results">No books match your search.</p>';
    return;
  }

  let html = '';
  for (const b of filtered) {
    const isSelected = state.selectedBookUrl === b.link;
    const officialBadge = b.inCatalog
      ? `<span class="official-badge" title="Marked as official in TRU Open Press catalog">★ Official</span>`
      : '';
    html += `<button
      type="button"
      class="resource-item ${isSelected ? 'selected' : ''}"
      role="option"
      aria-selected="${isSelected}"
      data-book-url="${escHtml(b.link)}"
      data-book-title="${escHtml(b.title)}"
      data-book-subject="${escHtml(b.subject || '')}"
      tabindex="0"
    >
      <span class="resource-dot" aria-hidden="true"></span>
      <span>
        <span class="resource-name">${escHtml(b.title)}${officialBadge}</span>
        ${b.subject ? `<span class="resource-demo-badge">${escHtml(b.subject)}</span>` : ''}
      </span>
    </button>`;
  }
  list.innerHTML = html;

  list.querySelectorAll('.resource-item').forEach(btn => {
    btn.addEventListener('click', () => selectLiveBook(btn.dataset.bookUrl, btn.dataset.bookTitle, btn.dataset.bookSubject));
    btn.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectLiveBook(btn.dataset.bookUrl, btn.dataset.bookTitle, btn.dataset.bookSubject); }
    });
  });
}

async function selectLiveBook(bookUrl, bookTitle, bookSubject) {
  state.selectedBookUrl = bookUrl;
  state.selectedResource = { id: bookUrl, name: bookTitle, discipline: bookSubject || 'Open Educational Resource', link: bookUrl };
  state.selectedChapter = null;
  state.loadedChapterText = null;

  // ── Focus mode: hide book list, show selected book card ──
  document.getElementById('resource-list').classList.add('hidden');
  document.getElementById('sidebar-filter-bar').style.display = 'none';
  document.getElementById('sidebar-mode-bar')?.classList.add('hidden');
  document.getElementById('sidebar-header-search')?.classList.add('hidden');

  const card = document.getElementById('selected-book-card');
  card.classList.remove('hidden');
  document.getElementById('selected-book-title-card').textContent = bookTitle;
  document.getElementById('selected-book-sub-card').textContent = bookSubject || 'TRU Open Press';

  // Wire the "Change book" button to exit focus mode
  const changeBtn = document.getElementById('change-book-btn');
  changeBtn.onclick = () => {
    card.classList.add('hidden');
    document.getElementById('resource-list').classList.remove('hidden');
    document.getElementById('sidebar-filter-bar').style.display = '';
    document.getElementById('sidebar-mode-bar')?.classList.remove('hidden');
    document.getElementById('sidebar-header-search')?.classList.remove('hidden');
    // Reset chapter section too
    document.getElementById('chapter-select-wrap').classList.add('hidden');
    state.selectedResource = null;
    state.selectedBookUrl = null;
    state.selectedChapter = null;
    state.loadedChapterText = null;
    document.getElementById('chip-chapter').classList.add('hidden');
    setContentSource('demo');
    document.getElementById('generate-btn').disabled = true;
    renderLiveSidebar(document.getElementById('resource-search').value);
  };

  // Update config header
  document.getElementById('config-resource-title').textContent = bookTitle;
  document.getElementById('config-resource-sub').textContent = `${bookSubject || 'TRU Open Press'} · Pressbooks`;

  // Show chapter selector and load TOC
  const wrap = document.getElementById('chapter-select-wrap');
  wrap.classList.remove('hidden');
  document.getElementById('chapter-loaded-notice').classList.add('hidden');
  document.getElementById('load-chapter-btn').classList.add('hidden');

  const partSel = document.getElementById('part-select');
  const chapSel = document.getElementById('chapter-select');
  partSel.innerHTML = '<option>Loading table of contents…</option>';
  partSel.disabled = true;
  chapSel.innerHTML = '<option>— Select a part first —</option>';
  chapSel.disabled = true;
  document.getElementById('chapter-meta').style.display = 'none';

  // Enable generate with demo content while TOC loads
  document.getElementById('generate-btn').disabled = false;
  updateStepIndicators();

  try {
    const res = await fetch(`${PROXY_BASE}/api/toc?bookUrl=${encodeURIComponent(bookUrl)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    state.tocParts = await res.json();

    partSel.innerHTML = '<option value="">— Select a part —</option>' +
      state.tocParts.map(p => `<option value="${p.id}">${escHtml(p.title)}</option>`).join('');
    partSel.disabled = false;

  } catch (err) {
    partSel.innerHTML = `<option>Error loading TOC: ${escHtml(err.message)}</option>`;
  }
}

function onPartSelected() {
  const partId = parseInt(document.getElementById('part-select').value, 10);
  const chapSel = document.getElementById('chapter-select');
  document.getElementById('chapter-meta').style.display = 'none';
  document.getElementById('load-chapter-btn').classList.add('hidden');
  document.getElementById('chapter-loaded-notice').classList.add('hidden');

  if (!partId) {
    chapSel.innerHTML = '<option value="">— Select a chapter —</option>';
    chapSel.disabled = true;
    return;
  }

  const part = state.tocParts.find(p => p.id === partId);
  if (!part) return;

  chapSel.innerHTML = '<option value="">— Select a chapter —</option>' +
    part.chapters.map(c =>
      `<option value="${c.id}" data-words="${c.wordCount}" data-link="${escHtml(c.link)}">${escHtml(c.title)}${c.wordCount ? ` (${c.wordCount.toLocaleString()} words)` : ''}</option>`
    ).join('');
  chapSel.disabled = false;
}

function onChapterSelected() {
  const chapSel = document.getElementById('chapter-select');
  const opt = chapSel.selectedOptions[0];
  document.getElementById('chapter-loaded-notice').classList.add('hidden');

  if (!chapSel.value) {
    document.getElementById('chapter-meta').style.display = 'none';
    document.getElementById('load-chapter-btn').classList.add('hidden');
    state.selectedChapter = null;
    return;
  }

  const words = opt.dataset.words;
  const link = opt.dataset.link;
  state.selectedChapter = { id: parseInt(chapSel.value, 10), title: opt.text.replace(/ \(\d[\d,]* words\)$/, ''), wordCount: parseInt(words, 10) || 0, link };

  const meta = document.getElementById('chapter-meta');
  meta.style.display = 'flex';
  document.getElementById('chapter-meta-words').textContent = words ? `${parseInt(words).toLocaleString()} words` : '';
  document.getElementById('chapter-meta-link').href = link || '#';

  document.getElementById('load-chapter-btn').classList.remove('hidden');
}

async function loadChapterContent() {
  if (!state.selectedChapter || !state.selectedBookUrl) return;

  const btn = document.getElementById('load-chapter-btn');
  btn.disabled = true;
  btn.innerHTML = '<span aria-hidden="true">◌</span> Adding…';
  document.getElementById('chapter-loaded-notice').classList.add('hidden');

  try {
    const res = await fetch(`${PROXY_BASE}/api/chapter?bookUrl=${encodeURIComponent(state.selectedBookUrl)}&chapterId=${state.selectedChapter.id}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // Add to multi-source array (also switches to 'ai' mode where sources are shown)
    addSourceAB(data.title || state.selectedChapter.title || 'Chapter', '📖', data.text);

    // Show "Chapter loaded" notice in sidebar
    document.getElementById('chapter-loaded-notice').classList.remove('hidden');
    document.getElementById('chapter-loaded-text').textContent = `"${data.title}" added (${data.wordCount.toLocaleString()} words). Click Generate Activity.`;

  } catch (err) {
    document.getElementById('chapter-loaded-notice').classList.remove('hidden');
    document.getElementById('chapter-loaded-notice').style.background = 'var(--error-bg)';
    document.getElementById('chapter-loaded-notice').style.color = 'var(--error)';
    document.getElementById('chapter-loaded-text').textContent = `Error: ${err.message}`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span aria-hidden="true">+</span> Add chapter to sources';
  }
}

// ─────────────────────────────────────────────
//  SIDEBAR: STATIC MODE
// ─────────────────────────────────────────────

function groupByDiscipline(resources) {
  const map = {};
  for (const r of resources) {
    if (!map[r.discipline]) map[r.discipline] = [];
    map[r.discipline].push(r);
  }
  return map;
}

function renderSidebar(filterText = '') {
  const list = document.getElementById('resource-list');
  const q = filterText.trim().toLowerCase();
  const filtered = RESOURCES.filter(r => r.name.toLowerCase().includes(q) || r.discipline.toLowerCase().includes(q));
  const grouped = groupByDiscipline(filtered);

  if (filtered.length === 0) {
    list.innerHTML = '<p class="no-results">No resources match your search.</p>';
    return;
  }

  let html = '';
  for (const [discipline, items] of Object.entries(grouped)) {
    html += `<div class="discipline-group">
      <div class="discipline-label">${escHtml(discipline)}</div>`;
    for (const r of items) {
      const sel = (state.selectedResource && state.selectedResource.id === r.id) ? 'selected' : '';
      html += `<button
        type="button"
        class="resource-item ${sel}"
        role="option"
        aria-selected="${sel === 'selected'}"
        data-id="${r.id}"
        tabindex="0"
      >
        <span class="resource-dot" aria-hidden="true"></span>
        <span>
          <span class="resource-name">${escHtml(r.name)}</span>
          ${r.hasDemo ? '<span class="resource-demo-badge">Demo ready</span>' : ''}
        </span>
      </button>`;
    }
    html += '</div>';
  }
  list.innerHTML = html;

  list.querySelectorAll('.resource-item').forEach(btn => {
    btn.addEventListener('click', () => selectStaticResource(btn.dataset.id));
    btn.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectStaticResource(btn.dataset.id); }
    });
  });
}

function selectStaticResource(id) {
  const r = RESOURCES.find(x => x.id === id);
  if (!r) return;
  state.selectedResource = r;
  state.selectedBookUrl = null;
  renderSidebar(document.getElementById('resource-search').value);

  document.getElementById('config-resource-title').textContent = r.name;
  document.getElementById('config-resource-sub').textContent = `${r.discipline} · TRU Open Press`;
  document.getElementById('chapter-select-wrap').classList.add('hidden');
  document.getElementById('generate-btn').disabled = false;
  updateStepIndicators();
}

// ─────────────────────────────────────────────
//  STEP INDICATORS
// ─────────────────────────────────────────────

function updateStepIndicators() {
  document.getElementById('step1-indicator').classList.remove('active');
  document.getElementById('step1-indicator').classList.add('done');
  document.getElementById('step2-indicator').classList.add('active');
}

// ─────────────────────────────────────────────
//  CONTENT SOURCE TOGGLE
// ─────────────────────────────────────────────

function setContentSource(source) {
  state.contentSource = source;
  document.querySelectorAll('.source-chip').forEach(c => c.classList.remove('active'));
  const chip = document.getElementById(`chip-${source}`);
  if (chip) {
    chip.classList.remove('hidden'); // make visible if it was hidden
    chip.classList.add('active');
  }

  document.getElementById('demo-source-hint').classList.toggle('hidden', source !== 'demo');
  document.getElementById('chapter-source-hint').classList.toggle('hidden', source !== 'chapter');
  document.getElementById('ai-source-fields').classList.toggle('hidden', source !== 'ai');
}

// ── Multi-source management (Activity Builder) ───────────────────────────────

let _abSourceIdCounter = 0;

function escHtmlAB(str) {
  return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function addSourceAB(label, icon, text) {
  const wc = text.trim().split(/\s+/).filter(Boolean).length;
  const id  = ++_abSourceIdCounter;
  state.sources.push({ id, label, icon, text, wordCount: wc });
  // Combine with loadedChapterText for compatibility
  state.loadedChapterText = getMultiSourceText();
  renderSourceTrayAB();
  // Switch to AI/paste mode so generate can see the text
  setContentSource('ai');
  document.getElementById('generate-btn').disabled = false;
  // If no library resource is selected, update the config header to reflect the loaded source
  if (!state.selectedResource) {
    document.getElementById('config-resource-title').textContent = label;
    document.getElementById('config-resource-sub').textContent = `${wc.toLocaleString()} words · ready to generate`;
    updateStepIndicators();
  }
}

function getMultiSourceText() {
  const parts = [];
  state.sources.forEach(s => {
    parts.push(`=== ${s.label} ===\n${s.text}`);
  });
  const pasted = (document.getElementById('oer-content-field')?.value || '').trim();
  if (pasted) parts.push(`=== Pasted text ===\n${pasted}`);
  return parts.join('\n\n');
}

function removeSourceAB(id) {
  state.sources = state.sources.filter(s => s.id !== id);
  state.loadedChapterText = state.sources.length ? getMultiSourceText() : null;
  renderSourceTrayAB();
  const pasted = (document.getElementById('oer-content-field')?.value || '').trim();
  if (!state.sources.length && !pasted) {
    document.getElementById('generate-btn').disabled = true;
  }
}

function renderSourceTrayAB() {
  const tray = document.getElementById('source-tray-ab');
  if (!tray) return;
  if (!state.sources.length) { tray.innerHTML = ''; return; }
  tray.innerHTML = state.sources.map(s => `
    <div class="source-chip-item" data-id="${s.id}">
      <span class="source-chip-icon">${s.icon}</span>
      <span class="source-chip-body">
        <span class="source-chip-label" title="${escHtmlAB(s.label)}">${escHtmlAB(s.label)}</span>
        <span class="source-chip-meta">${s.wordCount.toLocaleString()} words</span>
      </span>
      <button class="source-chip-remove" data-id="${s.id}" aria-label="Remove ${escHtmlAB(s.label)}">✕</button>
    </div>`).join('');
  tray.querySelectorAll('.source-chip-remove').forEach(btn => {
    btn.addEventListener('click', () => removeSourceAB(Number(btn.dataset.id)));
  });
}

async function fetchUrlAB() {
  const input  = document.getElementById('url-fetch-input-ab');
  const status = document.getElementById('url-fetch-status-ab');
  const btn    = document.getElementById('btn-fetch-url-ab');
  const url    = input?.value.trim();
  if (!url) { status.textContent = 'Enter a URL first.'; status.className = 'url-fetch-status error'; return; }
  btn.disabled = true;
  status.textContent = 'Fetching…'; status.className = 'url-fetch-status';
  try {
    const proxyBase = (document.getElementById('proxy-url-input')?.value.trim() || `${PROXY_BASE}/api/generate`).replace(/\/api\/generate\/?$/, '');
    const res  = await fetch(`${proxyBase}/api/fetch-url?url=${encodeURIComponent(url)}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    addSourceAB(data.title || url, '🔗', data.text);
    status.textContent = `✓ Added "${data.title}" — ${(data.wordCount||0).toLocaleString()} words`;
    status.className = 'url-fetch-status success';
    input.value = '';
  } catch (err) {
    status.textContent = `Error: ${err.message}`;
    status.className = 'url-fetch-status error';
  } finally {
    btn.disabled = false;
  }
}

async function handleFileUploadAB(file) {
  const status = document.getElementById('file-upload-status-ab');
  if (!file) return;
  status.textContent = `Reading ${file.name}…`; status.className = 'file-upload-status';
  try {
    const buf = await file.arrayBuffer();
    let text = '';
    if (file.name.toLowerCase().endsWith('.pdf')) {
      if (!window.pdfjsLib) throw new Error('PDF library not loaded yet. Try again in a moment.');
      const pdf    = await window.pdfjsLib.getDocument({ data: buf }).promise;
      const pages  = [];
      for (let i = 1; i <= pdf.numPages; i++) {
        const page    = await pdf.getPage(i);
        const content = await page.getTextContent();
        pages.push(content.items.map(it => it.str).join(' '));
      }
      text = pages.join('\n\n');
    } else if (file.name.toLowerCase().endsWith('.docx')) {
      if (!window.mammoth) throw new Error('Word library not loaded yet. Try again in a moment.');
      const result = await window.mammoth.extractRawText({ arrayBuffer: buf });
      text = result.value;
    } else {
      throw new Error('Only PDF and .docx files are supported.');
    }
    if (!text.trim()) throw new Error('No readable text found in file.');
    addSourceAB(file.name, file.name.toLowerCase().endsWith('.pdf') ? '📄' : '📝', text);
    status.textContent = `✓ Added "${file.name}"`;
    status.className = 'file-upload-status success';
  } catch (err) {
    status.textContent = `Error: ${err.message}`;
    status.className = 'file-upload-status error';
  }
}

// ─────────────────────────────────────────────
//  SEGMENTED CONTROLS
// ─────────────────────────────────────────────

function initSegmented(groupSelector, stateKey) {
  document.querySelectorAll(groupSelector + ' .seg-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll(groupSelector + ' .seg-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state[stateKey] = btn.dataset.val;
    });
  });
}

// ─────────────────────────────────────────────
//  GENERATE
// ─────────────────────────────────────────────

async function generateActivity() {
  // Allow generation with uploaded/fetched sources even without a selected library book
  const hasExternalSources = state.sources.length > 0 ||
    (document.getElementById('oer-content-field')?.value || '').trim();

  if (!state.selectedResource && !hasExternalSources) {
    showApiError('Select a resource from the library, or load content via URL or file upload first.');
    return;
  }

  // Build a synthetic resource stub when generating from external sources only
  const r = state.selectedResource || {
    name: state.sources.length > 0 ? state.sources[0].label : 'Uploaded Content',
    title: state.sources.length > 0 ? state.sources[0].label : 'Uploaded Content',
    discipline: 'Open Educational Resource',
    link: null,
    isDemo: false,
  };
  const objective = document.getElementById('objective-field').value.trim();
  const proxyUrl = document.getElementById('proxy-url-input').value.trim() || `${PROXY_BASE}/api/generate`;
  const type = state.activityType; // 'quiz' | 'truefalse' | 'flashcards' | 'fillblanks' | 'matching' | 'shortanswer' | 'ordering' | 'scenario'
  const aiTypes = ['truefalse','flashcards','fillblanks','matching','shortanswer','ordering','scenario'];

  // Determine OER text to use
  let oerText = null;
  let isAiGenerated = false;
  let chapterTitle = null;
  let chapterLink = null;

  // Resolve effective content source — if sources exist but mode wasn't switched, treat as 'ai'
  const effectiveSource = (state.contentSource === 'demo' && hasExternalSources)
    ? 'ai' : state.contentSource;

  if (effectiveSource === 'chapter') {
    if (!state.loadedChapterText) {
      showApiError('No chapter loaded. Select a chapter in the sidebar and click "Add chapter to sources" first.');
      return;
    }
    oerText = state.loadedChapterText;
    isAiGenerated = true;
    chapterTitle = state.selectedChapter?.title;
    chapterLink = state.selectedChapter?.link;
  } else if (effectiveSource === 'ai') {
    const combined = getMultiSourceText();
    if (!combined) {
      showApiError('Please add source material (load a chapter, fetch a URL, upload a file, or paste text) before generating.');
      return;
    }
    oerText = combined;
    isAiGenerated = true;
    // Use first source label as title if available
    if (!chapterTitle && state.sources.length > 0) {
      chapterTitle = state.sources[0].label;
    }
  }

  // AI-required types must have OER text
  const typeDisplayNames = {
    truefalse: 'True / False', flashcards: 'Flashcards', fillblanks: 'Fill in the Blanks',
    matching: 'Matching', shortanswer: 'Short Answer', ordering: 'Ordering', scenario: 'Scenario / Case',
    branchscenario: 'Branching Scenario',
  };
  if (aiTypes.includes(type) && !oerText) {
    showApiError(`The "${typeDisplayNames[type] || type}" activity type requires OER content. Load a chapter or paste text, then try again.`);
    return;
  }

  // ── DEMO PATH (quiz only, no OER text) ──
  if (!oerText && type === 'quiz') {
    const { data, isDemo } = getQuestionsForResource(state.selectedResource);
    const numQ = Math.min(state.numQuestions, data.questions.length);
    const questions = data.questions.slice(0, numQ);
    state.generatedData = {
      resource: r, questionBank: data, questions, isDemo,
      isAiGenerated: false, activityType: 'quiz',
      difficulty: state.difficulty, objective,
    };
    showOutputUI();
    return;
  }

  // ── AI PATH ──
  showGeneratingState();
  try {
    let generatedData;
    if (type === 'quiz') {
      const questions = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'quiz');
      const questionBank = { title: r.name || r.title, discipline: r.discipline || '', questions };
      generatedData = { resource: r, questionBank, questions, isDemo: false, isAiGenerated: true,
        activityType: 'quiz', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'truefalse') {
      const items = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'truefalse');
      generatedData = { resource: r, items, isDemo: false, isAiGenerated: true,
        activityType: 'truefalse', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'flashcards') {
      const cards = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'flashcards');
      generatedData = { resource: r, cards, isDemo: false, isAiGenerated: true,
        activityType: 'flashcards', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'fillblanks') {
      const sentences = await callClaudeAPI(proxyUrl, oerText, r, 8, state.difficulty, objective, 'fillblanks');
      generatedData = { resource: r, sentences, isDemo: false, isAiGenerated: true,
        activityType: 'fillblanks', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'matching') {
      const pairs = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'matching');
      generatedData = { resource: r, pairs, isDemo: false, isAiGenerated: true,
        activityType: 'matching', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'shortanswer') {
      const questions = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'shortanswer');
      generatedData = { resource: r, questions, isDemo: false, isAiGenerated: true,
        activityType: 'shortanswer', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'ordering') {
      const sequence = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'ordering');
      generatedData = { resource: r, sequence, isDemo: false, isAiGenerated: true,
        activityType: 'ordering', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'scenario') {
      const scenarios = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'scenario');
      generatedData = { resource: r, scenarios, isDemo: false, isAiGenerated: true,
        activityType: 'scenario', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    } else if (type === 'branchscenario') {
      const nodes = await callClaudeAPI(proxyUrl, oerText, r, state.numQuestions, state.difficulty, objective, 'branchscenario');
      if (!nodes || nodes.length === 0) throw new Error('Claude did not return any branching scenario nodes. Try providing more detailed OER text.');
      generatedData = { resource: r, nodes, visitedPath: [], isDemo: false, isAiGenerated: true,
        activityType: 'branchscenario', chapterTitle, chapterLink, difficulty: state.difficulty, objective };
    }
    state.generatedData = generatedData;
    showOutputUI();
  } catch (err) {
    hideGeneratingState();
    showApiError(err.message);
  }
}

function showGeneratingState() {
  const btn = document.getElementById('generate-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="btn-icon" aria-hidden="true">◌</span> Generating…';

  const typeLabels = {
    quiz: 'writing questions',
    truefalse: 'writing True/False statements',
    flashcards: 'creating flashcards',
    fillblanks: 'creating fill-in-the-blank sentences',
    matching: 'creating matching pairs',
    shortanswer: 'writing short-answer questions',
    ordering: 'building an ordering exercise',
    scenario: 'writing scenario-based cases',
    branchscenario: 'building a branching decision tree',
  };
  const what = typeLabels[state.activityType] || 'generating activity';

  document.getElementById('empty-state').classList.add('hidden');
  document.getElementById('output-tabs').classList.add('hidden');
  document.getElementById('output-action-btns').classList.add('hidden');

  const content = document.getElementById('output-content');
  content.innerHTML = `
    <div class="generating-overlay" aria-live="polite" aria-label="Generating activity">
      <div class="spinner" aria-hidden="true"></div>
      <div class="generating-title">Generating with Claude…</div>
      <p class="generating-sub">Claude is reading your OER content and ${what}. This usually takes 5–20 seconds.</p>
    </div>`;
}

const ACTIVITY_TYPE_LABELS = {
  quiz: 'Generate Quiz',
  truefalse: 'Generate True/False',
  flashcards: 'Generate Flashcards',
  fillblanks: 'Generate Fill-in-the-Blanks',
  matching: 'Generate Matching Exercise',
  shortanswer: 'Generate Short Answer',
  ordering: 'Generate Ordering Exercise',
  scenario: 'Generate Scenario / Case',
  branchscenario: 'Generate Branching Scenario',
};

function resetGenerateBtn() {
  const btn = document.getElementById('generate-btn');
  if (!btn) return;
  btn.disabled = false;
  const label = ACTIVITY_TYPE_LABELS[state.activityType] || 'Generate Activity';
  btn.innerHTML = `<span class="btn-icon" aria-hidden="true">⊕</span> <span id="generate-btn-label">${label}</span>`;
}

function hideGeneratingState() {
  resetGenerateBtn();
  const content = document.getElementById('output-content');
  content.innerHTML = `
    <div class="empty-state" id="empty-state" aria-live="polite">
      <div class="empty-icon" aria-hidden="true">✦</div>
      <h2 class="empty-title">No Activity Yet</h2>
      <p class="empty-desc">Select an OER resource from the library, configure your activity options, then generate a live preview.</p>
    </div>`;
}

function showApiError(message) {
  const content = document.getElementById('output-content');
  content.innerHTML = `
    <div class="empty-state" id="empty-state" aria-live="polite">
      <div class="empty-icon" style="color:var(--error);opacity:0.5" aria-hidden="true">⚠</div>
      <h2 class="empty-title" style="color:var(--error);opacity:0.8">Generation Failed</h2>
      <p class="empty-desc">${escHtml(message)}</p>
      <p class="empty-desc" style="margin-top:10px;font-size:0.78rem;">Check that your proxy server is running and the URL is correct, then try again.</p>
    </div>`;

  resetGenerateBtn();
}

function showOutputUI() {
  // Restore the output-content area — showGeneratingState() replaced it with
  // a spinner, which destroyed the pane divs.
  const content = document.getElementById('output-content');
  content.innerHTML = `
    <div class="hidden" id="empty-state" aria-live="polite"></div>
    <div class="hidden" id="preview-pane" role="tabpanel" aria-labelledby="tab-preview"></div>
    <div class="hidden" id="treemap-pane" role="tabpanel" aria-labelledby="tab-treemap"></div>
    <div class="hidden" id="json-pane" role="tabpanel" aria-labelledby="tab-json"></div>`;

  document.getElementById('output-tabs').classList.remove('hidden');
  document.getElementById('output-action-btns').classList.remove('hidden');

  // Show/hide Tree Map tab based on activity type
  const treemapTab = document.getElementById('tab-treemap');
  if (treemapTab) {
    treemapTab.classList.toggle('hidden', state.generatedData?.activityType !== 'branchscenario');
  }

  // Update step indicators
  document.getElementById('step2-indicator').classList.remove('active');
  document.getElementById('step2-indicator').classList.add('done');
  document.getElementById('step3-indicator').classList.add('active');

  resetGenerateBtn();

  state.activeTab = 'preview';
  activateTab('preview');
}

// ─────────────────────────────────────────────
//  CLAUDE API CALL
// ─────────────────────────────────────────────

// Build prompt by activity type
function buildPrompt(oerText, resource, numQuestions, difficulty, objective, activityType) {
  const name = resource.name || resource.title || 'this resource';
  const disc = resource.discipline || 'Open Educational Resource';
  const diff = { introductory: 'introductory', intermediate: 'intermediate', advanced: 'advanced' }[difficulty] || difficulty;
  const objLine = objective ? `\nLearning objective: ${objective}` : '';
  const diffLine = diff === 'introductory' ? 'focus on recall and basic comprehension'
    : diff === 'intermediate' ? 'include application and interpretation questions'
    : 'emphasize analysis, synthesis, and critical evaluation';

  if (activityType === 'quiz') {
    return `You are an educational assessment expert creating quiz questions for a university Open Educational Resource (OER).

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of questions: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate exactly ${numQuestions} multiple-choice questions based strictly on the content above. Each question must have exactly 4 answer options with exactly 1 correct answer.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "text": "Question text here?",
    "answers": [
      { "text": "Correct answer", "correct": true, "feedback": "Why this is correct, 1–2 sentences." },
      { "text": "Wrong answer A", "correct": false, "feedback": "Why this is incorrect." },
      { "text": "Wrong answer B", "correct": false, "feedback": "Why this is incorrect." },
      { "text": "Wrong answer C", "correct": false, "feedback": "Why this is incorrect." }
    ]
  }
]

Requirements: Questions must be grounded in the text. Vary types: definitions, application, comparison, cause-and-effect. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'truefalse') {
    return `You are an educational assessment expert creating True/False questions for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of statements: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate exactly ${numQuestions} True/False statements based strictly on the content above. Mix true and false statements roughly evenly.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "statement": "A clear, testable statement about the content.",
    "correct": true,
    "feedback": "Explanation of why this is true/false, referencing the source text. 1–2 sentences."
  }
]

Requirements: Statements must be unambiguous. False statements should be subtly wrong, not obviously absurd. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'flashcards') {
    return `You are an educational content designer creating flashcards for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of flashcards: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate exactly ${numQuestions} flashcards based strictly on the content above. Each card has a front (prompt/term/question) and back (definition/answer/explanation).

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "front": "Term or question on the front of the card",
    "back": "Definition, answer, or explanation on the back. 1–3 sentences."
  }
]

Requirements: Mix term definitions, concept explanations, and application questions. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'fillblanks') {
    return `You are an educational content designer creating fill-in-the-blank exercises for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}${objLine}

OER Content:
---
${oerText}
---

Generate 6–8 fill-in-the-blank sentences based strictly on the content above. Each sentence has one key term or phrase replaced with a blank.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "text": "The sentence with *answer* marking the blank.",
    "answer": "the exact word or phrase that fills the blank",
    "hint": "A brief hint to help learners (optional — leave empty string if none needed)"
  }
]

IMPORTANT: The blank word/phrase must be wrapped in asterisks in the "text" field, e.g. "Photosynthesis converts *light energy* into chemical energy."
Requirements: Choose significant terms — not trivial words. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'matching') {
    return `You are an educational content designer creating matching exercises for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of pairs: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate exactly ${numQuestions} term-definition pairs based strictly on the content above.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "term": "Key term or concept",
    "definition": "The matching definition, description, or explanation. 1–2 sentences."
  }
]

Requirements: Terms must be distinct and clearly matchable. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'shortanswer') {
    return `You are an educational assessment expert creating short-answer reflection questions for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of questions: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate exactly ${numQuestions} short-answer questions that require 2–4 sentence responses. Include a model answer for each.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "question": "A thoughtful question requiring explanation or reflection.",
    "modelAnswer": "A clear model answer of 2–4 sentences that would earn full marks.",
    "hint": "A brief hint to guide students (optional — leave empty string if not needed)"
  }
]

Requirements: Questions should prompt analysis, explanation, or application — not mere recall. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'ordering') {
    return `You are an educational content designer creating sequencing/ordering exercises for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of sequences: 1${objLine}

OER Content:
---
${oerText}
---

Generate one ordering exercise with ${numQuestions} items that must be placed in the correct sequence. This could be a process, timeline, steps, or logical progression from the content.

Return ONLY a valid JSON object — no explanation, no markdown, no code fences:
{
  "title": "Short title describing what is being ordered",
  "instruction": "A sentence telling students what to put in order",
  "items": [
    { "text": "First item in correct order", "order": 1 },
    { "text": "Second item in correct order", "order": 2 }
  ]
}

Requirements: Items must have a clear, unambiguous correct sequence from the content. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'scenario') {
    return `You are an educational content designer creating scenario-based case study questions for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Number of scenarios: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate exactly ${numQuestions} scenario-based questions. Each presents a realistic situation and asks students to apply concepts from the content.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "scenario": "A realistic 2–3 sentence situation or case description that relates to the content.",
    "question": "A question asking students to analyse, evaluate, or apply concepts to this scenario.",
    "guideline": "A 2–4 sentence model response or key points that constitute a strong answer."
  }
]

Requirements: Scenarios must be realistic and directly connected to content concepts. At ${diff} level: ${diffLine}.`;
  }

  if (activityType === 'branchscenario') {
    return `You are an educational scenario designer creating branching scenario decision trees for a university OER.

Resource: ${name} (${disc})
Difficulty: ${diff}
Total nodes: ${numQuestions}${objLine}

OER Content:
---
${oerText}
---

Generate a branching scenario with exactly ${numQuestions} nodes. Each node presents a realistic situation and 2–3 decision options that lead to different consequences. Some paths may converge (multiple choices leading to the same outcome node), or diverge (choices leading to unique paths). Design the structure naturally based on the content.

IMPORTANT: Node IDs must be consecutive integers starting from 0. Every "next" value must reference an existing node ID. Terminal nodes (end states) have an empty "decisions" array.

Return ONLY a valid JSON array — no explanation, no markdown, no code fences:
[
  {
    "id": 0,
    "scenario": "2–3 sentence description of the opening situation that requires a decision.",
    "decisions": [
      { "text": "Decision option A (concise, under 15 words)", "next": 1, "feedback": "1–2 sentence consequence of choosing A." },
      { "text": "Decision option B (concise, under 15 words)", "next": 2, "feedback": "1–2 sentence consequence of choosing B." }
    ]
  },
  {
    "id": 1,
    "scenario": "2–3 sentence description of what happens after Decision A.",
    "decisions": [
      { "text": "Next decision option", "next": 3, "feedback": "Consequence." }
    ]
  },
  {
    "id": ${numQuestions - 1},
    "scenario": "2–3 sentence final outcome — summarise what was learned or achieved.",
    "decisions": []
  }
]

Requirements: Every non-terminal node must have 2–3 decisions. Terminal nodes (empty decisions array) represent end states. Each scenario must be directly based on the OER content. At ${diff} level: ${diffLine}.`;
  }

  throw new Error('Unknown activity type: ' + activityType);
}

async function callClaudeAPI(proxyUrl, oerText, resource, numQuestions, difficulty, objective, activityType = 'quiz') {
  const prompt = buildPrompt(oerText, resource, numQuestions, difficulty, objective, activityType);

  let response;
  try {
    response = await fetch(proxyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt }),
    });
  } catch (fetchErr) {
    throw new Error(`Could not reach the proxy server at ${proxyUrl}. Is it running? (${fetchErr.message})`);
  }

  if (!response.ok) {
    let errText = '';
    try { errText = await response.text(); } catch (_) {}
    throw new Error(`Proxy returned HTTP ${response.status}. ${errText || 'Check the server logs for details.'}`);
  }

  let data;
  try {
    data = await response.json();
  } catch (_) {
    throw new Error('Proxy response was not valid JSON. Check the server is returning the Claude API response correctly.');
  }

  const rawText = data?.content?.[0]?.text;
  if (!rawText) {
    throw new Error('Claude\'s response did not contain expected content. The proxy may not be forwarding the full API response.');
  }

  // Strip accidental markdown fences
  const cleaned = rawText.replace(/^```(?:json)?\s*/i, '').replace(/\s*```\s*$/i, '').trim();
  let parsed;
  try {
    parsed = JSON.parse(cleaned);
  } catch (_) {
    throw new Error('Claude returned content that could not be parsed as JSON. Try regenerating.');
  }

  if (!Array.isArray(parsed) || parsed.length === 0) {
    throw new Error('Claude did not return any content. Try providing more detailed OER text.');
  }

  // Validate & sanitise by type
  if (activityType === 'quiz') {
    return parsed.slice(0, numQuestions).map(q => ({
      text: String(q.text || '').trim(),
      answers: (Array.isArray(q.answers) ? q.answers : []).map(a => ({
        text: String(a.text || '').trim(),
        correct: Boolean(a.correct),
        feedback: String(a.feedback || '').trim(),
      })),
    })).filter(q => q.text && q.answers.length >= 2);
  }

  if (activityType === 'truefalse') {
    return parsed.slice(0, numQuestions).map(q => ({
      statement: String(q.statement || '').trim(),
      correct: Boolean(q.correct),
      feedback: String(q.feedback || '').trim(),
    })).filter(q => q.statement);
  }

  if (activityType === 'flashcards') {
    return parsed.slice(0, numQuestions).map(c => ({
      front: String(c.front || '').trim(),
      back: String(c.back || '').trim(),
    })).filter(c => c.front && c.back);
  }

  if (activityType === 'fillblanks') {
    return parsed.map(s => ({
      text: String(s.text || '').trim(),
      answer: String(s.answer || '').trim().toLowerCase(),
      hint: String(s.hint || '').trim(),
    })).filter(s => s.text && s.answer);
  }

  if (activityType === 'matching') {
    return parsed.slice(0, numQuestions).map(p => ({
      term: String(p.term || '').trim(),
      definition: String(p.definition || '').trim(),
    })).filter(p => p.term && p.definition);
  }

  if (activityType === 'shortanswer') {
    return parsed.slice(0, numQuestions).map(q => ({
      question: String(q.question || '').trim(),
      modelAnswer: String(q.modelAnswer || '').trim(),
      hint: String(q.hint || '').trim(),
    })).filter(q => q.question && q.modelAnswer);
  }

  if (activityType === 'ordering') {
    // ordering returns a single object, not an array
    const obj = Array.isArray(parsed) ? parsed[0] : parsed;
    return {
      title: String(obj.title || '').trim(),
      instruction: String(obj.instruction || '').trim(),
      items: (Array.isArray(obj.items) ? obj.items : [])
        .map(it => ({ text: String(it.text || '').trim(), order: Number(it.order) || 0 }))
        .filter(it => it.text)
        .sort((a, b) => a.order - b.order),
    };
  }

  if (activityType === 'scenario') {
    return parsed.slice(0, numQuestions).map(s => ({
      scenario: String(s.scenario || '').trim(),
      question: String(s.question || '').trim(),
      guideline: String(s.guideline || '').trim(),
    })).filter(s => s.scenario && s.question);
  }

  if (activityType === 'branchscenario') {
    // Build set of valid node IDs first
    const rawNodes = Array.isArray(parsed) ? parsed : [];
    const nodeIds = new Set(rawNodes.map(n => Number(n.id)));
    const nodes = rawNodes.map(n => ({
      id: Number(n.id) || 0,
      scenario: String(n.scenario || '').trim(),
      decisions: (Array.isArray(n.decisions) ? n.decisions : [])
        .map(d => ({
          text: String(d.text || '').trim(),
          next: Number(d.next),
          feedback: String(d.feedback || '').trim(),
        }))
        .filter(d => d.text && nodeIds.has(d.next)),
    })).filter(n => n.scenario);
    // Sort by id and ensure node 0 exists
    nodes.sort((a, b) => a.id - b.id);
    return nodes;
  }

  return parsed;
}

// ─────────────────────────────────────────────
//  CONNECTION TEST
// ─────────────────────────────────────────────

async function testConnection() {
  const proxyUrl = document.getElementById('proxy-url-input').value.trim();
  const dot = document.getElementById('api-dot');
  const msg = document.getElementById('api-status-msg');
  const btn = document.getElementById('test-connection-btn');

  if (!proxyUrl) {
    msg.textContent = 'Enter a proxy URL first.';
    msg.className = 'api-status-msg err';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Testing…';
  dot.className = 'api-status-dot';
  msg.className = 'api-status-msg';
  msg.textContent = 'Connecting…';

  // Send a minimal ping prompt to verify the proxy is reachable and forwarding
  try {
    const response = await fetch(proxyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: 'Reply with the single word: connected' }),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    const hasContent = data?.content?.[0]?.text;

    if (hasContent) {
      dot.className = 'api-status-dot connected';
      msg.textContent = 'Connected — proxy is reachable and Claude API is responding.';
      msg.className = 'api-status-msg ok';
      state.proxyConnected = true;
    } else {
      throw new Error('Proxy responded but Claude content was missing from the response.');
    }
  } catch (err) {
    dot.className = 'api-status-dot error';
    msg.textContent = `Connection failed: ${err.message}`;
    msg.className = 'api-status-msg err';
    state.proxyConnected = false;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Test';
  }
}

// ─────────────────────────────────────────────
//  TABS
// ─────────────────────────────────────────────

function activateTab(tabId) {
  state.activeTab = tabId;
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tabId);
    b.setAttribute('aria-selected', b.dataset.tab === tabId);
  });

  const preview = document.getElementById('preview-pane');
  const treemap = document.getElementById('treemap-pane');
  const json = document.getElementById('json-pane');

  // Hide all panes first
  preview.classList.add('hidden');
  treemap.classList.add('hidden');
  json.classList.add('hidden');

  if (tabId === 'preview') {
    preview.classList.remove('hidden');
    const type = state.generatedData?.activityType || 'quiz';
    if (type === 'quiz') renderQuizPlayer();
    else if (type === 'truefalse') renderTrueFalsePlayer();
    else if (type === 'flashcards') renderFlashcardsPlayer();
    else if (type === 'fillblanks') renderFillBlanksPlayer();
    else if (type === 'matching') renderMatchingPlayer();
    else if (type === 'shortanswer') renderShortAnswerPlayer();
    else if (type === 'ordering') renderOrderingPlayer();
    else if (type === 'scenario') renderScenarioPlayer();
    else if (type === 'branchscenario') renderBranchScenarioPlayer();
  } else if (tabId === 'treemap') {
    treemap.classList.remove('hidden');
    renderBranchTreeMap();
  } else {
    json.classList.remove('hidden');
    renderJsonView();
  }
}

// ─────────────────────────────────────────────
//  QUIZ PLAYER
// ─────────────────────────────────────────────

function renderQuizPlayer() {
  const pane = document.getElementById('preview-pane');
  const { questions, resource, questionBank, isDemo, difficulty, isAiGenerated } = state.generatedData;
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || 'Introductory';
  const resourceName = resource.name || resource.title || 'Resource';
  const disc = resource.discipline || questionBank?.discipline || 'OER';
  const qbTitle = questionBank?.title || resourceName;

  const chapterNote = state.generatedData.chapterTitle
    ? ` — Chapter: <em>${escHtml(state.generatedData.chapterTitle)}</em>` : '';

  const notice = isAiGenerated
    ? `<div class="demo-notice" role="note" style="background:rgba(39,103,73,0.06);border-color:rgba(39,103,73,0.25);">
        <span class="demo-notice-icon" aria-hidden="true">✦</span>
        <span><strong>AI-generated from your OER:</strong> Review before publishing${chapterNote}.</span>
       </div>`
    : isDemo
    ? `<div class="demo-notice" role="note">
        <span class="demo-notice-icon" aria-hidden="true">⚠</span>
        <span><strong>Demo content:</strong> Showing sample questions. Load a chapter or paste text + use AI for real questions.</span>
       </div>`
    : '';

  pane.innerHTML = `
    ${notice}
    <div class="quiz-player">
      <div class="quiz-card" id="quiz-card">
        <div class="quiz-intro" id="quiz-intro-screen">
          <div class="quiz-resource-tag" aria-hidden="true">📖 ${escHtml(disc)}</div>
          <h3 class="quiz-title">${escHtml(qbTitle)}</h3>
          <p class="quiz-meta">${questions.length} questions · ${diffLabel}</p>
          <button class="btn-start" id="quiz-start-btn">Begin Quiz</button>
        </div>
        <div id="quiz-question-screen" class="hidden"></div>
        <div id="quiz-score-screen" class="hidden"></div>
      </div>
    </div>`;

  document.getElementById('quiz-start-btn').addEventListener('click', startQuiz);
}

function startQuiz() {
  state.quizState = {
    currentQ: 0,
    score: 0,
    answers: [],
  };
  document.getElementById('quiz-intro-screen').classList.add('hidden');
  showQuestion();
}

function showQuestion() {
  const { questions } = state.generatedData;
  const { currentQ } = state.quizState;
  const q = questions[currentQ];
  const screen = document.getElementById('quiz-question-screen');
  screen.classList.remove('hidden');

  const pct = ((currentQ) / questions.length) * 100;

  screen.innerHTML = `
    <div class="quiz-progress-bar-wrap">
      <div class="quiz-progress-label">
        <span>Question ${currentQ + 1} of ${questions.length}</span>
        <span>${Math.round(pct)}% complete</span>
      </div>
      <div class="quiz-progress-track" role="progressbar" aria-valuenow="${Math.round(pct)}" aria-valuemin="0" aria-valuemax="100">
        <div class="quiz-progress-fill" style="width:${pct}%"></div>
      </div>
    </div>
    <div class="quiz-question-wrap">
      <p class="question-text">${escHtml(q.text)}</p>
      <ul class="answer-list" id="answer-list" role="group" aria-label="Answer choices">
        ${q.answers.map((a, i) => `
          <li class="answer-item">
            <input
              type="radio"
              class="answer-input"
              name="quiz-answer"
              id="ans-${i}"
              value="${i}"
            >
            <label class="answer-label" for="ans-${i}">
              <span class="answer-radio" aria-hidden="true"></span>
              <span class="answer-text">${escHtml(a.text)}</span>
              <span class="answer-flag" aria-hidden="true"></span>
            </label>
          </li>
        `).join('')}
      </ul>
    </div>
    <div class="feedback-box" id="feedback-box" role="alert" aria-live="polite"></div>
    <div class="quiz-actions">
      <button class="btn-check" id="check-btn" disabled>Check Answer</button>
      <button class="btn-next" id="next-btn">${currentQ + 1 < questions.length ? 'Next Question' : 'See Results'}</button>
    </div>`;

  // Wire up radio changes
  screen.querySelectorAll('.answer-input').forEach(inp => {
    inp.addEventListener('change', () => {
      document.getElementById('check-btn').disabled = false;
    });
  });

  document.getElementById('check-btn').addEventListener('click', checkAnswer);
  document.getElementById('next-btn').addEventListener('click', nextQuestion);
}

function checkAnswer() {
  const { questions } = state.generatedData;
  const { currentQ } = state.quizState;
  const q = questions[currentQ];

  const selected = document.querySelector('.answer-input:checked');
  if (!selected) return;

  const idx = parseInt(selected.value);
  const answer = q.answers[idx];
  const isCorrect = answer.correct;

  if (isCorrect) state.quizState.score++;
  state.quizState.answers.push({ questionIndex: currentQ, answerIndex: idx, correct: isCorrect });

  // Disable all inputs
  document.querySelectorAll('.answer-input').forEach(inp => { inp.disabled = true; });
  document.querySelectorAll('.answer-label').forEach((lbl, i) => {
    lbl.classList.add('disabled');
    if (q.answers[i].correct) {
      lbl.classList.add('correct');
      lbl.querySelector('.answer-flag').textContent = '✓';
    } else if (i === idx && !q.answers[i].correct) {
      lbl.classList.add('incorrect');
      lbl.querySelector('.answer-flag').textContent = '✗';
    }
  });

  // Show feedback
  const fb = document.getElementById('feedback-box');
  fb.style.display = 'block';
  fb.className = `feedback-box ${isCorrect ? 'correct' : 'incorrect'}`;
  fb.innerHTML = `<span class="feedback-lead">${isCorrect ? '✓ Correct!' : '✗ Not quite.'}</span>${escHtml(answer.feedback)}`;

  // Toggle buttons
  document.getElementById('check-btn').style.display = 'none';
  document.getElementById('next-btn').style.display = 'block';
}

function nextQuestion() {
  const { questions } = state.generatedData;
  state.quizState.currentQ++;

  if (state.quizState.currentQ >= questions.length) {
    showScore();
  } else {
    showQuestion();
  }
}

function showScore() {
  const { questions } = state.generatedData;
  const { score } = state.quizState;
  const pct = Math.round((score / questions.length) * 100);

  document.getElementById('quiz-question-screen').classList.add('hidden');
  const scoreScreen = document.getElementById('quiz-score-screen');
  scoreScreen.classList.remove('hidden');

  const circumference = 2 * Math.PI * 52;
  const offset = circumference - (pct / 100) * circumference;
  const message = pct >= 80 ? 'Excellent work!' : pct >= 60 ? 'Good effort!' : 'Keep practising!';
  const sub = pct >= 80
    ? 'You have a strong grasp of this material.'
    : pct >= 60
    ? 'Review the questions you missed and try again.'
    : 'Revisit the resource and try the quiz again.';

  scoreScreen.innerHTML = `
    <div class="score-screen">
      <div class="score-ring-wrap" aria-hidden="true">
        <svg class="score-ring" viewBox="0 0 120 120">
          <circle class="score-ring-bg" cx="60" cy="60" r="52"/>
          <circle class="score-ring-fill" cx="60" cy="60" r="52"
            stroke-dasharray="${circumference}"
            stroke-dashoffset="${offset}"
            stroke="${pct >= 80 ? '#276749' : pct >= 60 ? '#003865' : '#9b2335'}"/>
        </svg>
        <div class="score-center">
          <span class="score-pct">${pct}%</span>
          <span class="score-pct-label">Score</span>
        </div>
      </div>
      <h3 class="score-title">${message}</h3>
      <p class="score-subtitle">${sub}</p>
      <div class="score-breakdown" role="list">
        <div class="score-stat" role="listitem">
          <div class="score-stat-num">${score}</div>
          <div class="score-stat-label">Correct</div>
        </div>
        <div class="score-stat" role="listitem">
          <div class="score-stat-num">${questions.length - score}</div>
          <div class="score-stat-label">Incorrect</div>
        </div>
        <div class="score-stat" role="listitem">
          <div class="score-stat-num">${questions.length}</div>
          <div class="score-stat-label">Total</div>
        </div>
      </div>
      <div class="score-actions">
        <button class="btn-retry" id="retry-btn">Try Again</button>
      </div>
    </div>`;

  document.getElementById('retry-btn').addEventListener('click', startQuiz);
}

// ─────────────────────────────────────────────
//  TRUE/FALSE PLAYER
// ─────────────────────────────────────────────

function renderTrueFalsePlayer() {
  const pane = document.getElementById('preview-pane');
  const { items, resource, difficulty } = state.generatedData;
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;
  const name = resource.name || resource.title || 'Resource';

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card" id="tf-card">
        <div class="quiz-intro" id="tf-intro">
          <div class="quiz-resource-tag" aria-hidden="true">⊙ True / False</div>
          <h3 class="quiz-title">${escHtml(name)}</h3>
          <p class="quiz-meta">${items.length} statements · ${diffLabel}</p>
          <button class="btn-start" id="tf-start-btn">Begin</button>
        </div>
        <div id="tf-question-screen" class="hidden"></div>
        <div id="tf-score-screen" class="hidden"></div>
      </div>
    </div>`;

  let tfState = { current: 0, score: 0 };

  function showTFQuestion() {
    const q = items[tfState.current];
    const pct = (tfState.current / items.length) * 100;
    const screen = document.getElementById('tf-question-screen');
    screen.classList.remove('hidden');
    screen.innerHTML = `
      <div class="quiz-progress-bar-wrap">
        <div class="quiz-progress-label">
          <span>Statement ${tfState.current + 1} of ${items.length}</span>
          <span>${Math.round(pct)}% complete</span>
        </div>
        <div class="quiz-progress-track" role="progressbar" aria-valuenow="${Math.round(pct)}" aria-valuemin="0" aria-valuemax="100">
          <div class="quiz-progress-fill" style="width:${pct}%"></div>
        </div>
      </div>
      <div class="quiz-question-wrap">
        <p class="question-text">${escHtml(q.statement)}</p>
        <div class="tf-buttons" role="group" aria-label="True or False">
          <button class="tf-btn true-btn" id="tf-true">✓ True</button>
          <button class="tf-btn false-btn" id="tf-false">✗ False</button>
        </div>
      </div>
      <div class="feedback-box" id="tf-feedback" role="alert" aria-live="polite"></div>
      <div class="quiz-actions" id="tf-next-wrap" style="display:none">
        <button class="btn-next" id="tf-next" style="display:block">${tfState.current + 1 < items.length ? 'Next Statement' : 'See Results'}</button>
      </div>`;

    function handleTF(chosen) {
      document.getElementById('tf-true').disabled = true;
      document.getElementById('tf-false').disabled = true;
      const isCorrect = (chosen === true) === q.correct;
      if (isCorrect) tfState.score++;
      const fb = document.getElementById('tf-feedback');
      fb.style.display = 'block';
      fb.className = `feedback-box ${isCorrect ? 'correct' : 'incorrect'}`;
      fb.innerHTML = `<span class="feedback-lead">${isCorrect ? '✓ Correct!' : '✗ Not quite.'}</span> <strong>${q.correct ? 'True.' : 'False.'}</strong> ${escHtml(q.feedback)}`;
      document.getElementById('tf-next-wrap').style.display = '';
      document.getElementById('tf-next').addEventListener('click', () => {
        tfState.current++;
        if (tfState.current >= items.length) showTFScore();
        else showTFQuestion();
      });
    }
    document.getElementById('tf-true').addEventListener('click', () => handleTF(true));
    document.getElementById('tf-false').addEventListener('click', () => handleTF(false));
  }

  function showTFScore() {
    document.getElementById('tf-question-screen').classList.add('hidden');
    const pct = Math.round((tfState.score / items.length) * 100);
    const msg = pct >= 80 ? 'Excellent!' : pct >= 60 ? 'Good effort!' : 'Keep practising!';
    const circumference = 2 * Math.PI * 52;
    const offset = circumference - (pct / 100) * circumference;
    const sc = document.getElementById('tf-score-screen');
    sc.classList.remove('hidden');
    sc.innerHTML = `
      <div class="score-screen">
        <div class="score-ring-wrap" aria-hidden="true">
          <svg class="score-ring" viewBox="0 0 120 120">
            <circle class="score-ring-bg" cx="60" cy="60" r="52"/>
            <circle class="score-ring-fill" cx="60" cy="60" r="52"
              stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
              stroke="${pct >= 80 ? '#276749' : pct >= 60 ? '#003865' : '#9b2335'}"/>
          </svg>
          <div class="score-center"><span class="score-pct">${pct}%</span><span class="score-pct-label">Score</span></div>
        </div>
        <h3 class="score-title">${msg}</h3>
        <p class="score-subtitle">${tfState.score} of ${items.length} correct</p>
        <div class="score-actions"><button class="btn-retry" id="tf-retry">Try Again</button></div>
      </div>`;
    document.getElementById('tf-retry').addEventListener('click', () => {
      tfState = { current: 0, score: 0 };
      sc.classList.add('hidden');
      showTFQuestion();
    });
  }

  document.getElementById('tf-start-btn').addEventListener('click', () => {
    document.getElementById('tf-intro').classList.add('hidden');
    showTFQuestion();
  });
}

// ─────────────────────────────────────────────
//  FLASHCARDS PLAYER
// ─────────────────────────────────────────────

function renderFlashcardsPlayer() {
  const pane = document.getElementById('preview-pane');
  const { cards, resource } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';
  let current = 0;
  let flipped = false;

  function cardHTML(idx) {
    const c = cards[idx];
    return `
      <div class="fc-wrap">
        <div class="fc-counter">${idx + 1} / ${cards.length}</div>
        <div class="fc-card ${flipped ? 'flipped' : ''}" id="fc-card" role="button" tabindex="0"
             aria-label="Flashcard — click to flip" title="Click to flip">
          <div class="fc-front">
            <div class="fc-side-label">FRONT</div>
            <div class="fc-text">${escHtml(c.front)}</div>
            <div class="fc-flip-hint">Tap to reveal answer</div>
          </div>
          <div class="fc-back">
            <div class="fc-side-label">BACK</div>
            <div class="fc-text">${escHtml(c.back)}</div>
          </div>
        </div>
        <div class="fc-nav">
          <button class="btn-fc-nav" id="fc-prev" ${idx === 0 ? 'disabled' : ''}>← Prev</button>
          <span class="fc-dot-wrap">${cards.map((_, i) =>
            `<span class="fc-dot ${i === idx ? 'active' : ''}"></span>`
          ).join('')}</span>
          <button class="btn-fc-nav" id="fc-next" ${idx === cards.length - 1 ? 'disabled' : ''}>Next →</button>
        </div>
      </div>`;
  }

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card">
        <div class="quiz-intro">
          <div class="quiz-resource-tag" aria-hidden="true">⧉ Flashcards</div>
          <h3 class="quiz-title">${escHtml(name)}</h3>
          <p class="quiz-meta">${cards.length} cards — click each card to flip</p>
          <button class="btn-start" id="fc-start-btn">Start Studying</button>
        </div>
      </div>
    </div>`;

  document.getElementById('fc-start-btn').addEventListener('click', () => {
    const player = pane.querySelector('.quiz-player');
    player.querySelector('.quiz-card').innerHTML = cardHTML(current);
    wireFC();
  });

  function wireFC() {
    const card = document.getElementById('fc-card');
    card.addEventListener('click', () => {
      flipped = !flipped;
      card.classList.toggle('flipped', flipped);
    });
    card.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
    });
    document.getElementById('fc-prev')?.addEventListener('click', () => {
      if (current > 0) { current--; flipped = false; pane.querySelector('.quiz-card').innerHTML = cardHTML(current); wireFC(); }
    });
    document.getElementById('fc-next')?.addEventListener('click', () => {
      if (current < cards.length - 1) { current++; flipped = false; pane.querySelector('.quiz-card').innerHTML = cardHTML(current); wireFC(); }
    });
  }
}

// ─────────────────────────────────────────────
//  FILL IN THE BLANKS PLAYER
// ─────────────────────────────────────────────

function renderFillBlanksPlayer() {
  const pane = document.getElementById('preview-pane');
  const { sentences, resource } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';

  function buildExercise() {
    return `
      <div class="fib-wrap">
        <p class="fib-instructions">Type the missing word or phrase in each blank, then click Check.</p>
        <div class="fib-items" id="fib-items">
          ${sentences.map((s, i) => {
            const parts = s.text.split(/\*([^*]+)\*/);
            let display = '';
            for (let j = 0; j < parts.length; j++) {
              if (j % 2 === 0) {
                display += `<span>${escHtml(parts[j])}</span>`;
              } else {
                const approxLen = Math.max(10, parts[j].length + 2);
                display += `<input class="fib-input" data-idx="${i}" data-answer="${escHtml(s.answer)}"
                  style="width:${approxLen}ch" placeholder="…" aria-label="Fill in the blank" autocomplete="off" autocorrect="off" spellcheck="false">`;
              }
            }
            return `<div class="fib-item" id="fib-item-${i}">
              <span class="fib-num">${i + 1}</span>
              <span class="fib-sentence">${display}</span>
              ${s.hint ? `<span class="fib-hint">Hint: ${escHtml(s.hint)}</span>` : ''}
              <span class="fib-result" id="fib-result-${i}" aria-live="polite"></span>
            </div>`;
          }).join('')}
        </div>
        <div class="fib-actions">
          <button class="btn-check" id="fib-check-btn">Check All Answers</button>
          <button class="btn-next" id="fib-reset-btn" style="display:none">Try Again</button>
        </div>
        <div class="fib-score" id="fib-score" style="display:none"></div>
      </div>`;
  }

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card">
        <div class="quiz-intro">
          <div class="quiz-resource-tag" aria-hidden="true">▭ Fill in the Blanks</div>
          <h3 class="quiz-title">${escHtml(name)}</h3>
          <p class="quiz-meta">${sentences.length} sentences — fill in the missing terms</p>
          <button class="btn-start" id="fib-start-btn">Start Exercise</button>
        </div>
      </div>
    </div>`;

  document.getElementById('fib-start-btn').addEventListener('click', () => {
    pane.querySelector('.quiz-card').innerHTML = buildExercise();

    // Enter key advances to next input
    pane.querySelectorAll('.fib-input').forEach((inp, i, all) => {
      inp.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); (all[i + 1] || document.getElementById('fib-check-btn'))?.focus(); }
      });
    });

    document.getElementById('fib-check-btn').addEventListener('click', () => {
      let correct = 0;
      pane.querySelectorAll('.fib-input').forEach(inp => {
        inp.disabled = true;
        const userVal = inp.value.trim().toLowerCase().replace(/[.,;!?]+$/, '');
        const correctVal = inp.dataset.answer.toLowerCase().replace(/[.,;!?]+$/, '');
        const idx = parseInt(inp.dataset.idx);
        const res = document.getElementById(`fib-result-${idx}`);
        if (userVal === correctVal) {
          correct++;
          inp.style.borderColor = '#276749';
          inp.style.background = '#f0faf5';
          if (res) { res.textContent = '✓'; res.style.color = '#276749'; }
        } else {
          inp.style.borderColor = '#9b2335';
          inp.style.background = '#fff5f6';
          if (res) { res.innerHTML = `✗ <em>${escHtml(inp.dataset.answer)}</em>`; res.style.color = '#9b2335'; }
        }
      });
      document.getElementById('fib-check-btn').style.display = 'none';
      document.getElementById('fib-reset-btn').style.display = '';
      const scoreEl = document.getElementById('fib-score');
      const pct = Math.round((correct / sentences.length) * 100);
      scoreEl.style.display = 'block';
      scoreEl.innerHTML = `<strong>${correct} / ${sentences.length} correct (${pct}%)</strong>`;
      scoreEl.style.color = pct >= 70 ? '#276749' : '#9b2335';
    });

    document.getElementById('fib-reset-btn').addEventListener('click', () => {
      pane.querySelector('.quiz-card').innerHTML = buildExercise();
      document.getElementById('fib-start-btn')?.remove();
      renderFillBlanksPlayer();
    });
  });
}

// ─────────────────────────────────────────────
//  MATCHING PLAYER
// ─────────────────────────────────────────────

function renderMatchingPlayer() {
  const pane = document.getElementById('preview-pane');
  const { pairs, resource, difficulty } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;

  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }

  function buildGame() {
    const shuffledDefs = shuffle(pairs.map((p, i) => ({ text: p.definition, idx: i })));
    let selected = null; // { side:'term'|'def', idx }
    let matched = new Set();

    const termsHtml = pairs.map((p, i) =>
      `<button class="match-item" data-side="term" data-idx="${i}">${escHtml(p.term)}</button>`
    ).join('');
    const defsHtml = shuffledDefs.map((d, si) =>
      `<button class="match-item" data-side="def" data-idx="${d.idx}" data-pos="${si}">${escHtml(d.text)}</button>`
    ).join('');

    pane.querySelector('.quiz-card').innerHTML = `
      <div style="padding:24px">
        <div class="quiz-resource-tag" aria-hidden="true">⇄ Matching</div>
        <h3 class="quiz-title">${escHtml(name)}</h3>
        <p class="quiz-meta">${pairs.length} pairs — click a term, then its definition</p>
        <div class="match-grid">
          <div class="match-col" id="match-terms">${termsHtml}</div>
          <div class="match-col" id="match-defs">${defsHtml}</div>
        </div>
        <div class="match-score" id="match-score" style="display:none"></div>
        <div class="fib-actions" style="margin-top:16px">
          <button class="btn-next" id="match-reset-btn">Restart</button>
        </div>
      </div>`;

    document.getElementById('match-reset-btn').addEventListener('click', () => buildGame());

    pane.querySelectorAll('.match-item').forEach(btn => {
      btn.addEventListener('click', () => {
        if (matched.has(Number(btn.dataset.idx)) && btn.dataset.side === 'term') return;
        if (matched.has(Number(btn.dataset.idx)) && btn.dataset.side === 'def') return;

        if (!selected) {
          selected = { side: btn.dataset.side, idx: Number(btn.dataset.idx), el: btn };
          btn.classList.add('match-selected');
        } else {
          if (selected.el === btn) { btn.classList.remove('match-selected'); selected = null; return; }
          // Check match
          const termIdx = selected.side === 'term' ? selected.idx : Number(btn.dataset.idx);
          const defIdx  = selected.side === 'def'  ? selected.idx : Number(btn.dataset.idx);
          if (termIdx === defIdx) {
            // Correct
            [selected.el, btn].forEach(el => { el.classList.remove('match-selected'); el.classList.add('match-correct'); el.disabled = true; });
            matched.add(termIdx);
            if (matched.size === pairs.length) {
              const sc = document.getElementById('match-score');
              sc.style.display = 'block';
              sc.innerHTML = '<strong style="color:#276749">All pairs matched! Well done.</strong>';
            }
          } else {
            // Wrong
            [selected.el, btn].forEach(el => { el.classList.add('match-wrong'); });
            setTimeout(() => { [selected.el, btn].forEach(el => el.classList.remove('match-wrong', 'match-selected')); }, 800);
          }
          selected = null;
        }
      });
    });
  }

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card" id="match-card">
        <div class="quiz-intro">
          <div class="quiz-resource-tag" aria-hidden="true">⇄ Matching</div>
          <h3 class="quiz-title">${escHtml(name)}</h3>
          <p class="quiz-meta">${pairs.length} pairs · ${diffLabel}</p>
          <button class="btn-start" id="match-start-btn">Start Matching</button>
        </div>
      </div>
    </div>`;

  document.getElementById('match-start-btn').addEventListener('click', buildGame);
}

// ─────────────────────────────────────────────
//  SHORT ANSWER PLAYER
// ─────────────────────────────────────────────

function renderShortAnswerPlayer() {
  const pane = document.getElementById('preview-pane');
  const { questions, resource, difficulty } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;

  let currentQ = 0;
  let revealed = false;

  function renderQ() {
    const q = questions[currentQ];
    pane.querySelector('.quiz-card').innerHTML = `
      <div style="padding:24px">
        <div class="quiz-resource-tag" aria-hidden="true">✎ Short Answer</div>
        <div class="quiz-progress-bar-wrap">
          <div class="quiz-progress-label"><span>Question ${currentQ + 1} of ${questions.length}</span></div>
          <div class="quiz-progress-track" role="progressbar" aria-valuenow="${Math.round(((currentQ+1)/questions.length)*100)}" aria-valuemin="0" aria-valuemax="100">
            <div class="quiz-progress-fill" style="width:${Math.round(((currentQ+1)/questions.length)*100)}%"></div>
          </div>
        </div>
        <div class="quiz-question-wrap">
          <p class="question-text">${escHtml(q.question)}</p>
          ${q.hint ? `<p class="field-hint" style="margin-top:8px">Hint: ${escHtml(q.hint)}</p>` : ''}
        </div>
        <textarea class="objective-field" id="sa-input" placeholder="Type your answer here…" style="margin-top:16px;min-height:100px" aria-label="Your answer"></textarea>
        <div class="quiz-actions" style="margin-top:12px">
          <button class="btn-check" id="sa-reveal-btn">Show Model Answer</button>
        </div>
        <div id="sa-model" style="display:none;margin-top:16px;padding:14px;background:var(--success-bg);border:1px solid #b7e0ca;border-radius:8px;">
          <strong style="color:var(--success);font-size:.75rem;text-transform:uppercase;letter-spacing:.06em">Model Answer</strong>
          <p style="margin-top:6px;font-size:.88rem;line-height:1.6;color:var(--ink-mid)">${escHtml(q.modelAnswer)}</p>
          <div class="fib-actions" style="margin-top:12px;justify-content:flex-end">
            ${currentQ + 1 < questions.length
              ? `<button class="btn-next" id="sa-next-btn" style="display:block">Next Question →</button>`
              : `<button class="btn-next" id="sa-done-btn" style="display:block">Finish</button>`}
          </div>
        </div>
      </div>`;

    document.getElementById('sa-reveal-btn').addEventListener('click', () => {
      document.getElementById('sa-model').style.display = 'block';
      document.getElementById('sa-reveal-btn').style.display = 'none';
    });

    const nextBtn = document.getElementById('sa-next-btn');
    if (nextBtn) nextBtn.addEventListener('click', () => { currentQ++; renderQ(); });

    const doneBtn = document.getElementById('sa-done-btn');
    if (doneBtn) doneBtn.addEventListener('click', () => {
      pane.querySelector('.quiz-card').innerHTML = `
        <div style="padding:32px;text-align:center">
          <div class="quiz-resource-tag" aria-hidden="true">✎ Short Answer</div>
          <h3 class="quiz-title" style="margin-top:12px">All Questions Complete</h3>
          <p class="quiz-meta" style="margin-top:8px">${questions.length} questions reviewed</p>
          <button class="btn-start" style="margin-top:20px" id="sa-restart-btn">Start Again</button>
        </div>`;
      document.getElementById('sa-restart-btn').addEventListener('click', () => { currentQ = 0; renderQ(); });
    });
  }

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card" id="sa-card">
        <div class="quiz-intro">
          <div class="quiz-resource-tag" aria-hidden="true">✎ Short Answer</div>
          <h3 class="quiz-title">${escHtml(name)}</h3>
          <p class="quiz-meta">${questions.length} questions · ${diffLabel}</p>
          <button class="btn-start" id="sa-start-btn">Start</button>
        </div>
      </div>
    </div>`;

  document.getElementById('sa-start-btn').addEventListener('click', renderQ);
}

// ─────────────────────────────────────────────
//  ORDERING PLAYER
// ─────────────────────────────────────────────

function renderOrderingPlayer() {
  const pane = document.getElementById('preview-pane');
  const { sequence, resource, difficulty } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;
  const items = sequence.items || [];

  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }

  function buildGame() {
    let order = shuffle(items.map((it, i) => i)); // shuffled indices into items[]
    let dragging = null;

    const listId = 'ord-list';

    function renderList() {
      return order.map((realIdx, pos) => `
        <div class="ord-item" draggable="true" data-pos="${pos}" data-real="${realIdx}">
          <span class="ord-handle">⠿</span>
          <span>${escHtml(items[realIdx].text)}</span>
        </div>`).join('');
    }

    pane.querySelector('.quiz-card').innerHTML = `
      <div style="padding:24px">
        <div class="quiz-resource-tag" aria-hidden="true">≡ Ordering</div>
        <h3 class="quiz-title">${escHtml(sequence.title || name)}</h3>
        <p class="quiz-meta" style="margin-bottom:12px">${escHtml(sequence.instruction || 'Drag the items into the correct order.')}</p>
        <div class="ord-list" id="${listId}">${renderList()}</div>
        <div class="fib-actions" style="margin-top:16px">
          <button class="btn-check" id="ord-check-btn">Check Order</button>
          <button class="btn-next" id="ord-reset-btn" style="display:none">Try Again</button>
        </div>
        <div class="fib-score" id="ord-result" style="display:none"></div>
      </div>`;

    function wireOrd() {
      const listEl = document.getElementById(listId);
      listEl.querySelectorAll('.ord-item').forEach(item => {
        item.addEventListener('dragstart', e => { dragging = item; item.style.opacity = '0.4'; });
        item.addEventListener('dragend', () => { dragging = null; item.style.opacity = ''; });
        item.addEventListener('dragover', e => { e.preventDefault(); });
        item.addEventListener('drop', e => {
          e.preventDefault();
          if (dragging && dragging !== item) {
            const fromPos = parseInt(dragging.dataset.pos);
            const toPos = parseInt(item.dataset.pos);
            const tmp = order[fromPos]; order[fromPos] = order[toPos]; order[toPos] = tmp;
            listEl.innerHTML = renderList();
            wireOrd();
          }
        });
      });
    }

    wireOrd();

    document.getElementById('ord-check-btn').addEventListener('click', () => {
      const listEl = document.getElementById(listId);
      let allCorrect = true;
      listEl.querySelectorAll('.ord-item').forEach((el, pos) => {
        const realIdx = parseInt(el.dataset.real);
        const correctPos = items[realIdx].order - 1; // 0-based
        if (pos === correctPos) { el.classList.add('match-correct'); }
        else { el.classList.add('match-wrong'); allCorrect = false; }
        el.setAttribute('draggable', 'false');
      });
      document.getElementById('ord-check-btn').style.display = 'none';
      document.getElementById('ord-reset-btn').style.display = '';
      const res = document.getElementById('ord-result');
      res.style.display = 'block';
      res.innerHTML = allCorrect
        ? '<strong style="color:#276749">Perfect order! Well done.</strong>'
        : '<strong style="color:#9b2335">Not quite right. Check the highlighted items, then try again.</strong>';
    });

    document.getElementById('ord-reset-btn').addEventListener('click', () => buildGame());
  }

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card" id="ord-card">
        <div class="quiz-intro">
          <div class="quiz-resource-tag" aria-hidden="true">≡ Ordering</div>
          <h3 class="quiz-title">${escHtml(sequence.title || name)}</h3>
          <p class="quiz-meta">${items.length} items · ${diffLabel} — drag to reorder</p>
          <button class="btn-start" id="ord-start-btn">Start</button>
        </div>
      </div>
    </div>`;

  document.getElementById('ord-start-btn').addEventListener('click', buildGame);
}

// ─────────────────────────────────────────────
//  SCENARIO / CASE PLAYER
// ─────────────────────────────────────────────

function renderScenarioPlayer() {
  const pane = document.getElementById('preview-pane');
  const { scenarios, resource, difficulty } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;

  let currentS = 0;

  function renderScenario() {
    const s = scenarios[currentS];
    pane.querySelector('.quiz-card').innerHTML = `
      <div style="padding:24px">
        <div class="quiz-resource-tag" aria-hidden="true">◈ Scenario / Case</div>
        <div class="quiz-progress-bar-wrap">
          <div class="quiz-progress-label"><span>Scenario ${currentS + 1} of ${scenarios.length}</span></div>
          <div class="quiz-progress-track" role="progressbar" aria-valuenow="${Math.round(((currentS+1)/scenarios.length)*100)}" aria-valuemin="0" aria-valuemax="100">
            <div class="quiz-progress-fill" style="width:${Math.round(((currentS+1)/scenarios.length)*100)}%"></div>
          </div>
        </div>
        <div style="background:rgba(0,56,101,0.05);border-left:3px solid var(--navy-mid);padding:12px 14px;border-radius:0 6px 6px 0;margin:16px 0 12px;font-size:.88rem;line-height:1.6;color:var(--ink-mid)">
          <strong style="display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.07em;color:var(--ink-faint);margin-bottom:4px">Scenario</strong>
          ${escHtml(s.scenario)}
        </div>
        <p class="question-text">${escHtml(s.question)}</p>
        <textarea class="objective-field" id="sc-input" placeholder="Write your response here…" style="margin-top:16px;min-height:100px" aria-label="Your response"></textarea>
        <div class="quiz-actions" style="margin-top:12px">
          <button class="btn-check" id="sc-reveal-btn">Show Guideline Response</button>
        </div>
        <div id="sc-guideline" style="display:none;margin-top:16px;padding:14px;background:var(--success-bg);border:1px solid #b7e0ca;border-radius:8px;">
          <strong style="color:var(--success);font-size:.75rem;text-transform:uppercase;letter-spacing:.06em">Guideline Response</strong>
          <p style="margin-top:6px;font-size:.88rem;line-height:1.6;color:var(--ink-mid)">${escHtml(s.guideline)}</p>
          <div class="fib-actions" style="margin-top:12px;justify-content:flex-end">
            ${currentS + 1 < scenarios.length
              ? `<button class="btn-next" id="sc-next-btn" style="display:block">Next Scenario →</button>`
              : `<button class="btn-next" id="sc-done-btn" style="display:block">Finish</button>`}
          </div>
        </div>
      </div>`;

    document.getElementById('sc-reveal-btn').addEventListener('click', () => {
      document.getElementById('sc-guideline').style.display = 'block';
      document.getElementById('sc-reveal-btn').style.display = 'none';
    });
    const nextBtn = document.getElementById('sc-next-btn');
    if (nextBtn) nextBtn.addEventListener('click', () => { currentS++; renderScenario(); });
    const doneBtn = document.getElementById('sc-done-btn');
    if (doneBtn) doneBtn.addEventListener('click', () => {
      pane.querySelector('.quiz-card').innerHTML = `
        <div style="padding:32px;text-align:center">
          <div class="quiz-resource-tag" aria-hidden="true">◈ Scenario / Case</div>
          <h3 class="quiz-title" style="margin-top:12px">All Scenarios Complete</h3>
          <p class="quiz-meta" style="margin-top:8px">${scenarios.length} scenarios reviewed</p>
          <button class="btn-start" style="margin-top:20px" id="sc-restart-btn">Start Again</button>
        </div>`;
      document.getElementById('sc-restart-btn').addEventListener('click', () => { currentS = 0; renderScenario(); });
    });
  }

  pane.innerHTML = `
    <div class="quiz-player">
      <div class="quiz-card" id="sc-card">
        <div class="quiz-intro">
          <div class="quiz-resource-tag" aria-hidden="true">◈ Scenario / Case</div>
          <h3 class="quiz-title">${escHtml(name)}</h3>
          <p class="quiz-meta">${scenarios.length} scenarios · ${diffLabel}</p>
          <button class="btn-start" id="sc-start-btn">Start</button>
        </div>
      </div>
    </div>`;

  document.getElementById('sc-start-btn').addEventListener('click', renderScenario);
}

// ─────────────────────────────────────────────
//  BRANCHING SCENARIO PLAYER
//  Uses window._bs to hold all mutable state so
//  inline onclick="..." handlers always reach it.
// ─────────────────────────────────────────────

function bsDecide(i) {
  const bs = window._bs;
  if (bs.answered) return;
  bs.answered = true;

  const node = bs.nodes.find(n => n.id === bs.currentNodeId);
  const dec = node.decisions[i];

  // Record path
  bs.visitedPath.push({ nodeId: bs.currentNodeId, decisionIdx: i, decisionText: dec.text, nextId: dec.next });

  // Update buttons
  document.querySelectorAll('.btn-decision').forEach((b, idx) => {
    b.disabled = true;
    b.classList.toggle('chosen', idx === i);
  });

  // Show feedback
  const fb = document.getElementById('bs-fb');
  if (fb) {
    fb.innerHTML = '<strong>Consequence</strong> ' + escHtml(dec.feedback || '(no feedback)');
    fb.style.display = 'block';
  }

  // Show continue
  const cont = document.getElementById('bs-cont');
  const nxt  = document.getElementById('bs-next');
  if (cont) cont.style.display = 'flex';
  if (nxt)  nxt.style.display  = 'inline-block';

  // Store next destination
  bs.pendingNext = dec.next;
}

function bsNext() {
  const bs = window._bs;
  bs.currentNodeId = bs.pendingNext;
  bs.answered = false;
  bsShowStep();
}

function bsRestart() {
  const bs = window._bs;
  bs.visitedPath = [];
  bs.currentNodeId = 0;
  bs.answered = false;
  state.generatedData.visitedPath = [];
  bsShowStep();
}

function bsShowStep() {
  const bs     = window._bs;
  const nodes  = bs.nodes;
  const node   = nodes.find(n => n.id === bs.currentNodeId);
  const pane   = document.getElementById('preview-pane');
  if (!node || !pane) return;

  const totalNodes = nodes.length;
  const pct = Math.min(100, Math.round(
    (new Set(bs.visitedPath.map(s => s.nodeId)).size / totalNodes) * 100
  ));

  // ── Terminal node ──
  if (node.decisions.length === 0) {
    const pathHtml = bs.visitedPath.map((s, idx) =>
      `<div class="branch-path-step"><span class="branch-path-num">${idx+1}.</span> <span>${escHtml(s.decisionText)}</span></div>`
    ).join('');

    pane.innerHTML =
      `<div class="quiz-player"><div class="quiz-card"><div class="branch-terminal">
        <div class="branch-terminal-icon">◉</div>
        <div class="quiz-resource-tag" style="margin-bottom:10px">⑂ Outcome Reached</div>
        <h3 class="quiz-title" style="margin-bottom:8px">You've reached an outcome</h3>
        <div class="scenario-box" style="text-align:left;margin-top:12px">
          <strong>Final Scenario</strong> ${escHtml(node.scenario)}
        </div>
        ${bs.visitedPath.length > 0 ? `<div class="branch-path-summary">
          <h4>Your Path (${bs.visitedPath.length} decision${bs.visitedPath.length !== 1 ? 's' : ''})</h4>
          ${pathHtml}
        </div>` : ''}
        <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap">
          <button class="btn-start" onclick="bsRestart()">Try a Different Path</button>
          <button class="btn-start" onclick="state.generatedData.visitedPath=[...window._bs.visitedPath];activateTab('treemap')">View Tree Map →</button>
        </div>
      </div></div></div>`;
    return;
  }

  // ── Decision node ──
  const decisionsHtml = node.decisions.map((d, i) =>
    `<button class="btn-decision" data-i="${i}" onclick="bsDecide(${i})">${escHtml(d.text)}</button>`
  ).join('');

  pane.innerHTML =
    `<div class="quiz-player"><div class="quiz-card"><div style="padding:24px">
      <div class="quiz-resource-tag">⑂ Branching Scenario</div>
      <div class="quiz-progress-bar-wrap" style="margin-top:10px">
        <div class="quiz-progress-label">
          <span>Step ${bs.visitedPath.length + 1}</span>
          <span>${pct}% explored</span>
        </div>
        <div class="quiz-progress-track">
          <div class="quiz-progress-fill" style="width:${pct}%"></div>
        </div>
      </div>
      <div class="scenario-box"><strong>Situation</strong> ${escHtml(node.scenario)}</div>
      <p style="font-size:0.78rem;font-weight:600;text-transform:uppercase;letter-spacing:0.07em;color:var(--ink-faint);margin-bottom:10px">What do you do?</p>
      <div class="decision-options">${decisionsHtml}</div>
      <div id="bs-fb" style="display:none" class="branch-feedback"></div>
      <div id="bs-cont" style="display:none;margin-top:14px;justify-content:flex-end">
        <button id="bs-next" class="btn-start" style="margin-top:0" onclick="bsNext()">Continue →</button>
      </div>
    </div></div></div>`;
}

function renderBranchScenarioPlayer() {
  const { nodes, resource, difficulty } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;
  const terminalCount = nodes.filter(n => n.decisions.length === 0).length;
  const totalNodes = nodes.length;

  // Initialise global player state
  window._bs = { nodes, visitedPath: [], currentNodeId: 0, answered: false, pendingNext: null };

  const pane = document.getElementById('preview-pane');
  pane.innerHTML =
    `<div class="quiz-player"><div class="quiz-card"><div class="quiz-intro">
      <div class="quiz-resource-tag">⑂ Branching Scenario</div>
      <h3 class="quiz-title">${escHtml(name)}</h3>
      <p class="quiz-meta">${totalNodes} nodes · ${terminalCount} possible outcome${terminalCount !== 1 ? 's' : ''} · ${diffLabel}</p>
      <p style="font-size:0.82rem;color:var(--ink-faint);max-width:340px;margin:0 auto 20px;line-height:1.5">
        Make decisions at each step. Your choices lead to different outcomes based on the content.
      </p>
      <button class="btn-start" onclick="bsShowStep()">Begin Scenario</button>
    </div></div></div>`;
}

// ─────────────────────────────────────────────
//  BRANCH TREE MAP
// ─────────────────────────────────────────────

function renderBranchTreeMap() {
  const pane = document.getElementById('treemap-pane');
  const { nodes, resource, visitedPath = [] } = state.generatedData;
  const name = resource.name || resource.title || 'Resource';

  if (!nodes || nodes.length === 0) {
    pane.innerHTML = `<div class="empty-state"><p class="empty-desc">No nodes to display.</p></div>`;
    return;
  }

  // Build visited set for highlighting
  const visitedNodeIds = new Set(visitedPath.map(s => s.nodeId));
  if (visitedPath.length > 0) visitedNodeIds.add(visitedPath[visitedPath.length - 1].nextId);
  const visitedEdges = new Set(visitedPath.map(s => `${s.nodeId}-${s.nextId}`));

  // Layout: assign levels (BFS from node 0)
  const levels = {};
  const queue = [{ id: 0, level: 0 }];
  const seen = new Set([0]);
  while (queue.length) {
    const { id, level } = queue.shift();
    if (levels[id] === undefined || levels[id] > level) levels[id] = level;
    const node = nodes.find(n => n.id === id);
    if (node) {
      node.decisions.forEach(d => {
        if (!seen.has(d.next)) { seen.add(d.next); queue.push({ id: d.next, level: level + 1 }); }
        else if ((levels[d.next] || 0) < level + 1) { levels[d.next] = level + 1; }
      });
    }
  }

  // Group nodes by level
  const byLevel = {};
  nodes.forEach(n => {
    const lv = levels[n.id] ?? 0;
    if (!byLevel[lv]) byLevel[lv] = [];
    byLevel[lv].push(n.id);
  });

  const maxLevel = Math.max(...Object.keys(byLevel).map(Number));
  const NODE_W = 160, NODE_H = 60, H_GAP = 30, V_GAP = 80, PAD = 40;

  // Assign x/y positions
  const pos = {};
  for (let lv = 0; lv <= maxLevel; lv++) {
    const group = byLevel[lv] || [];
    const totalW = group.length * NODE_W + (group.length - 1) * H_GAP;
    group.forEach((nid, i) => {
      pos[nid] = {
        x: PAD + i * (NODE_W + H_GAP) + (totalW < (nodes.length * (NODE_W + H_GAP) / 2) ? (nodes.length * (NODE_W + H_GAP) / 2 - totalW) / 2 : 0),
        y: PAD + lv * (NODE_H + V_GAP),
      };
    });
  }

  const svgW = Math.max(...nodes.map(n => (pos[n.id]?.x || 0) + NODE_W + PAD));
  const svgH = PAD + (maxLevel + 1) * (NODE_H + V_GAP) + PAD;

  // Build edges SVG
  let edgeSvg = '';
  nodes.forEach(node => {
    node.decisions.forEach(dec => {
      const from = pos[node.id];
      const to = pos[dec.next];
      if (!from || !to) return;
      const x1 = from.x + NODE_W / 2, y1 = from.y + NODE_H;
      const x2 = to.x + NODE_W / 2,   y2 = to.y;
      const mid = (y1 + y2) / 2;
      const edgeKey = `${node.id}-${dec.next}`;
      const isVisited = visitedEdges.has(edgeKey);
      const stroke = isVisited ? 'var(--gold)' : 'var(--border)';
      const strokeW = isVisited ? 2.5 : 1.5;
      // Truncate label
      const label = dec.text.length > 22 ? dec.text.slice(0, 21) + '…' : dec.text;
      edgeSvg += `
        <path d="M${x1},${y1} C${x1},${mid} ${x2},${mid} ${x2},${y2}"
          fill="none" stroke="${stroke}" stroke-width="${strokeW}" stroke-dasharray="${isVisited ? '' : '4,3'}"/>
        <text x="${(x1+x2)/2}" y="${mid - 4}" text-anchor="middle"
          font-family="DM Sans, sans-serif" font-size="10" fill="${isVisited ? 'var(--gold-dark)' : 'var(--ink-faint)'}">${escHtml(label)}</text>`;
    });
  });

  // Build node boxes SVG
  let nodeSvg = '';
  nodes.forEach(node => {
    const p = pos[node.id];
    if (!p) return;
    const isTerminal = node.decisions.length === 0;
    const isVisited = visitedNodeIds.has(node.id);
    const isStart = node.id === 0;
    const fill = isStart ? 'var(--navy)' : isTerminal ? 'var(--gold-pale)' : isVisited ? 'rgba(0,56,101,0.06)' : 'var(--white)';
    const stroke = isStart ? 'var(--navy)' : isTerminal ? 'var(--gold)' : isVisited ? 'var(--navy-mid)' : 'var(--border)';
    const textCol = isStart ? '#fff' : 'var(--ink-mid)';
    const truncText = node.scenario.length > 50 ? node.scenario.slice(0, 49) + '…' : node.scenario;
    nodeSvg += `
      <g class="bmap-node" data-node-id="${node.id}" style="cursor:pointer" tabindex="0" role="button" aria-label="Node ${node.id}">
        <rect x="${p.x}" y="${p.y}" width="${NODE_W}" height="${NODE_H}"
          rx="8" fill="${fill}" stroke="${stroke}" stroke-width="${isVisited ? 2 : 1.5}"/>
        ${isTerminal ? `<rect x="${p.x}" y="${p.y}" width="${NODE_W}" height="4" rx="2" fill="var(--gold)"/>` : ''}
        ${isStart ? `<rect x="${p.x}" y="${p.y + NODE_H - 4}" width="${NODE_W}" height="4" rx="2" fill="var(--gold)"/>` : ''}
        <text x="${p.x + NODE_W/2}" y="${p.y + 16}" text-anchor="middle"
          font-family="DM Sans, sans-serif" font-size="10" font-weight="700"
          fill="${isStart ? 'rgba(255,255,255,0.6)' : 'var(--ink-faint)'}" letter-spacing="0.05em">
          ${isStart ? 'START' : isTerminal ? 'END' : `NODE ${node.id}`}
        </text>
        <foreignObject x="${p.x + 8}" y="${p.y + 22}" width="${NODE_W - 16}" height="${NODE_H - 28}">
          <div xmlns="http://www.w3.org/1999/xhtml" style="font-family:DM Sans,sans-serif;font-size:10px;color:${textCol};line-height:1.35;overflow:hidden;height:100%">
            ${escHtml(truncText)}
          </div>
        </foreignObject>
      </g>`;
  });

  pane.innerHTML = `
    <div class="branch-map-wrap">
      <h3 class="branch-map-title">Decision Tree Map</h3>
      <p class="branch-map-hint">Click any node to see its full text. ${visitedPath.length > 0 ? 'Your path is highlighted in gold.' : 'Play through the scenario to see your path highlighted.'}</p>
      <div class="branch-map-svg-wrap" id="branch-svg-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" width="${svgW}" height="${svgH}" role="img" aria-label="Branching scenario decision tree">
          <defs>
            <marker id="arr" markerWidth="8" markerHeight="8" refX="4" refY="3" orient="auto">
              <path d="M0,0 L0,6 L8,3 z" fill="var(--border)"/>
            </marker>
          </defs>
          <g id="edges">${edgeSvg}</g>
          <g id="nodes">${nodeSvg}</g>
        </svg>
      </div>
      <div class="branch-detail-panel" id="branch-detail" style="display:none">
        <h4 id="branch-detail-label">Node Detail</h4>
        <p class="branch-detail-scenario" id="branch-detail-scenario"></p>
        <div class="branch-detail-decisions" id="branch-detail-decisions"></div>
      </div>
    </div>`;

  // Wire node click for detail panel
  pane.querySelectorAll('.bmap-node').forEach(el => {
    const handler = () => {
      const nid = parseInt(el.dataset.nodeId);
      const node = nodes.find(n => n.id === nid);
      if (!node) return;
      const detail = document.getElementById('branch-detail');
      const label = document.getElementById('branch-detail-label');
      const scenario = document.getElementById('branch-detail-scenario');
      const decs = document.getElementById('branch-detail-decisions');
      label.textContent = node.id === 0 ? 'Start Node' : node.decisions.length === 0 ? 'End Node (Outcome)' : `Node ${node.id}`;
      scenario.textContent = node.scenario;
      decs.innerHTML = node.decisions.length === 0
        ? '<em style="color:var(--ink-faint);font-size:.8rem">Terminal node — no further decisions.</em>'
        : node.decisions.map(d => `<div class="branch-detail-decision">→ ${escHtml(d.text)} <span style="color:var(--ink-faint)">(→ Node ${d.next})</span></div>`).join('');
      detail.style.display = 'block';
      detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    };
    el.addEventListener('click', handler);
    el.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
  });
}

// ─────────────────────────────────────────────
//  JSON VIEW
// ─────────────────────────────────────────────

function buildH5PJson(data) {
  const { resource, difficulty, objective, activityType } = data;
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || 'Introductory';
  const title = (data.questionBank?.title) || resource.name || resource.title || 'Activity';
  const disc = resource.discipline || '';

  const meta = {
    authors: [{ name: 'TRU Open Press OER Activity Builder', role: 'Author' }],
    source: 'https://openpress.trubox.ca',
    license: 'CC BY',
    difficulty: diffLabel,
    discipline: disc,
  };

  // ── Quiz / Question Set ──
  if (!activityType || activityType === 'quiz') {
    const { questions } = data;
    const h5pQuestions = questions.map(q => ({
      library: 'H5P.MultiChoice 1.16',
      params: {
        question: q.text,
        answers: q.answers.map(a => ({
          text: a.text, correct: a.correct,
          tipsAndFeedback: { tip: '', chosenFeedback: a.feedback, notChosenFeedback: '' },
        })),
        behaviour: { enableRetry: true, enableSolutionsButton: true, singlePoint: false, randomAnswers: false },
        UI: { checkAnswerButton: 'Check', showSolutionButton: 'Show solution', tryAgainButton: 'Retry' },
      },
      subContentId: generateUUID(),
    }));
    return {
      library: 'H5P.QuestionSet 1.17',
      params: {
        introPage: { showIntroPage: true, startButtonText: 'Start Quiz',
          title: `${title} — ${diffLabel} Quiz`,
          introduction: objective || `Test your knowledge of ${title}. ${diffLabel}-level, ${questions.length} questions.` },
        progressType: 'dots', passPercentage: 50, disableBackwardsNavigation: false,
        randomQuestions: false, questions: h5pQuestions,
        endGame: { showResultPage: true, showSolutionButton: true, showRetryButton: true,
          noResultMessage: 'Finished', message: 'Quiz Complete!',
          overallFeedback: [
            { from: 0, to: 49, feedback: 'Keep practising — revisit the resource and try again.' },
            { from: 50, to: 79, feedback: 'Good effort! Review the questions you missed.' },
            { from: 80, to: 100, feedback: 'Excellent work! You have a strong grasp of this material.' },
          ],
          solutionButtonText: 'Show solution', retryButtonText: 'Retry', finishButtonText: 'Finish',
          showAnimations: false, skippable: false, skipButtonText: 'Skip video' },
        override: { checkButton: true },
      },
      metadata: { ...meta, title: `${title} Quiz`, contentType: 'Quiz (Question Set)' },
    };
  }

  // ── True / False ──
  if (activityType === 'truefalse') {
    const { items } = data;
    const h5pItems = items.map(item => ({
      library: 'H5P.TrueFalse 1.8',
      params: {
        question: item.statement,
        correct: item.correct ? 'True' : 'False',
        behaviour: { enableRetry: true, enableSolutionsButton: true, confirmCheckDialog: false },
        l10n: { trueText: 'True', falseText: 'False', score: 'Score', check: 'Check', showSolution: 'Show solution', retry: 'Retry' },
        feedbackOnCorrect: item.feedback,
        feedbackOnWrong: item.feedback,
      },
      subContentId: generateUUID(),
    }));
    return {
      library: 'H5P.QuestionSet 1.17',
      params: {
        introPage: { showIntroPage: true, startButtonText: 'Start', title: `${title} — True/False`,
          introduction: objective || `True or False statements from ${title}.` },
        progressType: 'dots', passPercentage: 50, disableBackwardsNavigation: false,
        randomQuestions: false, questions: h5pItems,
        endGame: { showResultPage: true, showSolutionButton: true, showRetryButton: true,
          message: 'Complete!', retryButtonText: 'Retry', finishButtonText: 'Finish',
          overallFeedback: [{ from: 0, to: 100, feedback: 'Well done!' }] },
        override: { checkButton: true },
      },
      metadata: { ...meta, title: `${title} — True/False`, contentType: 'True/False Question Set' },
    };
  }

  // ── Flashcards ──
  if (activityType === 'flashcards') {
    const { cards } = data;
    return {
      library: 'H5P.Flashcards 1.5',
      params: {
        description: objective || `Study flashcards for ${title}`,
        cards: cards.map(c => ({ text: c.front, answer: c.back })),
        behaviour: { scaleTextNotCard: false, randomCards: false },
        l10n: { next: 'Next', previous: 'Previous', checkAnswerText: 'Check my answer',
          showSolutionText: 'Show solution', tryAgainText: 'Try again',
          tipButtonLabel: 'Hint', cardFrontLabel: 'Front of card', cardBackLabel: 'Back of card' },
      },
      metadata: { ...meta, title: `${title} — Flashcards`, contentType: 'Flashcards' },
    };
  }

  // ── Fill in the Blanks ──
  if (activityType === 'fillblanks') {
    const { sentences } = data;
    // H5P.Blanks uses *answer* syntax for blanks
    const textField = sentences.map(s => s.text).join('\n');
    return {
      library: 'H5P.Blanks 1.14',
      params: {
        text: `<p>${objective || `Fill in the missing terms from ${title}.`}</p>`,
        questions: sentences.map(s => s.text),
        behaviour: { enableRetry: true, enableSolutionsButton: true, autoCheck: false,
          showSolutionsRequiresInput: true, caseSensitive: false },
        l10n: { showSolutions: 'Show solutions', tryAgain: 'Try again',
          checkAnswer: 'Check answers', submitAnswer: 'Submit',
          notFilledOut: 'Please fill in all blanks before checking.' },
        overallFeedback: [
          { from: 0, to: 49, feedback: 'Keep trying! Revisit the source material.' },
          { from: 50, to: 79, feedback: 'Good effort! A few more to review.' },
          { from: 80, to: 100, feedback: 'Excellent! You know this material well.' },
        ],
      },
      metadata: { ...meta, title: `${title} — Fill in the Blanks`, contentType: 'Fill in the Blanks' },
    };
  }

  // ── Matching ──
  if (activityType === 'matching') {
    const { pairs } = data;
    return {
      library: 'H5P.DragText 1.10',
      params: {
        taskDescription: `<p>${objective || `Match the terms to their definitions — ${title}.`}</p>`,
        textField: pairs.map(p => `*${p.term}* — ${p.definition}`).join('\n'),
        behaviour: { enableRetry: true, enableSolutionsButton: true, instantFeedback: false },
        l10n: { checkAnswer: 'Check', showSolution: 'Show solution', tryAgain: 'Retry',
          score: 'Score', feedback: 'Feedback' },
        overallFeedback: [
          { from: 0, to: 49, feedback: 'Keep practising!' },
          { from: 50, to: 79, feedback: 'Good effort!' },
          { from: 80, to: 100, feedback: 'Excellent work!' },
        ],
      },
      metadata: { ...meta, title: `${title} — Matching`, contentType: 'Drag Text (Matching)' },
    };
  }

  // ── Short Answer ──
  if (activityType === 'shortanswer') {
    const { questions } = data;
    const h5pItems = questions.map(q => ({
      library: 'H5P.OpenEndedQuestion 1.0',
      params: {
        question: q.question,
        placeholderText: q.hint || 'Type your answer here…',
        description: objective || `Reflect on the content from ${title}.`,
      },
      subContentId: generateUUID(),
    }));
    return {
      library: 'H5P.QuestionSet 1.17',
      params: {
        introPage: { showIntroPage: true, startButtonText: 'Start', title: `${title} — Short Answer`,
          introduction: objective || `Short-answer reflection questions from ${title}.` },
        progressType: 'dots', passPercentage: 0, disableBackwardsNavigation: false,
        randomQuestions: false, questions: h5pItems,
        endGame: { showResultPage: true, showRetryButton: true, message: 'Complete!',
          retryButtonText: 'Retry', finishButtonText: 'Finish',
          overallFeedback: [{ from: 0, to: 100, feedback: 'Well done for completing the reflection.' }] },
        override: { checkButton: false },
      },
      metadata: { ...meta, title: `${title} — Short Answer`, contentType: 'Short Answer Questions' },
    };
  }

  // ── Ordering ──
  if (activityType === 'ordering') {
    const { sequence } = data;
    const correctOrder = [...sequence.items].sort((a, b) => a.order - b.order);
    return {
      library: 'H5P.SortParagraphs 0.11',
      params: {
        description: sequence.instruction || objective || `Put these items in the correct order from ${title}.`,
        paragraphs: correctOrder.map(it => ({ text: it.text })),
        behaviour: { addPunctuation: false, duplicates: false },
        l10n: { checkAnswer: 'Check', showSolution: 'Show solution', tryAgain: 'Retry',
          score: 'Score', feedback: 'Feedback', resultLabel: 'Your result:' },
        overallFeedback: [
          { from: 0, to: 49, feedback: 'Keep practising!' },
          { from: 50, to: 79, feedback: 'Good effort!' },
          { from: 80, to: 100, feedback: 'Perfect order!' },
        ],
      },
      metadata: { ...meta, title: `${title} — Ordering`, contentType: 'Sort Paragraphs (Ordering)' },
    };
  }

  // ── Scenario / Case ──
  if (activityType === 'scenario') {
    const { scenarios } = data;
    const h5pScenarios = scenarios.map(s => ({
      library: 'H5P.OpenEndedQuestion 1.0',
      params: {
        question: `<strong>Scenario:</strong> ${s.scenario}<br><br>${s.question}`,
        placeholderText: 'Write your analysis here…',
        description: objective || `Apply concepts from ${title} to real-world scenarios.`,
      },
      subContentId: generateUUID(),
    }));
    return {
      library: 'H5P.QuestionSet 1.17',
      params: {
        introPage: { showIntroPage: true, startButtonText: 'Start', title: `${title} — Scenarios`,
          introduction: objective || `Scenario-based case study questions from ${title}.` },
        progressType: 'dots', passPercentage: 0, disableBackwardsNavigation: false,
        randomQuestions: false, questions: h5pScenarios,
        endGame: { showResultPage: true, showRetryButton: true, message: 'Complete!',
          retryButtonText: 'Retry', finishButtonText: 'Finish',
          overallFeedback: [{ from: 0, to: 100, feedback: 'Good work on the scenarios!' }] },
        override: { checkButton: false },
      },
      metadata: { ...meta, title: `${title} — Scenarios`, contentType: 'Scenario / Case Study' },
    };
  }

  // ── Branching Scenario ──
  if (activityType === 'branchscenario') {
    const { nodes } = data;
    const terminalNodes = nodes.filter(n => n.decisions.length === 0);

    // Map each non-terminal node to H5P.BranchingQuestion content
    const content = nodes.map(node => {
      if (node.decisions.length === 0) {
        // Terminal node → no content block (handled as endScreen)
        return null;
      }
      return {
        type: {
          library: 'H5P.BranchingQuestion 1.0',
          params: {
            branchingQuestion: {
              question: `<p>${node.scenario}</p>`,
              alternatives: node.decisions.map(d => ({
                text: d.text,
                nextContentId: d.next,
                feedback: {
                  title: 'Consequence',
                  subtitle: d.feedback,
                },
              })),
            },
          },
          subContentId: generateUUID(),
          metadata: { title: `Node ${node.id}`, license: 'CC BY' },
        },
        contentId: node.id,
        nextContentId: node.decisions[0]?.next ?? -1,
      };
    }).filter(Boolean);

    const endScreens = terminalNodes.map(n => ({
      endScreenTitle: 'Outcome Reached',
      endScreenSubtitle: n.scenario,
      contentId: n.id,
      endScreenScore: 0,
    }));

    return {
      library: 'H5P.BranchingScenario 1.7',
      params: {
        branchingScenario: {
          startScreen: {
            startScreenTitle: title,
            startScreenSubtitle: objective || `An interactive branching scenario from ${title}.`,
          },
          endScreens,
          content,
          behaviour: { enableBackwardsNavigation: false, forceContentFinished: true },
          l10n: {
            startScreenButtonText: 'Begin',
            endScreenButtonText: 'Restart',
            backButtonText: 'Back',
            proceedButtonText: 'Continue',
            scoreText: 'Your score:',
          },
        },
      },
      metadata: { ...meta, title: `${title} — Branching Scenario`, contentType: 'Branching Scenario' },
    };
  }

  return { error: 'Unknown activity type', activityType };
}

function syntaxHighlight(json) {
  const str = typeof json === 'string' ? json : JSON.stringify(json, null, 2);
  return str
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
      let cls = 'json-num';
      if (/^"/.test(match)) {
        cls = /:$/.test(match) ? 'json-key' : 'json-string';
      } else if (/true|false/.test(match)) {
        cls = 'json-bool';
      }
      return `<span class="${cls}">${match}</span>`;
    });
}

function renderJsonView() {
  const pane = document.getElementById('json-pane');
  const h5p = buildH5PJson(state.generatedData);
  const jsonStr = JSON.stringify(h5p, null, 2);
  const libName = h5p.library || 'H5P';
  const title = state.generatedData.questionBank?.title || state.generatedData.resource?.name || state.generatedData.resource?.title || 'Activity';

  const notice = state.generatedData.isDemo
    ? `<div class="demo-notice" style="max-width:760px;margin:0 auto 20px;">
        <span class="demo-notice-icon" aria-hidden="true">⚠</span>
        <span><strong>Demo content:</strong> Showing sample H5P JSON for Introduction to Ethics.</span>
       </div>`
    : '';

  pane.innerHTML = `
    ${notice}
    <div class="json-view" style="max-width:760px;margin:0 auto;">
      <div class="json-toolbar">
        <span class="json-title">${escHtml(libName)} — ${escHtml(title)}</span>
        <button class="json-copy-btn" id="copy-json-btn" aria-label="Copy JSON to clipboard">Copy JSON</button>
      </div>
      <div class="json-body">
        <pre id="json-pre" tabindex="0" aria-label="H5P JSON output">${syntaxHighlight(h5p)}</pre>
      </div>
    </div>`;

  document.getElementById('copy-json-btn').addEventListener('click', () => {
    navigator.clipboard.writeText(jsonStr).then(() => {
      const btn = document.getElementById('copy-json-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy JSON'; }, 1800);
    });
  });
}

// ─────────────────────────────────────────────
//  DOWNLOADS
// ─────────────────────────────────────────────

function downloadJSON() {
  if (!state.generatedData) return;
  const h5p = buildH5PJson(state.generatedData);
  const blob = new Blob([JSON.stringify(h5p, null, 2)], { type: 'application/json' });
  triggerDownload(blob, `${safeFilename(state.generatedData.resource)}-quiz-h5p.json`);
}

// ─────────────────────────────────────────────
//  MOODLE GIFT EXPORT
// ─────────────────────────────────────────────

function buildGIFT(data) {
  const { activityType, resource, difficulty } = data;
  const title = (data.questionBank?.title) || resource.name || resource.title || 'Activity';
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty] || difficulty;

  // Escape GIFT special characters: ~, =, #, {, }, :
  function escGift(str) {
    return String(str || '').replace(/([~=#{}:\\])/g, '\\$1');
  }

  const lines = [];
  lines.push(`// GIFT format export — ${title} (${diffLabel})`);
  lines.push(`// Generated by TRU Open Press OER Activity Builder`);
  lines.push(`// Import this file in Moodle: Question bank → Import → GIFT format`);
  lines.push('');

  if (!activityType || activityType === 'quiz') {
    const { questions } = data;
    questions.forEach((q, i) => {
      const correct = q.answers.find(a => a.correct);
      const wrongs = q.answers.filter(a => !a.correct);
      lines.push(`// Question ${i + 1}`);
      lines.push(`::Q${i + 1}::${escGift(q.text)} {`);
      lines.push(`  =${escGift(correct?.text || '')}${correct?.feedback ? ' # ' + escGift(correct.feedback) : ''}`);
      wrongs.forEach(w => {
        lines.push(`  ~${escGift(w.text)}${w.feedback ? ' # ' + escGift(w.feedback) : ''}`);
      });
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'truefalse') {
    const { items } = data;
    items.forEach((item, i) => {
      lines.push(`// Statement ${i + 1}`);
      lines.push(`::TF${i + 1}::${escGift(item.statement)} {`);
      lines.push(`  ${item.correct ? 'TRUE' : 'FALSE'}${item.feedback ? ' # ' + escGift(item.feedback) : ''}`);
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'flashcards') {
    const { cards } = data;
    cards.forEach((c, i) => {
      lines.push(`// Flashcard ${i + 1} (Short Answer)`);
      lines.push(`::FC${i + 1}::${escGift(c.front)} {`);
      lines.push(`  =${escGift(c.back)}`);
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'fillblanks') {
    const { sentences } = data;
    sentences.forEach((s, i) => {
      // Convert *answer* to GIFT short-answer format
      const questionText = s.text.replace(/\*([^*]+)\*/g, '{=\\$1}');
      lines.push(`// Fill-in-the-Blank ${i + 1}`);
      lines.push(`::FIB${i + 1}::${escGift(s.text.replace(/\*([^*]+)\*/g, '___'))} {`);
      lines.push(`  =${escGift(s.answer)}`);
      if (s.hint) lines.push(`  // Hint: ${escGift(s.hint)}`);
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'matching') {
    const { pairs } = data;
    lines.push(`// Matching exercise — exported as individual short-answer questions`);
    pairs.forEach((p, i) => {
      lines.push(`::M${i + 1}::${escGift(p.term)} {`);
      lines.push(`  =${escGift(p.definition)}`);
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'shortanswer') {
    const { questions } = data;
    questions.forEach((q, i) => {
      lines.push(`// Short Answer ${i + 1} — model answer shown as correct response`);
      lines.push(`::SA${i + 1}::${escGift(q.question)} {`);
      // GIFT essay type — no autograding, just model answer comment
      lines.push(`  // Model answer: ${escGift(q.modelAnswer)}`);
      if (q.hint) lines.push(`  // Hint: ${escGift(q.hint)}`);
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'ordering') {
    const { sequence } = data;
    lines.push(`// Ordering exercise — exported as multiple-choice (correct order)`);
    lines.push(`::ORD1::${escGift(sequence.instruction || sequence.title)} {`);
    const sorted = [...sequence.items].sort((a, b) => a.order - b.order);
    sorted.forEach((it, i) => {
      lines.push(`  ${i === 0 ? '=' : '~'}${escGift(`${i + 1}. ${it.text}`)}`);
    });
    lines.push('}');
    lines.push('');
    return lines.join('\n');
  }

  if (activityType === 'scenario') {
    const { scenarios } = data;
    scenarios.forEach((s, i) => {
      lines.push(`// Scenario ${i + 1} — exported as essay (manually graded in Moodle)`);
      lines.push(`::SC${i + 1}::Scenario: ${escGift(s.scenario)}\\n\\n${escGift(s.question)} {`);
      lines.push(`  // Guideline response: ${escGift(s.guideline)}`);
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  if (activityType === 'branchscenario') {
    const { nodes } = data;
    lines.push(`// Branching Scenario — exported as decision-point multiple-choice questions`);
    lines.push(`// Import into Moodle and arrange as a lesson for interactive branching`);
    lines.push('');
    nodes.forEach((node, i) => {
      if (node.decisions.length === 0) {
        // Terminal node — export as descriptive essay
        lines.push(`// Node ${node.id} — Terminal Outcome`);
        lines.push(`::BS_END${node.id}::OUTCOME: ${escGift(node.scenario)} { // (Terminal — no further decisions) }`);
        lines.push('');
        return;
      }
      lines.push(`// Node ${node.id}`);
      lines.push(`::BS${node.id}::${escGift(node.scenario)} {`);
      node.decisions.forEach((d, di) => {
        const marker = di === 0 ? '=' : '~';
        lines.push(`  ${marker}${escGift(d.text)}${d.feedback ? ' # ' + escGift(d.feedback) + ' [→ Node ' + d.next + ']' : ''}`);
      });
      lines.push('}');
      lines.push('');
    });
    return lines.join('\n');
  }

  return '// No exportable content for this activity type.';
}

function downloadMoodle() {
  if (!state.generatedData) return;
  const gift = buildGIFT(state.generatedData);
  const blob = new Blob([gift], { type: 'text/plain;charset=utf-8' });
  triggerDownload(blob, `${safeFilename(state.generatedData.resource)}-moodle.gift.txt`);
}

function downloadHTML() {
  if (!state.generatedData) return;
  if (state.generatedData.activityType !== 'quiz') {
    alert('Standalone HTML export is only available for Quiz activities. Use H5P JSON or Moodle GIFT for other types.');
    return;
  }
  const { questions, questionBank, resource, difficulty } = state.generatedData;
  const diffLabel = { introductory: 'Introductory', intermediate: 'Intermediate', advanced: 'Advanced' }[difficulty];

  const answersHtml = questions.map((q, qi) => `
    <div class="question" id="q${qi}" ${qi > 0 ? 'style="display:none"' : ''}>
      <div class="q-num">Question ${qi + 1} of ${questions.length}</div>
      <progress value="${qi}" max="${questions.length}" class="q-progress"></progress>
      <p class="q-text">${escHtml(q.text)}</p>
      <form class="answers" onsubmit="return false">
        ${q.answers.map((a, ai) => `
          <label class="answer">
            <input type="radio" name="q${qi}" value="${ai}" onchange="enableCheck(${qi})">
            <span>${escHtml(a.text)}</span>
          </label>`).join('')}
      </form>
      <div class="feedback" id="fb${qi}" style="display:none"></div>
      <div class="q-actions">
        <button class="btn-check" id="chk${qi}" onclick="checkQ(${qi})" disabled>Check Answer</button>
        <button class="btn-next" id="nxt${qi}" onclick="nextQ(${qi},${questions.length})" style="display:none">${qi + 1 < questions.length ? 'Next Question' : 'See Results'}</button>
      </div>
    </div>`).join('');

  const answerData = JSON.stringify(questions.map(q => q.answers.map(a => ({ correct: a.correct, feedback: a.feedback }))));

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${escHtml(questionBank.title)} — ${diffLabel} Quiz</title>
<style>
  :root{--navy:#003865;--gold:#F5A623;--gold-d:#d4891a;--success:#276749;--error:#9b2335;}
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:system-ui,sans-serif;background:#f5f3ef;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:40px 16px;}
  .card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,56,101,.12);max-width:640px;width:100%;overflow:hidden;}
  .card-header{background:var(--navy);padding:28px 28px 24px;color:#fff;}
  .tag{display:inline-block;background:rgba(245,166,35,.2);color:var(--gold);font-size:.7rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;padding:3px 10px;border-radius:20px;margin-bottom:12px;}
  h1{font-size:1.4rem;font-weight:700;line-height:1.25;margin-bottom:6px;}
  .meta{font-size:.8rem;color:rgba(255,255,255,.6);}
  .intro-body{padding:28px;text-align:center;}
  .intro-body p{color:#4a5568;font-size:.95rem;margin-bottom:20px;}
  .btn-start{background:var(--navy);color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:.9rem;font-weight:600;cursor:pointer;}
  .btn-start:hover{background:#00498a;}
  .question{padding:24px;}
  .q-num{font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#718096;margin-bottom:8px;}
  .q-progress{width:100%;height:4px;border:none;border-radius:2px;margin-bottom:20px;accent-color:var(--navy);}
  .q-text{font-size:1rem;font-weight:500;color:#1a1a2e;line-height:1.55;margin-bottom:18px;}
  .answers{display:flex;flex-direction:column;gap:8px;list-style:none;}
  .answer{display:flex;align-items:flex-start;gap:12px;padding:12px 15px;border:1.5px solid #e2d9c8;border-radius:8px;cursor:pointer;transition:border-color .15s;}
  .answer:hover{border-color:var(--navy);}
  .answer input{margin-top:2px;accent-color:var(--navy);}
  .answer span{font-size:.9rem;color:#2d3748;line-height:1.45;}
  .answer.correct{border-color:var(--success);background:#f0faf5;}
  .answer.incorrect{border-color:var(--error);background:#fff5f6;}
  .feedback{margin:14px 0 0;padding:12px 15px;border-radius:8px;font-size:.85rem;line-height:1.5;}
  .feedback.correct{background:#f0faf5;border:1px solid rgba(39,103,73,.2);color:var(--success);}
  .feedback.incorrect{background:#fff5f6;border:1px solid rgba(155,35,53,.2);color:var(--error);}
  .q-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:18px;padding-top:16px;border-top:1px solid #f0ebe2;}
  .btn-check{background:var(--gold);color:#002244;border:none;padding:10px 22px;border-radius:7px;font-size:.88rem;font-weight:600;cursor:pointer;}
  .btn-check:disabled{opacity:.4;cursor:not-allowed;}
  .btn-check:not(:disabled):hover{background:var(--gold-d);}
  .btn-next{background:var(--navy);color:#fff;border:none;padding:10px 22px;border-radius:7px;font-size:.88rem;font-weight:600;cursor:pointer;}
  .btn-next:hover{background:#00498a;}
  .score-screen{padding:40px 28px;text-align:center;}
  .score-num{font-size:3rem;font-weight:700;color:var(--navy);}
  .score-sub{font-size:1rem;color:#4a5568;margin:8px 0 24px;}
  .score-stats{display:flex;justify-content:center;gap:32px;margin-bottom:24px;}
  .stat-n{font-size:1.8rem;font-weight:700;color:var(--navy);}
  .stat-l{font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#718096;}
  .btn-retry{background:transparent;border:1.5px solid var(--navy);color:var(--navy);padding:10px 24px;border-radius:8px;font-size:.88rem;font-weight:600;cursor:pointer;}
  .btn-retry:hover{background:rgba(0,56,101,.06);}
  .oer-credit{padding:14px 20px;background:#faf8f4;border-top:1px solid #f0ebe2;font-size:.72rem;color:#718096;text-align:center;}
  .oer-credit a{color:var(--navy);text-decoration:none;}
</style>
</head>
<body>
<div class="card">
  <div class="card-header">
    <div class="tag">${escHtml(resource.discipline)}</div>
    <h1>${escHtml(questionBank.title)}</h1>
    <p class="meta">${questions.length} questions · ${diffLabel} · TRU Open Press</p>
  </div>
  <div id="intro-screen" class="intro-body">
    <p>Test your understanding of <strong>${escHtml(questionBank.title)}</strong>. Answer each question, check your answer, and receive instant feedback.</p>
    <button class="btn-start" onclick="startQuiz()">Begin Quiz</button>
  </div>
  ${answersHtml}
  <div id="score-screen" class="score-screen" style="display:none"></div>
  <div class="oer-credit">Open Educational Resource · <a href="https://openpress.trubox.ca" target="_blank" rel="noopener">TRU Open Press</a> · Created with OER Activity Builder</div>
</div>
<script>
var ANSWERS = ${answerData};
var score = 0;
function startQuiz(){
  document.getElementById('intro-screen').style.display='none';
  document.getElementById('q0').style.display='block';
}
function enableCheck(qi){
  document.getElementById('chk'+qi).disabled=false;
}
function checkQ(qi){
  var radios=document.querySelectorAll('input[name="q'+qi+'"]');
  var sel=-1;
  radios.forEach(function(r,i){if(r.checked)sel=i;});
  if(sel<0)return;
  var correct=ANSWERS[qi][sel].correct;
  if(correct)score++;
  document.querySelectorAll('input[name="q'+qi+'"]').forEach(function(r){r.disabled=true;});
  document.querySelectorAll('#q'+qi+' .answer').forEach(function(lbl,i){
    if(ANSWERS[qi][i].correct)lbl.classList.add('correct');
    else if(i===sel&&!ANSWERS[qi][i].correct)lbl.classList.add('incorrect');
  });
  var fb=document.getElementById('fb'+qi);
  fb.style.display='block';
  fb.className='feedback '+(correct?'correct':'incorrect');
  fb.innerHTML='<strong>'+(correct?'✓ Correct!':'✗ Not quite.')+'</strong> '+escHtml2(ANSWERS[qi][sel].feedback);
  document.getElementById('chk'+qi).style.display='none';
  document.getElementById('nxt'+qi).style.display='inline-block';
}
function nextQ(qi,total){
  document.getElementById('q'+qi).style.display='none';
  if(qi+1<total){
    document.getElementById('q'+(qi+1)).style.display='block';
  } else {
    showScore(total);
  }
}
function showScore(total){
  var pct=Math.round(score/total*100);
  var msg=pct>=80?'Excellent work!':pct>=60?'Good effort!':'Keep practising!';
  var sub=pct>=80?'You have a strong grasp of this material.':pct>=60?'Review the questions you missed.':'Revisit the resource and try again.';
  var ss=document.getElementById('score-screen');
  ss.style.display='block';
  ss.innerHTML='<div class="score-num">'+pct+'%</div><p class="score-sub">'+msg+' '+sub+'</p><div class="score-stats"><div><div class="stat-n">'+score+'</div><div class="stat-l">Correct</div></div><div><div class="stat-n">'+(total-score)+'</div><div class="stat-l">Incorrect</div></div><div><div class="stat-n">'+total+'</div><div class="stat-l">Total</div></div></div><button class="btn-retry" onclick="retryQuiz()">Try Again</button>';
}
function retryQuiz(){
  score=0;
  document.getElementById('score-screen').style.display='none';
  document.querySelectorAll('.question').forEach(function(q,i){
    q.style.display=i===0?'block':'none';
    q.querySelectorAll('input').forEach(function(r){r.checked=false;r.disabled=false;});
    q.querySelectorAll('.answer').forEach(function(l){l.classList.remove('correct','incorrect');});
    q.querySelectorAll('.feedback').forEach(function(f){f.style.display='none';});
    var qi=parseInt(q.id.replace('q',''));
    document.getElementById('chk'+qi).style.display='inline-block';
    document.getElementById('chk'+qi).disabled=true;
    document.getElementById('nxt'+qi).style.display='none';
  });
}
function escHtml2(s){var d=document.createElement('div');d.appendChild(document.createTextNode(s));return d.innerHTML;}
<\/script>
</body>
</html>`;

  const blob = new Blob([html], { type: 'text/html' });
  triggerDownload(blob, `${safeFilename(resource)}-quiz-standalone.html`);
}

function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// ─────────────────────────────────────────────
//  UTILITIES
// ─────────────────────────────────────────────

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// Returns a safe filename slug from a resource object (works for both static and live)
function safeFilename(resource) {
  const name = resource.name || resource.title || 'resource';
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').slice(0, 40);
}

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
}

// ─────────────────────────────────────────────
//  INIT
// ─────────────────────────────────────────────

function loadCompanionSeed() {
  let raw;
  try { raw = localStorage.getItem('companion-activity-seed'); } catch(e) { return; }
  if (!raw) return;

  let payload;
  try { payload = JSON.parse(raw); } catch(e) { return; }
  if (!payload || payload.v !== 1) return;

  // Clear the key immediately so it doesn't re-load on refresh
  try { localStorage.removeItem('companion-activity-seed'); } catch(e) {}

  // Populate the content field
  const field = document.getElementById('oer-content-field');
  if (field && payload.chapterText) {
    field.value = payload.chapterText;
  }

  // Switch to 'ai' content source (paste/text mode)
  setContentSource('ai');

  // Enable generate button check
  const generateBtn = document.getElementById('generate-btn');
  if (generateBtn && payload.chapterText && payload.chapterText.trim()) {
    generateBtn.disabled = false;
  }

  // Build annotation summary for the banner
  const annCount = (payload.annotations || []).length;
  const titleText = payload.chapterTitle || 'Reading session';
  const bookText  = payload.bookTitle ? ` · ${payload.bookTitle}` : '';
  const annLabel  = annCount === 1 ? '1 annotation' : `${annCount} annotations`;

  // Build human-readable annotation summary to append to textarea
  if (annCount > 0 && field) {
    const getModeLabel = m => ({ illuminate:'Illuminate', council:'Council', connect:'Connect', note:'Note' }[m] || m);
    const annotationBlock = payload.annotations.map((ann, i) =>
      `\n\n--- Companion annotation ${i + 1} [${getModeLabel(ann.mode)}] ---\nPassage: "${ann.excerpt}"\n${ann.response}`
    ).join('');
    field.value = (payload.chapterText || '') + '\n\n' +
      '═══ COMPANION ANNOTATIONS ═══' + annotationBlock;
  }

  // Safe text node helper (no innerHTML injection risk)
  function safeText(str) {
    const d = document.createElement('span'); d.textContent = str; return d.innerHTML;
  }

  // Inject the banner above the textarea
  const fieldLabel = document.querySelector('label[for="oer-content-field"]');
  if (fieldLabel) {
    const banner = document.createElement('div');
    banner.className = 'companion-seed-banner';
    banner.id = 'companion-seed-banner';
    banner.innerHTML = `
      <span class="companion-seed-banner-icon">✦</span>
      <div class="companion-seed-banner-body">
        <div class="companion-seed-banner-title">
          ${safeText(titleText)}${bookText ? `<span style="font-weight:400;color:var(--ink-faint)">${safeText(bookText)}</span>` : ''}
          <span class="companion-seed-banner-tag">From Companion</span>
        </div>
        <div class="companion-seed-banner-meta">Chapter text + ${safeText(annLabel)} loaded — ready to generate activities.</div>
      </div>
      <button class="companion-seed-banner-dismiss" id="companion-seed-dismiss" aria-label="Dismiss Companion banner">✕ Dismiss</button>
    `;
    fieldLabel.parentNode.insertBefore(banner, fieldLabel);
    document.getElementById('companion-seed-dismiss').addEventListener('click', () => {
      banner.remove();
    });
  }
}

function init() {
  // ── Load Companion seed if present ──
  loadCompanionSeed();

  // ── Sidebar mode toggle ──
  document.getElementById('mode-live').addEventListener('click', () => {
    state.sidebarMode = 'live';
    document.getElementById('mode-live').classList.add('active');
    document.getElementById('mode-live').setAttribute('aria-pressed', 'true');
    document.getElementById('mode-static').classList.remove('active');
    document.getElementById('mode-static').setAttribute('aria-pressed', 'false');
    document.getElementById('chapter-select-wrap').classList.add('hidden');
    document.getElementById('sidebar-filter-bar').style.display = '';
    if (!state.liveBooksLoaded) {
      loadLiveBooks();
    } else {
      renderLiveSidebar(document.getElementById('resource-search').value);
    }
  });

  document.getElementById('mode-static').addEventListener('click', () => {
    state.sidebarMode = 'static';
    document.getElementById('mode-static').classList.add('active');
    document.getElementById('mode-static').setAttribute('aria-pressed', 'true');
    document.getElementById('mode-live').classList.remove('active');
    document.getElementById('mode-live').setAttribute('aria-pressed', 'false');
    document.getElementById('chapter-select-wrap').classList.add('hidden');
    document.getElementById('sidebar-filter-bar').style.display = 'none';
    renderSidebar(document.getElementById('resource-search').value);
  });

  // ── Search ──
  document.getElementById('resource-search').addEventListener('input', e => {
    if (state.sidebarMode === 'live') {
      if (state.liveBooksLoaded) renderLiveSidebar(e.target.value);
    } else {
      renderSidebar(e.target.value);
    }
  });

  // ── Show-all books toggle ──
  document.getElementById('show-all-books').addEventListener('change', () => {
    if (state.sidebarMode === 'live') {
      state.liveBooksLoaded = false;
      loadLiveBooks();
    }
  });

  // ── Chapter selector events ──
  document.getElementById('part-select').addEventListener('change', onPartSelected);
  document.getElementById('chapter-select').addEventListener('change', onChapterSelected);
  document.getElementById('load-chapter-btn').addEventListener('click', loadChapterContent);

  // ── URL fetch and file upload (Activity Builder) ──
  document.getElementById('btn-fetch-url-ab').addEventListener('click', fetchUrlAB);
  document.getElementById('url-fetch-input-ab').addEventListener('keydown', e => {
    if (e.key === 'Enter') fetchUrlAB();
  });
  document.getElementById('btn-file-upload-ab').addEventListener('click', () => {
    document.getElementById('file-upload-input-ab').click();
  });
  document.getElementById('file-upload-input-ab').addEventListener('change', e => {
    const file = e.target.files?.[0];
    if (file) { handleFileUploadAB(file); e.target.value = ''; }
  });

  // ── Content source chips ──
  document.querySelectorAll('.source-chip').forEach(chip => {
    chip.addEventListener('click', () => setContentSource(chip.dataset.source));
  });

  // ── Activity type cards ──
  // (ACTIVITY_TYPE_LABELS is defined at module scope above resetGenerateBtn)
  const AI_REQUIRED_TYPES = new Set(['truefalse','flashcards','fillblanks','matching','shortanswer','ordering','scenario','branchscenario']);

  function updateGenerateBtnLabel() {
    const lbl = document.getElementById('generate-btn-label');
    if (lbl) lbl.textContent = ACTIVITY_TYPE_LABELS[state.activityType] || 'Generate Activity';
    const hint = document.getElementById('generate-hint');
    if (hint) {
      const hasContent = state.loadedChapterText || state.sources.length > 0;
      const needsAI = AI_REQUIRED_TYPES.has(state.activityType) && state.contentSource === 'demo' && !hasContent;
      hint.style.display = needsAI ? '' : 'none';
    }
  }

  document.querySelectorAll('.type-card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('.type-card').forEach(c => {
        c.classList.remove('selected');
        c.setAttribute('aria-checked', 'false');
        c.setAttribute('tabindex', '-1');
      });
      card.classList.add('selected');
      card.setAttribute('aria-checked', 'true');
      card.setAttribute('tabindex', '0');
      state.activityType = card.dataset.type;
      // AI-required types: auto-switch content source if demo is active
      if (AI_REQUIRED_TYPES.has(state.activityType) && state.contentSource === 'demo') {
        setContentSource('ai');
      }
      // Show/hide the questions count depending on type
      const qSection = document.getElementById('questions-count-section');
      if (qSection) {
        // fillblanks and ordering use fixed counts, hide the selector
        qSection.style.display = (state.activityType === 'fillblanks' || state.activityType === 'ordering') ? 'none' : '';
      }
      updateGenerateBtnLabel();
    });
  });

  // ── Segmented controls ──
  document.querySelectorAll('.config-body .segmented').forEach(seg => {
    const key = seg.getAttribute('aria-labelledby') === 'questions-label' ? 'numQuestions' : 'difficulty';
    seg.querySelectorAll('.seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        seg.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state[key] = key === 'numQuestions' ? parseInt(btn.dataset.val) : btn.dataset.val;
      });
    });
  });

  // ── Test connection button ──
  document.getElementById('test-connection-btn').addEventListener('click', testConnection);

  // ── Generate button ──
  document.getElementById('generate-btn').addEventListener('click', generateActivity);

  // ── Tabs ──
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab));
  });

  // ── Download buttons ──
  document.getElementById('dl-json-btn').addEventListener('click', downloadJSON);
  document.getElementById('dl-html-btn').addEventListener('click', downloadHTML);
  document.getElementById('dl-moodle-btn').addEventListener('click', downloadMoodle);

  // ── Start in live mode — load books immediately ──
  loadLiveBooks();

  // ── Mobile three-panel toolbar ───────────────────────────────
  (function initMobileToolbar() {
    const MQ = window.matchMedia('(max-width: 768px)');
    // Insert toolbar and backdrop into body
    const toolbar = document.createElement('div');
    toolbar.className = 'mobile-toolbar';
    toolbar.id = 'ab-mobile-toolbar';
    toolbar.style.display = 'none';
    toolbar.setAttribute('role', 'toolbar');
    toolbar.innerHTML = `
      <button class="mobile-toolbar-btn" id="tb-library" aria-label="Open library">
        <span class="tb-icon">📚</span>Library
      </button>
      <button class="mobile-toolbar-btn active" id="tb-output" aria-label="View output">
        <span class="tb-icon">✦</span>Output
      </button>
      <button class="mobile-toolbar-btn" id="tb-config" aria-label="Configure activity">
        <span class="tb-icon">⚙</span>Configure
      </button>`;
    document.body.appendChild(toolbar);

    const backdrop = document.createElement('div');
    backdrop.className = 'mobile-backdrop';
    backdrop.id = 'ab-backdrop';
    document.body.appendChild(backdrop);

    const sidebar = document.querySelector('.sidebar');
    const configPanel = document.querySelector('.config-panel');
    const tbLib = document.getElementById('tb-library');
    const tbOut = document.getElementById('tb-output');
    const tbCfg = document.getElementById('tb-config');

    function closeAll() {
      sidebar.classList.remove('mobile-open');
      configPanel.classList.remove('mobile-open');
      backdrop.classList.remove('visible');
      [tbLib, tbOut, tbCfg].forEach(b => b.classList.remove('active'));
      tbOut.classList.add('active');
    }
    function openLibrary() {
      closeAll();
      sidebar.classList.add('mobile-open');
      backdrop.classList.add('visible');
      tbLib.classList.add('active');
      tbOut.classList.remove('active');
    }
    function openConfig() {
      closeAll();
      configPanel.classList.add('mobile-open');
      backdrop.classList.add('visible');
      tbCfg.classList.add('active');
      tbOut.classList.remove('active');
    }

    tbLib.addEventListener('click', () => sidebar.classList.contains('mobile-open') ? closeAll() : openLibrary());
    tbOut.addEventListener('click', closeAll);
    tbCfg.addEventListener('click', () => configPanel.classList.contains('mobile-open') ? closeAll() : openConfig());
    backdrop.addEventListener('click', closeAll);

    function applyMobile(m) {
      toolbar.style.display = m ? 'flex' : 'none';
      if (!m) closeAll();
    }
    MQ.addEventListener('change', e => applyMobile(e.matches));
    applyMobile(MQ.matches);
  })();
}

document.addEventListener('DOMContentLoaded', init);

// ── Suite-wide theme toggle ──────────────────────────────
(function() {
  var btn = document.getElementById('btn-suite-theme');
  if (!btn) return;
  function applyOmTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    btn.textContent = theme === 'dark' ? '☀' : '🌙';
    btn.title = theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme';
    try { localStorage.setItem('om-theme', theme); } catch(e) {}
  }
  btn.addEventListener('click', function() {
    var cur = document.documentElement.getAttribute('data-theme') || 'light';
    applyOmTheme(cur === 'dark' ? 'light' : 'dark');
  });
  var cur = document.documentElement.getAttribute('data-theme') || 'light';
  btn.textContent = cur === 'dark' ? '☀' : '🌙';
  btn.title = cur === 'dark' ? 'Switch to light theme' : 'Switch to dark theme';
})();
</script>
</body>
</html>
`;
